<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f17" />
  <title>HorrorLaden Line Coach (Auto‑Load)</title>
  <meta name="description" content="Duolingo-ähnlicher Trainer für 'Der kleine Horrorladen' – lädt automatisch horrorladen_script.json aus dem Repo. Mobile‑ready & share‑friendly." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b0f17; --panel:rgba(255,255,255,0.08); --panel-strong:rgba(255,255,255,0.14); --text:#eaf0ff; --muted:#a5b0c2; --brand:#7c9cff; --ok:#55e39f; --warn:#ffd166; --bad:#ff6b6b; --chip:rgba(255,255,255,0.12); --shadow:0 10px 30px rgba(0,0,0,0.35); --glass:blur(16px) saturate(120%); }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans';color:var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, #2a2c7a44, transparent), radial-gradient(900px 400px at 110% 0%, #7a2a7a44, transparent), radial-gradient(900px 500px at 50% 120%, #1b7a7a33, transparent), var(--bg);}
    header{position:sticky;top:0;z-index:30;backdrop-filter:var(--glass);background:linear-gradient(180deg, rgba(12,14,20,0.9), rgba(12,14,20,0));border-bottom:1px solid rgba(255,255,255,0.08)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 18px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{margin:0;font-size:1.2rem;letter-spacing:.3px}
    .badge{font-size:.8rem;color:#cbd7ff;background:var(--chip);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.12)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
    .tab{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.18);padding:8px 12px;border-radius:999px;cursor:pointer}
    .tab.active{background:var(--brand);color:#091120}

    main{max-width:1100px;margin:18px auto;padding:0 18px;display:grid;grid-template-columns:1.6fr 1fr;gap:18px}
    @media (max-width:900px){ main{grid-template-columns:1fr} }
    .card{background:var(--panel);border:1px solid rgba(255,255,255,0.12);border-radius:18px;box-shadow:var(--shadow);padding:16px;backdrop-filter:var(--glass)}
    .title{display:flex;align-items:center;justify-content:space-between}
    .title h2{margin:0;font-size:1.05rem}
    .controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px}
    @media (max-width:800px){ .controls{grid-template-columns:repeat(2,minmax(0,1fr));} button{padding:12px 16px} .line{font-size:1.2rem} .cue{padding:14px} }
    label{font-size:.8rem;color:var(--muted)}
    select,input[type="text"],textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.06);color:var(--text)}
    .toggle{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--chip);border:1px solid rgba(255,255,255,0.12);user-select:none}
    .chip input{accent-color:var(--brand)}
    .status-legend{display:flex;gap:10px;flex-wrap:wrap;font-size:.8rem;color:var(--muted)}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
    .dot.keep{background:var(--ok)} .dot.optional{background:var(--warn)} .dot.cut{background:#66ff66}

    .practice{display:flex;flex-direction:column;gap:12px}
    .cue{font-size:.95rem;color:#d4defa;background:var(--panel-strong);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12)}
    .cue .speaker{font-weight:700;text-transform:uppercase;font-size:.8rem;color:#9db1ff}
    .line{font-size:1.12rem;line-height:1.6}
    .muted{color:var(--muted)}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{border:none;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600;color:#0b0f17;background:var(--brand);box-shadow:0 6px 14px rgba(124,156,255,0.3)}
    button.secondary{background:#a9b8ff;color:#051428} button.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.18)}
    .progress{display:flex;align-items:center;justify-content:space-between;gap:10px;border-top:1px dashed rgba(255,255,255,0.1);padding-top:10px;margin-top:8px}
    .hearts{display:flex;gap:6px} .heart{width:18px;height:18px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.4))}
    .xp{font-weight:700;color:#b9c7ff} .pill{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.14);padding:6px 10px;border-radius:999px}

    .script-list{max-height:60vh;overflow:auto;display:flex;flex-direction:column;gap:10px}
    .script-item{padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.05)}
    .script-item .meta{display:flex;justify-content:space-between;gap:8px;color:var(--muted);font-size:.8rem}
    .status.keep{outline:2px solid var(--ok)} .status.optional{outline:2px solid var(--warn)} .status.cut{outline:2px solid #66ff66;opacity:.6}

    .sr-only{position:absolute;left:-9999px}
    .hint{font-size:.85rem;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1>HorrorLaden Line Coach</h1>
      <span class="badge">Auto‑Load JSON</span>
      <span class="badge">Mobile‑ready</span>
      <div class="tabs">
        <button class="tab active" data-tab="trainer">Trainer</button>
        <button class="tab" data-tab="songs">Songs</button>
        <button class="tab" data-tab="script">Skript</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Left: Trainer / Songs -->
    <section class="card" id="leftCard">
      <div class="title">
        <h2 id="leftTitle">Trainer</h2>
        <div class="hint">Die App lädt automatisch <code>horrorladen_script.json</code> aus deinem Repo. Optional: <code>?data=URL</code>.</div>
      </div>

      <!-- Trainer Controls -->
      <div id="trainerControls" class="controls" style="margin-bottom:6px">
        <div>
          <label for="roleSel">Meine Rolle</label>
          <select id="roleSel"></select>
        </div>
        <div>
          <label for="sceneSel">Szene</label>
          <select id="sceneSel"></select>
        </div>
        <div>
          <label for="modeSel">Modus</label>
          <select id="modeSel">
            <option value="read">Durchlauf (Reveal)</option>
            <option value="type">Tippen & Prüfen</option>
            <option value="speak">Sprechen (Beta)</option>
          </select>
        </div>
        <div>
          <label for="contextSel">Kontext-Zeilen</label>
          <select id="contextSel">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
          </select>
        </div>
      </div>

      <div id="trainerToggles" class="toggle" style="margin-bottom:8px">
        <label class="chip"><input type="checkbox" id="hideCuts" checked> Sichere Striche (grün) ausblenden</label>
        <label class="chip"><input type="checkbox" id="includeOptional" checked> Optionale Striche (gelb/orange) einbeziehen</label>
        <label class="chip"><input type="checkbox" id="quizPartner"> Partner-Text mitlernen</label>
        <label class="chip"><input type="checkbox" id="ttsOther" checked> Andere Rollen vorlesen (TTS)</label>
        <label class="chip"><input type="checkbox" id="autoAdvance"> Auto‑Weiter (TTS Ende)</label>
        <label class="chip"><input type="checkbox" id="excludeSongs" checked> Songs aus Trainer ausschließen</label>
      </div>

      <div class="status-legend" aria-hidden="true">
        <span><span class="dot keep"></span> behalten</span>
        <span><span class="dot optional"></span> optional</span>
        <span><span class="dot cut"></span> gestrichen</span>
      </div>

      <!-- Trainer Practice Area -->
      <div class="practice" id="practiceArea" aria-live="polite"></div>
      <div class="progress">
        <div class="hearts" id="hearts"></div>
        <div class="xp" id="xp">XP: 0</div>
        <div class="pill" id="streak">🔥 Streak 0</div>
      </div>

      <!-- Songs Panel -->
      <div id="songsPanel" class="hidden">
        <div class="controls" style="margin-top:4px">
          <div>
            <label for="songSel">Song</label>
            <select id="songSel"></select>
          </div>
          <div>
            <label for="songModeSel">Song‑Modus</label>
            <select id="songModeSel">
              <option value="reveal">Reveal (Zeilen aufdecken)</option>
              <option value="cloze">Cloze (Lücken füllen)</option>
              <option value="firstletters">Erste Buchstaben</option>
            </select>
          </div>
          <div>
            <label for="clozeEvery">Cloze: jedes n‑te Wort</label>
            <input id="clozeEvery" type="range" min="3" max="8" value="5" />
          </div>
          <div>
            <label for="songContextSel">Kontext-Zeilen</label>
            <select id="songContextSel">
              <option value="0">0</option>
              <option value="1" selected>1</option>
              <option value="2">2</option>
            </select>
          </div>
        </div>
        <div class="toggle" style="margin:8px 0">
          <label class="chip"><input type="checkbox" id="songTtsOther" checked> Andere Rollen vorlesen (TTS)</label>
          <label class="chip"><input type="checkbox" id="songQuizPartner"> Partner‑Text mitlernen</label>
        </div>
        <div class="practice" id="songPractice"></div>
        <div class="progress">
          <div class="pill" id="songProgress">0 / 0</div>
          <div class="pill" id="songXP">🎵 XP: 0</div>
        </div>
      </div>
    </section>

    <!-- Right Column: Script/Songs list -->
    <aside class="card" aria-labelledby="scriptTitle">
      <div class="title">
        <h2 id="scriptTitle">Skript & Inhalte</h2>
        <div class="hint">Klicke auf eine Zeile bzw. Songzeile, um im Trainer dorthin zu springen. Songs sind separat markiert.</div>
      </div>
      <div id="scriptList" class="script-list" role="list"></div>
    </aside>
  </main>

  <script>
    /* ----------------------------- Data Model ----------------------------- */
    const STORAGE_KEY = 'horrorcoach_state_auto_v1';
    const DEFAULT_DATA = {
      title: 'Der kleine Horrorladen',
      roles: [],
      scenes: [],
      songs: [],
      prefs: { tab:'trainer', role:'', sceneId:'', mode:'read', context:2, hidCuts:true, includeOptional:true, quizPartner:false, ttsOther:true, autoAdvance:false, excludeSongs:true,
               songId:'', songMode:'reveal', songContext:1, songTtsOther:true, songQuizPartner:false },
      meta: { xp:0, hearts:3, streak:0, songXP:0 }
    };

    let state = loadState();

    function loadState(){ try{ const raw=localStorage.getItem(STORAGE_KEY); const base=structuredClone(DEFAULT_DATA); if(!raw) return base; const parsed=JSON.parse(raw); return deepMerge(base, parsed);}catch(e){ return structuredClone(DEFAULT_DATA);} }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function deepMerge(base, patch){ for(const k in patch){ if(Array.isArray(patch[k])) base[k]=patch[k]; else if(patch[k] && typeof patch[k]==='object') base[k]=deepMerge(base[k]||{}, patch[k]); else base[k]=patch[k]; } return base; }

    /* ----------------------------- UI Elements ---------------------------- */
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const leftTitle = document.getElementById('leftTitle');
    const practiceArea = document.getElementById('practiceArea');
    const scriptList = document.getElementById('scriptList');

    const roleSel = document.getElementById('roleSel');
    const sceneSel = document.getElementById('sceneSel');
    const modeSel = document.getElementById('modeSel');
    const contextSel = document.getElementById('contextSel');
    const hideCuts = document.getElementById('hideCuts');
    const includeOptional = document.getElementById('includeOptional');
    const quizPartner = document.getElementById('quizPartner');
    const ttsOther = document.getElementById('ttsOther');
    const autoAdvance = document.getElementById('autoAdvance');
    const excludeSongs = document.getElementById('excludeSongs');

    const heartsBox = document.getElementById('hearts');
    const xpBox = document.getElementById('xp');
    const streakBox = document.getElementById('streak');

    const songsPanel = document.getElementById('songsPanel');
    const songSel = document.getElementById('songSel');
    const songModeSel = document.getElementById('songModeSel');
    const clozeEvery = document.getElementById('clozeEvery');
    const songContextSel = document.getElementById('songContextSel');
    const songPractice = document.getElementById('songPractice');
    const songProgress = document.getElementById('songProgress');
    const songXP = document.getElementById('songXP');

    /* --------------------------- Population / Init ------------------------ */
    function refreshSelectors(){
      roleSel.innerHTML = state.roles.map(r=>`<option ${r===state.prefs.role?'selected':''}>${r}</option>`).join('');
      const scenes = state.scenes.filter(s=> s.type!=='song');
      sceneSel.innerHTML = scenes.map(s=>`<option value="${s.id}" ${s.id===state.prefs.sceneId?'selected':''}>${s.name}</option>`).join('');
      if(!state.prefs.role && state.roles[0]) state.prefs.role = state.roles[0];
      if(!state.prefs.sceneId && scenes[0]) state.prefs.sceneId = scenes[0].id;
      modeSel.value = state.prefs.mode; contextSel.value = String(state.prefs.context||2);
      hideCuts.checked = !!state.prefs.hidCuts; includeOptional.checked = !!state.prefs.includeOptional; quizPartner.checked = !!state.prefs.quizPartner;
      ttsOther.checked = !!state.prefs.ttsOther; autoAdvance.checked = !!state.prefs.autoAdvance; excludeSongs.checked = !!state.prefs.excludeSongs;

      songSel.innerHTML = state.songs.map(s=>`<option value="${s.id}" ${s.id===state.prefs.songId?'selected':''}>${s.title}</option>`).join('');
      if(!state.prefs.songId && state.songs[0]) state.prefs.songId = state.songs[0].id;
      songModeSel.value = state.prefs.songMode; songContextSel.value = String(state.prefs.songContext||1); clozeEvery.value = 5;
    }

    function currentScene(){ return state.scenes.find(s=>s.id===state.prefs.sceneId) || state.scenes[0]; }
    function currentSong(){ return state.songs.find(s=>s.id===state.prefs.songId) || state.songs[0]; }

    function filteredLines(scene){ return scene?.lines?.filter(l=>{ if(state.prefs.hidCuts && l.status==='cut') return false; if(!state.prefs.includeOptional && l.status==='optional') return false; return true; }) || []; }

    function buildScriptList(){
      scriptList.innerHTML='';
      state.scenes.filter(s=> s.type!=='song').forEach(scene=>{
        const lines = filteredLines(scene);
        lines.forEach((l, idx)=>{
          const div = document.createElement('div');
          div.className = `script-item status ${l.status||'keep'}`;
          div.role='listitem';
          div.innerHTML = `<div class="meta"><span>${scene.name}</span><span>${(l.status==='cut'?'gestrichen':(l.status==='optional'?'optional':'bleibt'))}</span></div>
                           <div><b>${l.speaker}:</b> <span class="line">${escapeHtml(l.text)}</span></div>`;
          div.addEventListener('click', ()=>{ selectTab('trainer'); startPracticeAtScene(scene.id, idx); });
          scriptList.appendChild(div);
        });
      });
      const h = document.createElement('div'); h.className='muted'; h.style.margin='8px 0'; h.innerHTML='— <b>Songs</b> —'; scriptList.appendChild(h);
      state.songs.forEach(song=>{
        song.lines.forEach((l, idx)=>{
          const div = document.createElement('div');
          div.className = `script-item status ${l.status||'keep'}`;
          div.role='listitem';
          div.innerHTML = `<div class="meta"><span>🎵 ${song.title}</span><span>Song</span></div>
                           <div><b>${l.speaker||'ENSEMBLE'}:</b> <span class="line">${escapeHtml(l.text)}</span></div>`;
          div.addEventListener('click', ()=>{ selectTab('songs'); startSongAt(song.id, idx); });
          scriptList.appendChild(div);
        });
      });
    }

    function refreshProgress(){
      heartsBox.innerHTML = '';
      for(let i=0;i<3;i++){
        const svg = `<svg class="heart" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="${i<state.meta.hearts?'#ff6b6b':'#3a3f55'}" d="M12 21s-6.716-4.727-9.428-7.44C.86 11.85.86 8.65 2.572 6.94c1.714-1.714 4.486-1.714 6.2 0L12 10.17l3.228-3.23c1.714-1.714 4.486-1.714 6.2 0 1.714 1.71 1.714 4.91 0 6.62C18.716 16.273 12 21 12 21z"/></svg>`;
        heartsBox.insertAdjacentHTML('beforeend', svg);
      }
      xpBox.textContent = `XP: ${state.meta.xp}`;
      streakBox.textContent = `🔥 Streak ${state.meta.streak}`;
      songXP.textContent = `🎵 XP: ${state.meta.songXP}`;
    }

    /* ---------------------- Trainer (Dialogues) Engine --------------------- */
    let practiceIdx = 0; let lastSpokenUtterance = null;
    function startPractice(){ startPracticeAtScene(state.prefs.sceneId, 0); }
    function startPracticeAtScene(sceneId, idx){ state.prefs.sceneId = sceneId; saveState(); const scene=currentScene(); const lines=filteredLines(scene); practiceIdx=Math.max(0, Math.min(idx, (lines.length||1)-1)); renderPractice(); }

    function renderPractice(){
      if(state.prefs.tab!=='trainer'){ return; }
      const scene = currentScene(); if(!scene){ practiceArea.innerHTML='<div class="muted">Keine Szene gewählt.</div>'; return; }
      const lines = filteredLines(scene); if(!lines.length){ practiceArea.innerHTML='<div class="muted">Keine Zeilen nach Filter.</div>'; return; }
      const ctxN = Math.max(0, Number(state.prefs.context||2));
      const l = lines[practiceIdx]; const askPartnerToo = !!state.prefs.quizPartner; const isMyLine = l.speaker === state.prefs.role; let askFor = (isMyLine? 'me' : (askPartnerToo ? 'partner' : 'skip'));
      if(askFor==='skip'){ const nextIdx = findNextAskable(lines, practiceIdx, state.prefs.role, askPartnerToo); if(nextIdx===-1){ practiceArea.innerHTML='<div class="muted">Fertig für diese Szene! 🎉</div>'; return; } practiceIdx = nextIdx; return renderPractice(); }

      const context = []; for(let i=Math.max(0, practiceIdx-ctxN); i<practiceIdx; i++){ const c = lines[i]; context.push(`<div class="cue"><div class="speaker">${c.speaker}</div><div>${escapeHtml(c.text)}</div></div>`); }
      const header = `<div class="row" style="justify-content:space-between"><div class="pill">${scene.name}</div><div class="pill">Schritt ${practiceIdx+1} / ${lines.length}</div></div>`;
      const prompt = `<div class="cue" style="border:1px dashed rgba(255,255,255,0.18)"><div class="speaker">${l.speaker}${isMyLine?' (Du)':''}</div><div class="muted">${isMyLine?'Deine Zeile':'Partner-Zeile'}</div></div>`;

      const mode = state.prefs.mode; let interaction='';
      if(mode==='read'){
        interaction = `<div class="btns"><button id="revealBtn" class="secondary">Zeile anzeigen</button><button id="playOtherBtn" class="ghost">Kontext vorlesen</button><button id="nextBtn">Weiter</button></div>
                       <div id="revealBox" class="hidden" style="margin-top:8px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06)"><div class="line">${escapeHtml(l.text)}</div></div>`;
      } else if(mode==='type'){
        interaction = `<div class="answerBox"><input id="answerInput" type="text" autocomplete="off" placeholder="Tippe die Zeile exakt (Groß/Klein egal)" /><button id="checkBtn">Prüfen</button></div>
                       <div id="feedback" style="min-height:28px" class="muted"></div>
                       <div class="btns"><button id="hintBtn" class="ghost">Hinweis</button><button id="skipBtn" class="ghost">Überspringen</button><button id="playOtherBtn" class="ghost">Kontext vorlesen</button><button id="nextBtn" class="secondary">Weiter</button></div>`;
      } else {
        interaction = `<div class="btns"><button id="startRecBtn" class="secondary">Sprechen starten</button><button id="stopRecBtn" class="ghost">Stopp</button><button id="playOtherBtn" class="ghost">Kontext vorlesen</button><button id="nextBtn">Weiter</button></div><div id="recOut" class="muted"></div>`;
      }

      practiceArea.innerHTML = header + context.join('') + prompt + interaction;
      document.getElementById('playOtherBtn')?.addEventListener('click', ()=> speakContext(contextText(lines, practiceIdx, ctxN)) );
      document.getElementById('nextBtn')?.addEventListener('click', nextItem);
      document.getElementById('revealBtn')?.addEventListener('click', ()=>{ document.getElementById('revealBox')?.classList.remove('hidden'); });
      if(mode==='type'){
        const input = document.getElementById('answerInput'); const feedback = document.getElementById('feedback'); input?.focus();
        document.getElementById('checkBtn')?.addEventListener('click', ()=>{ const ok = similarEnough(input.value, l.text); if(ok){ feedback.innerHTML='✅ Richtig!'; gainXP(10); advanceOrEnd(); } else { miss(feedback, input.value, l.text); } });
        document.getElementById('hintBtn')?.addEventListener('click', ()=>{ feedback.textContent = 'Hinweis: ' + firstNCharsHint(l.text, input.value); });
        document.getElementById('skipBtn')?.addEventListener('click', nextItem);
      }
      if(mode==='speak') setupSpeech(l.text);
      refreshProgress();
    }

    function nextItem(){ const scene=currentScene(); const lines=filteredLines(scene); practiceIdx=Math.min(practiceIdx+1, (lines.length||1)-1); renderPractice(); }
    function advanceOrEnd(){ const scene=currentScene(); const lines=filteredLines(scene); if(practiceIdx>=lines.length-1){ state.meta.streak++; saveState(); refreshProgress(); practiceArea.innerHTML='<div>🎉 Szene abgeschlossen! Super Leistung.</div>'; } else { practiceIdx++; renderPractice(); } }
    function findNextAskable(lines, idx, role, askPartner){ for(let i=idx+1;i<lines.length;i++){ const isMine = lines[i].speaker===role; if(isMine||askPartner) return i; } return -1; }

    /* ---------------------------- Songs Engine ---------------------------- */
    let songIdx = 0;
    function startSong(){ startSongAt(state.prefs.songId, 0); }
    function startSongAt(songId, idx){ state.prefs.songId = songId; saveState(); const song=currentSong(); songIdx=Math.max(0, Math.min(idx, (song?.lines?.length||1)-1)); renderSong(); }
    function renderSong(){
      if(state.prefs.tab!=='songs'){ return; }
      const song = currentSong(); if(!song){ songPractice.innerHTML='<div class="muted">Kein Song ausgewählt.</div>'; return; }
      const lines = song.lines; if(!lines?.length){ songPractice.innerHTML='<div class="muted">Keine Songzeilen vorhanden.</div>'; return; }
      const ctxN = Math.max(0, Number(state.prefs.songContext||1));
      const l = lines[songIdx]; const isMyLine = l.speaker===state.prefs.role; const askPartnerToo = !!state.prefs.songQuizPartner;
      const context = []; for(let i=Math.max(0, songIdx-ctxN); i<songIdx; i++){ const c = lines[i]; context.push(`<div class=\"cue\"><div class=\"speaker\">${c.speaker||'ENSEMBLE'}</div><div>${escapeHtml(c.text)}</div></div>`); }
      const header = `<div class="row" style="justify-content:space-between"><div class="pill">🎵 ${song.title}</div><div class="pill">Zeile ${songIdx+1} / ${lines.length}</div></div>`;
      let body=''; const mode = state.prefs.songMode;
      if(mode==='reveal'){
        body = `<div class=\"btns\"><button id=\"songRevealBtn\" class=\"secondary\">Zeile anzeigen</button><button id=\"songPlayCtxBtn\" class=\"ghost\">Kontext vorlesen</button><button id=\"songNextBtn\">Weiter</button></div>
                <div id=\"songRevealBox\" class=\"hidden\" style=\"margin-top:8px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06)\"><div class=\"line\">${escapeHtml(l.text)}</div></div>`;
      } else if(mode==='cloze'){
        const every = Number(document.getElementById('clozeEvery').value||5);
        const {masked} = clozeMask(l.text, every);
        body = `<div class=\"cue\"><div class=\"speaker\">${l.speaker||'ENSEMBLE'}${isMyLine?' (Du)':''}</div><div class=\"line\">${masked}</div></div>
                <div class=\"answerBox\"><input id=\"songAnswer\" type=\"text\" autocomplete=\"off\" placeholder=\"Fehlende Wörter in richtiger Reihenfolge\" /><button id=\"songCheck\">Prüfen</button></div>
                <div id=\"songFb\" class=\"muted\"></div>
                <div class=\"btns\"><button id=\"songHint\" class=\"ghost\">Hinweis</button><button id=\"songNextBtn\" class=\"secondary\">Weiter</button></div>`;
      } else { // firstletters
        const firsts = firstLetters(l.text);
        body = `<div class=\"cue\"><div class=\"speaker\">${l.speaker||'ENSEMBLE'}${isMyLine?' (Du)':''}</div><div class=\"line\">${firsts}</div></div>
                <div class=\"btns\"><button id=\"songRevealBtn\" class=\"secondary\">Ganzen Text anzeigen</button><button id=\"songPlayCtxBtn\" class=\"ghost\">Kontext vorlesen</button><button id=\"songNextBtn\">Weiter</button></div>
                <div id=\"songRevealBox\" class=\"hidden\" style=\"margin-top:8px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06)\"><div class=\"line\">${escapeHtml(l.text)}</div></div>`;
      }
      songPractice.innerHTML = header + context.join('') + body;
      songProgress.textContent = `${songIdx+1} / ${lines.length}`;
      document.getElementById('songNextBtn')?.addEventListener('click', ()=>{ if(songIdx>=lines.length-1){ songPractice.innerHTML='<div>🎉 Song durch!'</div>; } else { songIdx++; renderSong(); } });
      document.getElementById('songRevealBtn')?.addEventListener('click', ()=>{ document.getElementById('songRevealBox')?.classList.remove('hidden'); });
      document.getElementById('songPlayCtxBtn')?.addEventListener('click', ()=>{ if(state.prefs.songTtsOther) speakContext(contextText(lines, songIdx, ctxN)); });
      if(mode==='cloze'){
        const input = document.getElementById('songAnswer'); const fb = document.getElementById('songFb');
        document.getElementById('songCheck')?.addEventListener('click', ()=>{ const ok = containsWordsInOrder(input.value, l.text, Number(clozeEvery.value||5)); if(ok){ fb.textContent='✅ Stark!'; state.meta.songXP += 8; saveState(); renderSong(); } else { fb.textContent='❌ Fast – prüfe Reihenfolge/Endungen'; } });
        document.getElementById('songHint')?.addEventListener('click', ()=>{ fb.textContent='Hinweis: ' + firstNCharsHint(l.text, input.value); });
      }
      refreshProgress();
    }

    /* --------------------------- Tabs & Selectors ------------------------- */
    function selectTab(name){ state.prefs.tab=name; tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name)); leftTitle.textContent = (name==='trainer'?'Trainer':'Songs'); document.getElementById('trainerControls').style.display = (name==='trainer')?'grid':'none'; document.getElementById('trainerToggles').style.display=(name==='trainer')?'flex':'none'; practiceArea.style.display=(name==='trainer')?'block':'none'; songsPanel.classList.toggle('hidden', name!=='songs'); saveState(); if(name==='trainer') renderPractice(); if(name==='songs') renderSong(); }
    tabs.forEach(t=> t.addEventListener('click', ()=> selectTab(t.dataset.tab) ));

    roleSel.addEventListener('change', ()=>{ state.prefs.role=roleSel.value; saveState(); renderPractice(); renderSong(); });
    sceneSel.addEventListener('change', ()=>{ state.prefs.sceneId=sceneSel.value; saveState(); buildScriptList(); startPractice(); });
    modeSel.addEventListener('change', ()=>{ state.prefs.mode=modeSel.value; saveState(); renderPractice(); });
    contextSel.addEventListener('change', ()=>{ state.prefs.context=Number(contextSel.value); saveState(); renderPractice(); });
    hideCuts.addEventListener('change', ()=>{ state.prefs.hidCuts=hideCuts.checked; saveState(); buildScriptList(); renderPractice(); });
    includeOptional.addEventListener('change', ()=>{ state.prefs.includeOptional=includeOptional.checked; saveState(); buildScriptList(); renderPractice(); });
    quizPartner.addEventListener('change', ()=>{ state.prefs.quizPartner=quizPartner.checked; saveState(); renderPractice(); });
    ttsOther.addEventListener('change', ()=>{ state.prefs.ttsOther=ttsOther.checked; saveState(); });
    autoAdvance.addEventListener('change', ()=>{ state.prefs.autoAdvance=autoAdvance.checked; saveState(); });
    excludeSongs.addEventListener('change', ()=>{ state.prefs.excludeSongs=excludeSongs.checked; saveState(); buildScriptList(); });

    songSel.addEventListener('change', ()=>{ state.prefs.songId=songSel.value; saveState(); startSong(); });
    songModeSel.addEventListener('change', ()=>{ state.prefs.songMode=songModeSel.value; saveState(); renderSong(); });
    songContextSel.addEventListener('change', ()=>{ state.prefs.songContext=Number(songContextSel.value); saveState(); renderSong(); });

    /* ------------------------------ TTS / STT ------------------------------ */
    function speakContext(text){ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text); u.lang='de-DE'; u.rate=1.0; u.pitch=1.0; try{ speechSynthesis.cancel(); }catch(_){} speechSynthesis.speak(u); if(state.prefs.autoAdvance){ u.onend=()=> nextItem(); } }
    function contextText(lines, idx, ctxN){ const parts=[]; for(let i=Math.max(0, idx-ctxN); i<idx; i++){ parts.push(`${lines[i].speaker||'ENSEMBLE'}: ${lines[i].text}`); } return parts.join('. '); }

    /* -------------------------------- Utils -------------------------------- */
    function escapeHtml(s){ return (s||'').replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function normalize(s){ return (s||'').toLowerCase().replace(/[\s\n]+/g,' ').replace(/[.,!?:;…"'()\[\]«»„“‚’]/g,'').trim(); }
    function similarEnough(a,b){ const A=normalize(a), B=normalize(b); if(!A) return false; if(A===B) return true; const d=levenshtein(A,B); const maxLen=Math.max(A.length,B.length); const sim=1 - d / Math.max(1,maxLen); return sim>=0.88; }
    function firstNCharsHint(target, typed){ const T=normalize(target); const U=normalize(typed); let i=0; while(i<Math.min(T.length,U.length)&&T[i]===U[i]) i++; return target.slice(0, Math.max(1,i+1)) + '…'; }
    function diffHint(a,b){ const A=normalize(a).split(' '), B=normalize(b).split(' '); let i=0; while(i<A.length&&i<B.length&&A[i]===B[i]) i++; const next=B[i]||''; return next? (`Nächstes Wort: "${next}"`) : 'Prüfe Satzende & Satzbau'; }
    function levenshtein(a,b){ const m=a.length, n=b.length; if(!m) return n; if(!n) return m; const dp=new Array(n+1).fill(0); for(let j=0;j<=n;j++) dp[j]=j; for(let i=1;i<=m;i++){ let prev=dp[0]; dp[0]=i; for(let j=1;j<=n;j++){ const tmp=dp[j]; dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev + (a[i-1]===b[j-1]?0:1)); prev=tmp; } } return dp[n]; }
    function gainXP(x){ state.meta.xp += x; saveState(); refreshProgress(); }
    function miss(fb, typed, target){ state.meta.hearts=Math.max(0,state.meta.hearts-1); saveState(); refreshProgress(); const diff=diffHint(typed,target); fb.innerHTML='❌ Nicht ganz. Tipp: '+diff+(state.meta.hearts===0?'<br>💔 Keine Herzen mehr – kurze Pause?':''); }

    function clozeMask(text, every){ const words=text.split(/(\s+)/); const masked = words.map((w,i)=>{ if(w.trim()==='') return w; const k=(i/2)|0; if(k>0 && k % every === 0){ return '<span style="opacity:.35; border-bottom:1px dashed #cbd7ff">_____</span>'; } return escapeHtml(w); }).join(''); return {masked}; }
    function containsWordsInOrder(input, target, every){ const it=normalize(input).split(' ').filter(Boolean); const tt=normalize(target).split(' ').filter(Boolean); let j=0; for(let i=0;i<tt.length;i++){ if((i+1)%every===0){ if(j>=it.length || it[j]!==tt[i]) return false; j++; } } return true; }
    function firstLetters(text){ return text.split(/(\s+)/).map(t=> t.trim()? t[0].toUpperCase()+'·' : t).join(''); }

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{ if(e.key==='ArrowRight'){ e.preventDefault(); document.getElementById('nextBtn')?.click(); document.getElementById('songNextBtn')?.click(); } if(e.key===' '){ const b=document.getElementById('revealBtn')||document.getElementById('songRevealBtn'); if(b){ e.preventDefault(); b.click(); } } });

    /* ---------------------- Auto‑Load horrorladen_script.json -------------- */
    async function loadFromUrl(url){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        if(json.roles) state.roles = json.roles; if(json.scenes) state.scenes = json.scenes; if(json.songs) state.songs = json.songs;
        saveState(); refreshSelectors(); buildScriptList(); selectTab(state.prefs.tab||'trainer'); if((state.scenes?.length||0)>0) startPractice(); if((state.songs?.length||0)>0) startSong();
      }catch(err){ alert('Konnte Script nicht laden: '+err.message+'\nURL: '+url); }
    }
    function detectDataUrl(){ const qs=new URLSearchParams(location.search); const hs=new URLSearchParams(location.hash.replace(/^#/,'')); return qs.get('data') || hs.get('data') || 'horrorladen_script.json'; }
    window.addEventListener('DOMContentLoaded', ()=>{ const url = detectDataUrl(); loadFromUrl(url); });
  </script>
</body>
</html>
