<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Horrorladen ‚Äì Lernapp</title>
  <meta name="theme-color" content="#58CC02" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Nunito:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --green:#58CC02; --green-strong:#8EE000; --green-dark:#1FAF38;
      --yellow:#FFC715; --blue:#1CB0F6; --purple:#A560E8; --red:#FF4B4B;
      --ink:#2F2F2F; --paper:#FFFFFF; --bg:#F6F7FB; --muted:#6F6F6F;
      --ring: rgba(88,204,2,.35); --shadow:0 12px 30px rgba(0,0,0,.10);
      --radius:20px;
      --duo-ease-out: cubic-bezier(.17,.67,.16,1);
      --duo-ease-in: cubic-bezier(.5,0,1,.5);
      --duo-spring: cubic-bezier(.2,.8,.2,1);
      --t-fast:120ms; --t-reg:200ms; --t-slow:320ms;
    }

    html{font-size:16px;height:100dvh;overscroll-behavior:none;background:var(--bg);-webkit-text-size-adjust:100%;}
    *{-webkit-tap-highlight-color:transparent;}
    body{
      margin:0;height:100dvh;display:flex;flex-direction:column;
      background:var(--bg);color:var(--ink);
      font-family:Inter,ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      overflow:hidden; /* verhindert Bounce */
      touch-action:manipulation; /* verhindert Double-Tap-Zoom */
    }

    header{position:sticky;top:0;z-index:30;padding-top:env(safe-area-inset-top);
      backdrop-filter:saturate(120%) blur(10px);
      background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.75));
      border-bottom:1px solid rgba(0,0,0,.06)
    }
    .wrap{max-width:64rem;margin:0 auto;padding:12px}
    main.wrap{flex:1 1 auto; overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;}

    .hero{display:flex;align-items:center;gap:12px;padding:.8rem .25rem}
    .logo{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--green),var(--green-strong));
      display:grid;place-items:center;box-shadow:var(--shadow);position:relative;overflow:hidden;
      transition:transform var(--t-reg) var(--duo-ease-out);
    }
    .logo:active{transform:scale(.94);}
    .logo svg{width:36px;height:36px;display:block}
    .title{font-family:Nunito,Inter,sans-serif;font-weight:900;font-size:1.35rem}
    .badge{font-size:.8rem;padding:.25rem .6rem;border-radius:999px;background:rgba(88,204,2,.15);color:#0D6A00;font-weight:700}

    .compact .hero{padding:.45rem .25rem;gap:.55rem}
    .compact .logo{width:36px;height:36px;border-radius:10px}
    .compact .title{font-size:1.05rem}

    /* Menu */
    .menu{display:grid;grid-template-columns:repeat(5,1fr);gap:.6rem;margin:.6rem 0}
    .menu button{
      display:flex;gap:.35rem;align-items:center;justify-content:center;
      padding:.85rem;border-radius:18px;border:2px solid rgba(0,0,0,.06);
      background:linear-gradient(180deg,#fff,#F5FFF0);
      color:var(--ink);font-weight:800;letter-spacing:.2px;
      min-height:56px; box-shadow:var(--shadow);
      will-change: transform;
      transition: transform var(--t-fast) var(--duo-spring), box-shadow var(--t-reg) var(--duo-ease-out), border-color var(--t-reg) var(--duo-ease-out);
    }
    .menu button:hover{ transform: translateY(-1px) scale(1.02);}
    .menu button:active{ transform: translateY(0) scale(.98); box-shadow:0 4px 12px rgba(0,0,0,.10)}

    /* Panels & Inputs */
    .panel{
      background:linear-gradient(180deg,#fff,#F8FFF4);
      border:2px solid rgba(0,0,0,.06);
      border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);
      animation: slideUp var(--t-slow) var(--duo-ease-out);
    }
    label{font-size:.95rem;color:var(--muted);display:block;margin-bottom:.35rem}
    select,input[type=text],button{
      width:100%;padding:.85rem 1rem;border-radius:16px;border:2px solid rgba(0,0,0,.08);
      background:#fff;color:var(--ink);min-height:48px;outline:none;
      transition: transform var(--t-fast) var(--duo-spring), border-color var(--t-reg) var(--duo-ease-out), box-shadow var(--t-reg) var(--duo-ease-out)
    }
    select:focus,input:focus{border-color:var(--green); box-shadow:0 0 0 6px var(--ring); transform: translateY(-1px)}
    button.primary{background:linear-gradient(180deg,var(--green-strong),var(--green));color:#0b1220;border-color:transparent}
    .controls{display:grid;gap:.75rem;grid-template-columns:repeat(2,1fr);align-items:end}
    @media (min-width:760px){ .controls{grid-template-columns:repeat(3,1fr)} }
    .controls .cta{display:flex;justify-content:flex-end;align-items:end}

    /* Filters */
    .filters{display:grid;gap:.6rem;margin:.6rem 0}
    @media (min-width:760px){ .filters{grid-template-columns:repeat(4,1fr)} }
    .chipbar{display:flex;gap:.5rem;overflow:auto;padding:.2rem .1rem}
    .chip{flex:0 0 auto; padding:.45rem .8rem;border-radius:999px;border:2px solid rgba(0,0,0,.06); background:#fff;font-weight:800}
    .chip.active{background:linear-gradient(180deg,#F2FFF2,#E9FFE0);border-color:rgba(37,168,0,.25)}

    /* Learn rows */
    .exchange{margin:1rem 0;padding:1rem;border-radius:18px;background:#fff;border:2px solid rgba(0,0,0,.06)}
    .line{padding:.85rem 1rem;border-radius:14px;background:linear-gradient(180deg,#F2FFF2,#E9FFE0);border:2px solid rgba(37,168,0,.25)}
    .faded{opacity:.8;color:var(--muted);font-size:.95rem}
    .big{font-size:1.06rem;line-height:1.55}

    /* Viewer rows */
    .row{padding:.85rem 1rem;border-radius:14px;border:2px solid rgba(0,0,0,.06);background:#fff}
    .row.me{background:linear-gradient(180deg,#F2FFF2,#E9FFE0);border-color:rgba(37,168,0,.25);}

    /* Cards */
    .card{margin:1rem 0;padding:1.1rem;border-radius:22px;background:#fff;border:2px solid rgba(0,0,0,.06);
      text-align:center;display:flex;flex-direction:column;gap:.6rem;box-shadow:var(--shadow);
      animation: slideUp var(--t-slow) var(--duo-ease-out);
    }

    /* Pagination */
    .pager{display:flex;justify-content:space-between;align-items:center;gap:.8rem;margin:1rem 0}
    .pager .info{font-size:.92rem;color:var(--muted)}
    .pager .group{display:flex;gap:.5rem}

    [data-view]{display:none}
    [data-view].active{display:block}

    /* Micro-anim */
    @keyframes slideUp{0%{opacity:0; transform:translateY(10px)}100%{opacity:1; transform:translateY(0)}}
    .enter{animation: slideUp var(--t-slow) var(--duo-ease-out);}
  </style>
</head>
<body>
<header id="hdr">
  <div class="wrap">
    <div class="hero">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs><clipPath id="r"><rect rx="16" width="64" height="64"/></clipPath></defs>
          <g clip-path="url(#r)">
            <rect width="64" height="64" fill="#8EE000"/>
            <circle cx="22" cy="28" r="10" fill="#fff"/><circle cx="42" cy="28" r="10" fill="#fff"/>
            <circle cx="22" cy="28" r="5" fill="#2B2B2B"/><circle cx="42" cy="28" r="5" fill="#2B2B2B"/>
            <path d="M10 44 C 20 52, 44 52, 54 44" stroke="#2B2B2B" stroke-width="6" stroke-linecap="round" fill="none"/>
          </g>
        </svg>
      </div>
      <div>
        <div class="title">Horrorladen ‚Äì Lernapp</div>
        <div class="badge" id="subtitle">Willkommen</div>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- HOME -->
  <section data-view="home" class="active">
    <div class="panel">
      <nav class="menu">
        <button data-nav="learn">üìñ Lernen</button>
        <button data-nav="viewer">üìú Textviewer</button>
        <button data-nav="survival">üéÆ Survival</button>
        <button data-nav="scores">üèÜ Highscores</button>
        <button data-nav="settings">‚öôÔ∏è Einstellungen</button>
      </nav>
    </div>
  </section>

  <!-- LEARN -->
  <section data-view="learn">
    <div class="panel">
      <div class="filters">
        <div>
          <label for="actFilter">Akt</label>
          <select id="actFilter"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="sceneFilter">Szene</label>
          <select id="sceneFilter"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="songFilter">Song</label>
          <select id="songFilter"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="lyricsOnly">Lyrics-only</label>
          <label style="display:flex;gap:.5rem;align-items:center">
            <input id="lyricsOnly" type="checkbox" /> <span>nur Gesang</span>
          </label>
        </div>
      </div>
      <div id="actChips" class="chipbar" aria-label="Akte"></div>

      <div class="controls" style="margin-top:.6rem">
        <div>
          <label for="roleSel">Rolle</label>
          <select id="roleSel"></select>
        </div>
        <div>
          <label for="modeSel">Modus</label>
          <select id="modeSel">
            <option value="classic">Classic</option>
            <option value="flash">Flashcards</option>
            <option value="cloze">Cloze</option>
          </select>
        </div>
        <div class="cta">
          <button class="primary" id="startLearn">Start</button>
        </div>
      </div>
    </div>

    <div id="learnRoot"></div>

    <div class="pager" id="learnPager" hidden>
      <div class="info" id="pagerInfo">Seite 1/1</div>
      <div class="group">
        <button id="prevPage" class="secondary">‚Üê Zur√ºck</button>
        <button id="nextPage" class="primary">Weiter ‚Üí</button>
      </div>
    </div>
  </section>

  <!-- VIEWER (eigener Men√ºpunkt) -->
  <section data-view="viewer">
    <div class="panel">
      <div class="filters">
        <div>
          <label for="actFilterV">Akt</label>
          <select id="actFilterV"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="sceneFilterV">Szene</label>
          <select id="sceneFilterV"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="songFilterV">Song</label>
          <select id="songFilterV"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="lyricsOnlyV">Lyrics-only</label>
          <label style="display:flex;gap:.5rem;align-items:center">
            <input id="lyricsOnlyV" type="checkbox" /> <span>nur Gesang</span>
          </label>
        </div>
      </div>
      <div class="faded" id="viewerLegend">Hervorhebung: <strong id="viewerRoleLabel">‚Äî</strong></div>
    </div>

    <div id="viewerRoot"></div>

    <div class="pager" id="viewerPager" hidden>
      <div class="info" id="viewerPagerInfo">Seite 1/1</div>
      <div class="group">
        <button id="viewerPrev" class="secondary">‚Üê Zur√ºck</button>
        <button id="viewerNext" class="primary">Weiter ‚Üí</button>
      </div>
    </div>
  </section>

  <!-- SURVIVAL -->
  <section data-view="survival">
    <div class="panel controls">
      <div>
        <label for="roleSurv">Rolle</label>
        <select id="roleSurv"></select>
      </div>
      <div>
        <label>Herzen</label>
        <div id="heartPill" class="pill heart" aria-live="polite">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
      </div>
      <div>
        <label>Score</label>
        <div id="scorePill" class="pill" aria-live="polite">0</div>
      </div>
      <div class="cta">
        <button class="primary" id="startSurv">Neu starten</button>
      </div>
    </div>
    <div id="survRoot"></div>
  </section>

  <!-- SCORES -->
  <section data-view="scores">
    <div class="panel controls">
      <div>
        <label for="nameField">Dein Name</label>
        <input id="nameField" type="text" placeholder="z.B. Alex"/>
      </div>
      <div>
        <label for="boardRole">Rolle</label>
        <select id="boardRole"><option value="">Alle</option></select>
      </div>
      <div>
        <label for="boardLimit">Anzahl</label>
        <select id="boardLimit"><option>10</option><option selected>25</option><option>50</option></select>
      </div>
      <div class="cta">
        <button class="primary" id="refreshBoard">Aktualisieren</button>
      </div>
    </div>
    <div id="board" class="list"></div>
  </section>

  <!-- SETTINGS -->
  <section data-view="settings">
    <div class="panel">
      <div class="list" style="display:grid;gap:.8rem">
        <div class="row" style="display:flex;justify-content:space-between;align-items:center">
          <span>JSON-Quelle</span><span><code id="jsonSrcLabel">horrorladen_final_with_acts.json</code></span>
        </div>
        <div class="row" style="display:flex;justify-content:space-between;align-items:center">
          <span>Gesten-Navigation</span><span>aktiv</span>
        </div>
        <div class="row" style="display:flex;justify-content:space-between;align-items:center">
          <span>Soundeffekte</span>
          <label style="display:inline-flex;gap:.5rem;align-items:center">
            <input id="toggleSound" type="checkbox" checked /> <span>an</span>
          </label>
        </div>
        <div class="row" style="display:flex;justify-content:space-between;align-items:center">
          <span>Sound-Pack</span>
          <select id="soundPackSel">
            <option value="synth" selected>Synth (leicht)</option>
            <option value="chime">Chime (gl√§sern)</option>
          </select>
        </div>
        <div class="row" style="display:flex;justify-content:space-between;align-items:center">
          <span>Bewegung reduzieren</span>
          <label style="display:inline-flex;gap:.5rem;align-items:center">
            <input id="toggleMotion" type="checkbox" /> <span>aktiv</span>
          </label>
        </div>
      </div>
    </div>
  </section>
</main>

<div class="wrap bottom-nav">
  <nav class="menu">
    <button data-nav="home" aria-label="Home">üè†</button>
    <button data-nav="learn" aria-label="Lernen">üìñ</button>
    <button data-nav="viewer" aria-label="Textviewer">üìú</button>
    <button data-nav="survival" aria-label="Survival">üéÆ</button>
    <button data-nav="scores" aria-label="Highscores">üèÜ</button>
  </nav>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>

<script>
/* =========================
   JSON-Loader (acts/scenes/songs + speaker_blocks)
   ========================= */
const q=new URLSearchParams(location.search);
const jsonSrc=q.get('src')||'horrorladen_final_with_acts.json';
const jsonLabel = document.getElementById('jsonSrcLabel'); if(jsonLabel) jsonLabel.textContent=jsonSrc;

let soundOn=true, reduceMotion=false, soundPack='synth', currentView='home';

const state = {
  items: [],           // {type:'dialogue', speaker, text, kind:'line'|'lyric', meta:{act,scene,song}}
  acts: [], scenes: [], songs: [],
  roles: [],
  // Learn pagination
  pageIndex: 0,
  pageSizeClassic: 8,
  pageSizeSingle: 1,
  lastFiltered: [],
  // Viewer pagination
  viewerIndex: 0,
  viewerPageSize: 20,
  viewerLast: []
};

const norm = s => (s||'').trim().toUpperCase();
const treatSpeaker = sp => {
  const s = norm(sp);
  if (s==='DIE ANDEREN') return 'ALLE';
  if (s==='BARAPAPAPA' || s==='BARAPAPAPABA') return '__IGNORE__';
  return s;
};

function scanTitleLike(node, keys=['title','name','label','id']) {
  for (const k of keys) if (node && typeof node[k]==='string' && node[k].trim()) return node[k].trim();
  return null;
}

function flattenAny(node, ctx={act:null,scene:null,song:null}, out=[], metaSets){
  if (!node || typeof node!=='object') return;
  const t = (node.type||'').toLowerCase();

  if (t==='act' || 'act' in node) {
    const actName = scanTitleLike(node) || node.act || ctx.act;
    if (actName) ctx={...ctx, act: String(actName)};
  }
  if (t==='scene' || 'scene' in node) {
    const sceneName = scanTitleLike(node) || node.scene || ctx.scene;
    if (sceneName) ctx={...ctx, scene: String(sceneName)};
  }
  if (t==='song' || 'song' in node) {
    const songName = scanTitleLike(node) || node.song || ctx.song;
    if (songName) ctx={...ctx, song: String(songName)};
  }

  if (t==='speaker_block' && node.speaker) {
    const speaker = node.speaker;
    const content = Array.isArray(node.content) ? node.content : [];
    content.forEach(c=>{
      if (!c || !c.type) return;
      const ty = String(c.type).toLowerCase();
      if (ty==='line' || ty==='lyric') {
        const text = (c.text||'').trim();
        if (text) {
          out.push({type:'dialogue', speaker, text, kind: ty, meta:{...ctx}});
          metaSets.acts.add(ctx.act||''); metaSets.scenes.add(ctx.scene||''); metaSets.songs.add(ctx.song||'');
        }
      }
    });
  }

  const kids = []
    .concat(node.segments||[])
    .concat(node.children||[])
    .concat(node.parts||[])
    .concat(node.items||[])
    .concat(Array.isArray(node) ? node : []);
  kids.forEach(child => flattenAny(child, ctx, out, metaSets));
}

async function loadJSON(){
  const res = await fetch(jsonSrc, {cache:'no-store'});
  const data = await res.json();

  const out=[]; const metaSets={acts:new Set(),scenes:new Set(),songs:new Set()};
  if (Array.isArray(data)) flattenAny({segments:data}, {}, out, metaSets);
  else flattenAny(data, {}, out, metaSets);

  // Rollen aus Daten
  const roleSet = new Set(out.map(i=>norm(i.speaker)).filter(Boolean));
  state.roles = [...roleSet];

  state.items = out;
  state.acts = [...metaSets.acts].filter(Boolean);
  state.scenes = [...metaSets.scenes].filter(Boolean);
  state.songs = [...metaSets.songs].filter(Boolean);

  populateFiltersAndRoles();
  document.dispatchEvent(new CustomEvent('script-ready', {detail:{src:jsonSrc, count:state.items.length}}));
}

/* ============ UI Helpers ============ */
function el(tag,attrs={},...children){
  const n=document.createElement(tag);
  for (const[k,v]of Object.entries(attrs)){
    if(k==='class') n.className=v;
    else if(k==='html') n.innerHTML=v;
    else n.setAttribute(k,v);
  }
  for(const c of children){ if(c==null) continue; n.appendChild(typeof c==='string'?document.createTextNode(c):c); }
  return n;
}
function escapeHtml(s){return(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
function wordsOf(t){return(t||'').split(/(\s+|[.,;:!?]+)/).filter(x=>x&&!/[.,;:!?]+/.test(x));}
function makeCloze(text,ratio=.35){
  const ws=wordsOf(text);
  if(ws.length<4)return{html:escapeHtml(text),gaps:[]};
  const toHide=Math.max(1,Math.floor(ws.length*ratio));
  const idxs=new Set();
  const order=ws.map((w,i)=>({i,w})).sort((a,b)=>b.w.length-a.w.length).map(o=>o.i);
  for(let i=0;i<order.length&&idxs.size<toHide;i++){if(ws[order[i]].length>=3)idxs.add(order[i]);}
  const gaps=[];
  const out=ws.map((w,i)=>idxs.has(i)?(gaps.push(w),`<span class="cloze-gap">${' '.repeat(Math.min(12,w.length))}</span>`):escapeHtml(w)).join('');
  return{html:out,gaps};
}

/* Motion & small helpers */
const Motion = {
  stagger(nodes, step=60){ nodes.forEach((n,i)=>{ n.style.animationDelay=(i*step)+'ms'; n.classList.add('enter');
    n.addEventListener('animationend',()=>{n.style.animationDelay=''; n.classList.remove('enter');},{once:true}); }); }
};
function sfxOpen(){ try{ if(!('vibrate' in navigator)) return; navigator.vibrate(8);}catch{} }

/* View Navigation */
function switchViewImmediate(name){
  document.querySelectorAll('[data-view]').forEach(v=>{
    const active = v.dataset.view===name;
    v.classList.toggle('active',active);
    if(active){ const cards = v.querySelectorAll('.panel,.card,.row,.exchange'); Motion.stagger([...cards]); }
  });
  document.getElementById('hdr').classList.toggle('compact',name!=='home');
  document.getElementById('subtitle').textContent = name==='home' ? 'Willkommen' : name[0].toUpperCase()+name.slice(1);
  currentView=name;
}
function showView(name){ if(name===currentView){return;} switchViewImmediate(name); }
Array.from(document.querySelectorAll('[data-nav]')).forEach(btn=>btn.onclick=()=>showView(btn.dataset.nav));

/* Filters & Roles UI */
const actSel   = document.getElementById('actFilter');
const sceneSel = document.getElementById('sceneFilter');
const songSel  = document.getElementById('songFilter');
const lyricsOnly = document.getElementById('lyricsOnly');
const actChips = document.getElementById('actChips');
const roleSel = document.getElementById('roleSel');
const roleSurv = document.getElementById('roleSurv');
const boardRole = document.getElementById('boardRole');

/* Viewer filter controls */
const actSelV   = document.getElementById('actFilterV');
const sceneSelV = document.getElementById('sceneFilterV');
const songSelV  = document.getElementById('songFilterV');
const lyricsOnlyV = document.getElementById('lyricsOnlyV');
const viewerLegend = document.getElementById('viewerLegend');
const viewerRoleLabel = document.getElementById('viewerRoleLabel');

function populateFiltersAndRoles(){
  roleSel.innerHTML = state.roles.map(r=>`<option>${r}</option>`).join('');
  roleSurv.innerHTML = state.roles.map(r=>`<option>${r}</option>`).join('');
  boardRole.innerHTML = '<option value="">Alle</option>' + state.roles.map(r=>`<option>${r}</option>`).join('');

  const fillSel = (sel, arr) => sel.innerHTML = '<option value="">Alle</option>' + arr.map(v=>`<option>${v}</option>`).join('');
  fillSel(actSel, state.acts); fillSel(sceneSel, state.scenes); fillSel(songSel, state.songs);
  fillSel(actSelV, state.acts); fillSel(sceneSelV, state.scenes); fillSel(songSelV, state.songs);

  // Chips f√ºr Learn (Akte)
  actChips.innerHTML = '';
  state.acts.forEach(a=>{
    const chip=el('button',{class:'chip', type:'button'}, a);
    chip.onclick=()=>{ actSel.value=a; renderLearn(); highlightChips(); };
    actChips.appendChild(chip);
  });
  highlightChips();
  updateViewerLegend();
}

function highlightChips(){
  [...actChips.querySelectorAll('.chip')].forEach(ch=>{
    ch.classList.toggle('active', ch.textContent===actSel.value && actSel.value!=='');
  });
}

function applyFilters(items, options={byRole:true, useViewerFilters:false}){
  const role = roleSel.value;
  const act = options.useViewerFilters ? actSelV.value : actSel.value;
  const scene = options.useViewerFilters ? sceneSelV.value : sceneSel.value;
  const song = options.useViewerFilters ? songSelV.value : songSel.value;
  const lyrOnlyFlag = options.useViewerFilters ? !!lyricsOnlyV.checked : !!lyricsOnly.checked;

  return items
    .filter(it=>{
      if (options.byRole){
        const sp = treatSpeaker(it.speaker);
        if (!sp || sp==='__IGNORE__') return false;
        if (sp!=='ALLE' && sp!==norm(role)) return false;
      }
      return true;
    })
    .filter(it=>{
      if (act && (it.meta?.act||'') !== act) return false;
      if (scene && (it.meta?.scene||'') !== scene) return false;
      if (song && (it.meta?.song||'') !== song) return false;
      if (lyrOnlyFlag && it.kind!=='lyric') return false;
      return true;
    });
}

/* ---- Learn (Classic/Flash/Cloze) mit Kontext √ºber/unter ---- */
const learnRoot=document.getElementById('learnRoot');
const modeSel=document.getElementById('modeSel');
const startLearnBtn=document.getElementById('startLearn');

const pager=document.getElementById('learnPager');
const pagerInfo=document.getElementById('pagerInfo');
const prevPage=document.getElementById('prevPage');
const nextPage=document.getElementById('nextPage');

function neighborContext(all, idx, roleUC){
  const prev = all[idx-1] && norm(all[idx-1].speaker)!==roleUC ? all[idx-1] : null;
  const next = all[idx+1] && norm(all[idx+1].speaker)!==roleUC ? all[idx+1] : null;
  return {prev, next};
}

function renderLearn(){
  state.lastFiltered = applyFilters(state.items, {byRole:true, useViewerFilters:false});
  const size = (modeSel.value==='classic') ? state.pageSizeClassic : state.pageSizeSingle;
  state.pageIndex = 0;
  renderLearnPage(size, modeSel.value);
  sfxOpen();
}
function renderLearnPage(pageSize, mode){
  const items = state.lastFiltered;
  const total = items.length;
  if(!total){ learnRoot.innerHTML = '<div class="card">Keine Zeilen f√ºr die aktuelle Auswahl.</div>'; pager.hidden=true; return; }

  const pages = Math.max(1, Math.ceil(total / pageSize));
  state.pageIndex = Math.min(Math.max(0, state.pageIndex), pages-1);
  const start = state.pageIndex * pageSize;
  const slice = items.slice(start, start + pageSize);
  const roleUC = norm(roleSel.value||'');

  learnRoot.innerHTML='';

  if(mode==='classic'){
    slice.forEach((line, iInSlice)=>{
      const idx = start + iInSlice;
      const {prev, next} = neighborContext(items, idx, roleUC);
      const box=el('div',{class:'exchange'});
      if(prev) box.appendChild(el('div',{class:'faded'}, `${prev.speaker}: ${prev.text}`));
      box.appendChild(el('div',{class:'line big'}, `${line.speaker}: ${line.text}`));
      if(next) box.appendChild(el('div',{class:'faded'}, `${next.speaker}: ${next.text}`)); // dezente ‚Äûerste Antwort danach‚Äú
      learnRoot.appendChild(box);
    });
    Motion.stagger([...learnRoot.querySelectorAll('.exchange')], 40);
  } else if(mode==='flash'){
    const idx = start; const line = slice[0];
    const {prev, next} = neighborContext(items, idx, roleUC);
    const card = el('div',{class:'card'});
    if(prev) card.appendChild(el('div',{class:'faded'}, `${prev.speaker}: ${prev.text}`));
    const secret = el('div',{class:'big', html:`${line.speaker}: <em>(tippen zum Aufdecken)</em>`});
    const reveal = el('div',{class:'big', html:`${line.speaker}: ${escapeHtml(line.text)}`}); reveal.style.display='none';
    card.appendChild(secret); card.appendChild(reveal);
    if(next) card.appendChild(el('div',{class:'faded'}, `${next.speaker}: ${next.text}`));
    card.addEventListener('click', ()=>{ secret.style.display='none'; reveal.style.display=''; sfxOpen(); }, {once:true});
    learnRoot.appendChild(card);
  } else { // cloze
    const idx = start; const line = slice[0];
    const {prev, next} = neighborContext(items, idx, roleUC);
    const card = el('div',{class:'card'});
    if(prev) card.appendChild(el('div',{class:'faded'}, `${prev.speaker}: ${prev.text}`));
    const {html} = makeCloze(line.text, .35);
    card.appendChild(el('div',{class:'big', html:`${line.speaker}: ${html}`}));
    if(next) card.appendChild(el('div',{class:'faded'}, `${next.speaker}: ${next.text}`));
    learnRoot.appendChild(card);
  }

  pager.hidden = pages<=1;
  pagerInfo.textContent = `Seite ${state.pageIndex+1}/${pages}`;
  prevPage.disabled = state.pageIndex===0;
  nextPage.disabled = state.pageIndex>=pages-1;
}

startLearnBtn.onclick=renderLearn;
[actSel, sceneSel, songSel, lyricsOnly, roleSel, modeSel].forEach(elm=>elm.addEventListener('change', ()=>{
  state.pageIndex = 0; renderLearn();
}));
prevPage.onclick = ()=>{ state.pageIndex--; renderLearnPage((modeSel.value==='classic')?state.pageSizeClassic:state.pageSizeSingle, modeSel.value); };
nextPage.onclick = ()=>{ state.pageIndex++; renderLearnPage((modeSel.value==='classic')?state.pageSizeClassic:state.pageSizeSingle, modeSel.value); };
document.addEventListener('keydown', (e)=>{
  if(currentView!=='learn') return;
  const size = (modeSel.value==='classic') ? state.pageSizeClassic : state.pageSizeSingle;
  if(e.key==='ArrowRight' && !nextPage.disabled){ state.pageIndex++; renderLearnPage(size, modeSel.value); }
  if(e.key==='ArrowLeft' && !prevPage.disabled){ state.pageIndex--; renderLearnPage(size, modeSel.value); }
});

/* ---- Textviewer (eigener Men√ºpunkt) ---- */
const viewerRoot = document.getElementById('viewerRoot');
const viewerPager = document.getElementById('viewerPager');
const viewerPagerInfo = document.getElementById('viewerPagerInfo');
const viewerPrev = document.getElementById('viewerPrev');
const viewerNext = document.getElementById('viewerNext');

function updateViewerLegend(){
  const r = roleSel.value || '‚Äî';
  viewerRoleLabel.textContent = r || '‚Äî';
}

function renderViewer(){
  // ohne Rollenfilter; eigene Rolle nur zur Hervorhebung
  state.viewerLast = applyFilters(state.items, {byRole:false, useViewerFilters:true});
  state.viewerIndex = 0;
  renderViewerPage();
  updateViewerLegend();
  sfxOpen();
}

function renderViewerPage(){
  const items = state.viewerLast;
  const total = items.length;
  if(!total){ viewerRoot.innerHTML = '<div class="card">Keine Zeilen f√ºr die aktuelle Auswahl.</div>'; viewerPager.hidden=true; return; }

  const pages = Math.max(1, Math.ceil(total / state.viewerPageSize));
  state.viewerIndex = Math.min(Math.max(0, state.viewerIndex), pages-1);
  const start = state.viewerIndex * state.viewerPageSize;
  const slice = items.slice(start, start + state.viewerPageSize);

  viewerRoot.innerHTML='';
  const roleUC = norm(roleSel.value||'');

  slice.forEach(line=>{
    const isMe = norm(line.speaker)===roleUC && roleUC!=='';
    const row = el('div', {class:'row'+(isMe?' me':'')}, `${line.speaker}: ${line.text}`);
    viewerRoot.appendChild(row);
  });
  Motion.stagger([...viewerRoot.querySelectorAll('.row')], 30);

  viewerPager.hidden = pages<=1;
  viewerPagerInfo.textContent = `Seite ${state.viewerIndex+1}/${pages}`;
  viewerPrev.disabled = state.viewerIndex===0;
  viewerNext.disabled = state.viewerIndex>=pages-1;
}

/* Viewer events */
[actSelV, sceneSelV, songSelV, lyricsOnlyV].forEach(elm=>elm.addEventListener('change', ()=>{ state.viewerIndex=0; renderViewer(); }));
viewerPrev.onclick = ()=>{ state.viewerIndex--; renderViewerPage(); };
viewerNext.onclick = ()=>{ state.viewerIndex++; renderViewerPage(); };
document.addEventListener('keydown', (e)=>{
  if(currentView!=='viewer') return;
  if(e.key==='ArrowRight' && !viewerNext.disabled){ state.viewerIndex++; renderViewerPage(); }
  if(e.key==='ArrowLeft' && !viewerPrev.disabled){ state.viewerIndex--; renderViewerPage(); }
});
roleSel.addEventListener('change', ()=>{ // nur Legende/Hervorhebung aktualisieren
  if(currentView==='viewer'){ renderViewerPage(); updateViewerLegend(); }
});

/* Survival (Quiz ohne Nachher-Kontext) */
const survRoot=document.getElementById('survRoot');
let survLives=3,survScore=0;
function renderHearts(){ document.getElementById('heartPill').textContent='‚ù§Ô∏è'.repeat(Math.max(0,survLives)); }
function renderScore(){ const pill=document.getElementById('scorePill'); pill.textContent=survScore; }

function startSurv(){
  const pool = applyFilters(state.items, {byRole:true, useViewerFilters:false});
  if(!pool.length){ survRoot.innerHTML='<div class="card">Keine Zeilen f√ºr die aktuelle Auswahl.</div>'; return; }
  survLives=3; survScore=0; renderHearts(); renderScore(); nextSurv(pool);
}
function nextSurv(pool){
  if(survLives<=0){gameOver();return;}
  survRoot.innerHTML='';
  const card=el('div',{class:'card'}); survRoot.appendChild(card);
  const line=pool[Math.floor(Math.random()*pool.length)];
  const correct=line.text;
  const wrongs=pool.filter(l=>l!==line).sort(()=>.5-Math.random()).slice(0,2).map(l=>l.text);
  const opts=[correct,...wrongs].sort(()=>.5-Math.random());
  card.appendChild(el('div',{class:'big'},`${line.speaker}: ‚Ä¶`));
  const choices=el('div',{class:'choices'});
  opts.forEach(opt=>{
    const btn=el('button',{class:'secondary'},opt);
    btn.onclick=(ev)=>{
      if(opt===correct){
        survScore++; renderScore();
        confetti({particleCount:36, spread:60, origin:{x:(ev.clientX||window.innerWidth/2)/window.innerWidth, y:(ev.clientY||window.innerHeight*0.6)/window.innerHeight}, scalar:1.1});
      }else{
        survLives--; renderHearts();
        card.classList.remove('enter'); void card.offsetWidth; card.classList.add('enter');
      }
      nextSurv(pool);
    };
    choices.appendChild(btn);
  });
  card.appendChild(choices);
}
function gameOver(){
  survRoot.innerHTML='';
  const over=el('div',{class:'card big'},`Game Over! Score: ${survScore}`);
  survRoot.appendChild(over); saveScore(survScore);
}
document.getElementById('startSurv').onclick=startSurv;

/* Highscores (GUN.js) */
const gun=Gun(['https://gun-manhattan.herokuapp.com/gun']);
const board=gun.get('horrorladen-scores');
function saveScore(score){
  const name=document.getElementById('nameField').value||'Anon';
  const role=roleSurv.value;
  board.set({name,role,score,time:Date.now()});
}
document.getElementById('refreshBoard').onclick=async()=>{
  const list=[]; board.map().once((data)=>{ if(data)list.push(data); renderBoard(list); });
};
function renderBoard(list){
  const limit=parseInt(document.getElementById('boardLimit').value)||25;
  const roleFilter=boardRole.value;
  list.sort((a,b)=>b.score-a.score);
  const filtered=list.filter(x=>!roleFilter||x.role===roleFilter).slice(0,limit);
  const div=document.getElementById('board'); div.innerHTML='';
  filtered.forEach(r=>{
    div.appendChild(el('div',{class:'row',style:'display:flex;justify-content:space-between;padding:.7rem 1rem;background:#fff;border:2px solid rgba(0,0,0,.06);border-radius:14px;margin:.35rem 0'},
      `${r.name} ${r.role?`(${r.role})`:''}`, el('span',{}, r.score)));
  });
}

/* Gesten-Navigation (Zur√ºck-Swipe) */
let touchStartX=0;
addEventListener('touchstart',e=>{touchStartX=e.changedTouches[0].screenX;});
addEventListener('touchend',e=>{ const dx=e.changedTouches[0].screenX-touchStartX; if(dx>80)showView('home'); });

/* Mobile: Zoom strikt unterbinden */
(function(){
  ['gesturestart','gesturechange','gestureend'].forEach(evt=>document.addEventListener(evt, e=>e.preventDefault(), {passive:false}));
  document.addEventListener('touchmove', function(e){ if(typeof e.scale==='number' && e.scale!==1){ e.preventDefault(); } }, {passive:false});
  let lastTouchEnd=0;
  document.addEventListener('touchend', function(e){ const now=Date.now(); if(now - lastTouchEnd <= 300){ e.preventDefault(); } lastTouchEnd=now; }, {passive:false});
})();

/* Init */
const toggleSound = document.getElementById('toggleSound');
const toggleMotion = document.getElementById('toggleMotion');
const soundPackSel = document.getElementById('soundPackSel');

if(toggleSound){ soundOn = toggleSound.checked; toggleSound.onchange=()=>{soundOn=toggleSound.checked;}; }
if(toggleMotion){ toggleMotion.onchange=()=>{reduceMotion=toggleMotion.checked; document.documentElement.style.setProperty('scroll-behavior', reduceMotion?'auto':'smooth'); }; }
if(soundPackSel){ soundPackSel.onchange=()=>{ soundPack=soundPackSel.value; }; }

function switchViewImmediateSetup(){
  switchViewImmediate('home');
  // Standard: Learn + Viewer initial render vorbereiten
  renderLearn();
  renderViewer();
}
document.readyState==='loading'
  ? document.addEventListener('DOMContentLoaded', ()=>loadJSON().then(switchViewImmediateSetup))
  : loadJSON().then(switchViewImmediateSetup);
</script>
</body>
</html>
