<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Horrorladen ‚Äì Lernapp</title>
<meta name="theme-color" content="#58CC02" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Nunito:wght@700;900&display=swap" rel="stylesheet">
<style>
  :root{--green:#58CC02;--green2:#8EE000;--ink:#2F2F2F;--bg:#F6F7FB;--muted:#6F6F6F;--ring:rgba(88,204,2,.35);--shadow:0 12px 30px rgba(0,0,0,.1);--radius:20px;--ease:cubic-bezier(.2,.8,.2,1)}
  html,body{height:100%} html{background:var(--bg);-webkit-text-size-adjust:100%} *{-webkit-tap-highlight-color:transparent;box-sizing:border-box}
  body{margin:0;display:flex;flex-direction:column;font-family:Inter,ui-sans-serif,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);overflow:hidden}
  header{position:sticky;top:0;z-index:30;padding-top:env(safe-area-inset-top);backdrop-filter:saturate(120%) blur(10px);background:linear-gradient(180deg,#fffE,#fffC);border-bottom:1px solid #0001}
  .wrap{max-width:64rem;margin:0 auto;padding:12px} main.wrap{flex:1 1 auto;overflow:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
  .hero{display:flex;gap:12px;align-items:center;padding:.8rem .25rem}
  .logo{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--green),var(--green2));display:grid;place-items:center;box-shadow:var(--shadow)}
  .title{font-family:Nunito,Inter,sans-serif;font-weight:900;font-size:1.35rem}.badge{font-size:.8rem;padding:.25rem .6rem;border-radius:999px;background:#8ee00026;color:#0D6A00;font-weight:700}
  .compact .hero{padding:.45rem .25rem}.compact .logo{width:36px;height:36px;border-radius:10px}.compact .title{font-size:1.05rem}

  .menu{display:grid;grid-template-columns:repeat(5,1fr);gap:.6rem;margin:.6rem 0}
  @media (max-width:820px){.menu{grid-template-columns:repeat(3,1fr)}} @media (max-width:480px){.menu{grid-template-columns:repeat(2,1fr)}} @media (max-width:400px){.menu{grid-template-columns:1fr}}
  .menu button{display:flex;gap:.35rem;align-items:center;justify-content:center;padding:.9rem;border-radius:18px;border:2px solid #0001;background:linear-gradient(180deg,#fff,#F5FFF0);font-weight:800;min-height:56px;box-shadow:var(--shadow);transition:transform .12s var(--ease),box-shadow .2s var(--ease),filter .2s var(--ease)}
  .menu button:active{transform:translateY(1px) scale(.98);filter:brightness(.98)}

  .panel{background:linear-gradient(180deg,#fff,#F8FFF4);border:2px solid #0001;border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow)}
  label{font-size:.95rem;color:var(--muted);display:block;margin-bottom:.35rem}
  .select-wrap{position:relative}
  select,input[type=text],button{width:100%;padding:.85rem 1rem;border-radius:16px;border:2px solid #0002;background:#fff;min-height:48px;outline:none;transition:transform .12s var(--ease),border-color .2s var(--ease),box-shadow .2s var(--ease)}
  select:focus,input:focus{border-color:var(--green);box-shadow:0 0 0 6px var(--ring);transform:translateY(-1px)}
  button.primary{background:linear-gradient(180deg,var(--green2),var(--green));color:#0b1220;border-color:transparent;font-weight:800}
  .controls{display:grid;gap:.75rem;grid-template-columns:repeat(2,1fr);align-items:end} @media (min-width:760px){.controls{grid-template-columns:repeat(3,1fr)}}
  .controls .cta{display:flex;justify-content:flex-end;align-items:end}
  .filters{display:grid;gap:.6rem;margin:.6rem 0} @media (min-width:760px){.filters{grid-template-columns:repeat(4,1fr)}}

  .exchange{margin:1rem 0;padding:1rem;border-radius:18px;background:#fff;border:2px solid #0001}
  .line{padding:.85rem 1rem;border-radius:14px;background:linear-gradient(180deg,#F2FFF2,#E9FFE0);border:2px solid rgba(37,168,0,.25)}
  .faded{opacity:.8;color:var(--muted);font-size:.95rem}.big{font-size:1.12rem;line-height:1.6}

  .card{margin:1rem 0;padding:1.1rem;border-radius:22px;background:#fff;border:2px solid #0001;text-align:center;display:flex;flex-direction:column;gap:.6rem;box-shadow:var(--shadow)}
  .card.flash,.card.cloze{max-width:42rem;margin:1rem auto;padding:1.25rem 1.35rem}.card.flash .big,.card.cloze .big{font-size:1.25rem;line-height:1.75}

  .row{padding:.85rem 1rem;border-radius:14px;border:2px solid #0001;background:#fff}
  .row.me{background:linear-gradient(180deg,#F2FFF2,#E9FFE0);border-color:rgba(37,168,0,.25)}

  .pager{display:flex;justify-content:space-between;align-items:center;gap:.8rem;margin:1rem 0}.pager .info{font-size:.92rem;color:var(--muted)}.pager .group{display:flex;gap:.5rem}
  .progress{height:8px;border-radius:999px;background:#e6e9ef;overflow:hidden}.progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#8EE000,#58CC02);transition:width .25s var(--ease)}
  [data-view]{display:none}[data-view].active{display:block}
</style>
</head>
<body>
<header id="hdr">
  <div class="wrap">
    <div class="hero">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><rect width="64" height="64" rx="16" fill="#8EE000"/><circle cx="22" cy="28" r="10" fill="#fff"/><circle cx="42" cy="28" r="10" fill="#fff"/><circle cx="22" cy="28" r="5"/><circle cx="42" cy="28" r="5"/><path d="M10 44C20 52 44 52 54 44" stroke="#2B2B2B" stroke-width="6" stroke-linecap="round" fill="none"/></svg>
      </div>
      <div><div class="title">Horrorladen ‚Äì Lernapp</div><div class="badge" id="subtitle">Willkommen</div></div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- HOME -->
  <section data-view="home" class="active">
    <div class="panel"><nav class="menu">
      <button data-nav="learn">üìñ Lernen</button>
      <button data-nav="viewer">üìú Textviewer</button>
      <button data-nav="survival">üéÆ Survival</button>
      <button data-nav="scores">üèÜ Highscores</button>
      <button data-nav="settings">‚öôÔ∏è Einstellungen</button>
    </nav></div>
  </section>

  <!-- LEARN -->
  <section data-view="learn">
    <div class="panel">
      <div class="filters">
        <div class="select-wrap"><label for="actFilter">Akt</label><select id="actFilter"><option value="">Alle</option></select></div>
        <div class="select-wrap"><label for="sceneFilter">Szene</label><select id="sceneFilter"><option value="">Alle</option></select></div>
        <div class="select-wrap"><label for="songFilter">Song</label><select id="songFilter"><option value="">Alle</option></select></div>
        <div><label>Lyrics-only</label><label style="display:flex;gap:.5rem;align-items:center"><input id="lyricsOnly" type="checkbox"> <span>nur Gesang</span></label></div>
      </div>
      <div class="controls" style="margin-top:.6rem">
        <div class="select-wrap"><label for="roleSel">Rolle</label><select id="roleSel"></select></div>
        <div class="select-wrap"><label for="modeSel">Modus</label><select id="modeSel"><option value="classic">Classic</option><option value="flash">Flashcards</option><option value="cloze">Cloze</option></select></div>
        <div class="cta"><button class="primary" id="startLearn">Start</button></div>
      </div>
    </div>
    <div id="learnMeta" style="display:flex;align-items:center;gap:.8rem;margin-top:.8rem"><div class="progress" style="flex:1"><i id="learnProg"></i></div><div class="faded" id="learnCount">0/0</div></div>
    <div id="learnRoot"></div>
    <div class="pager" id="learnPager" hidden><div class="info" id="pagerInfo">Seite 1/1</div><div class="group"><button id="prevPage">‚Üê Zur√ºck</button><button id="nextPage" class="primary">Weiter ‚Üí</button></div></div>
  </section>

  <!-- VIEWER -->
  <section data-view="viewer">
    <div class="panel">
      <div class="filters">
        <div class="select-wrap"><label for="actFilterV">Akt</label><select id="actFilterV"><option value="">Alle</option></select></div>
        <div class="select-wrap"><label for="sceneFilterV">Szene</label><select id="sceneFilterV"><option value="">Alle</option></select></div>
        <div class="select-wrap"><label for="songFilterV">Song</label><select id="songFilterV"><option value="">Alle</option></select></div>
        <div><label>Lyrics-only</label><label style="display:flex;gap:.5rem;align-items:center"><input id="lyricsOnlyV" type="checkbox"> <span>nur Gesang</span></label></div>
      </div>
      <div class="controls" style="grid-template-columns:1fr"><div class="select-wrap"><label for="viewerRoleSel">Hervorhebung (nur Anzeige)</label><select id="viewerRoleSel"></select></div></div>
    </div>
    <div id="viewerMeta" style="display:flex;align-items:center;gap:.8rem;margin-top:.8rem"><div class="progress" style="flex:1"><i id="viewerProg"></i></div><div class="faded" id="viewerCount">0/0</div></div>
    <div id="viewerRoot"></div>
    <div class="pager" id="viewerPager" hidden><div class="info" id="viewerPagerInfo">Seite 1/1</div><div class="group"><button id="viewerPrev">‚Üê Zur√ºck</button><button id="viewerNext" class="primary">Weiter ‚Üí</button></div></div>
  </section>

  <!-- SURVIVAL -->
  <section data-view="survival">
    <div class="panel controls">
      <div class="select-wrap"><label for="roleSurv">Rolle</label><select id="roleSurv"></select></div>
      <div><label>Herzen</label><div id="heartPill" class="pill heart">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div>
      <div><label>Score</label><div id="scorePill" class="pill">0</div></div>
      <div class="cta"><button class="primary" id="startSurv">Neu starten</button></div>
    </div>
    <div id="survRoot"></div>
  </section>

  <!-- SCORES -->
  <section data-view="scores"><div class="panel" style="display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap"><div class="title" style="font-size:1.05rem">Leaderboard</div><div class="faded" id="boardInfo">‚Äî</div></div><div id="board" class="list"></div></section>

  <!-- SETTINGS -->
  <section data-view="settings">
    <div class="panel" style="display:grid;gap:1rem">
      <div class="controls" style="grid-template-columns:1fr auto">
        <div><label for="playerName">Spielername</label><input id="playerName" type="text" placeholder="z.B. Alex"/></div>
        <div class="cta"><button class="primary" id="saveSettings">Speichern</button></div>
      </div>
      <div style="display:grid;gap:.6rem">
        <label for="scriptSelect">JSON-Quelle</label>
        <div class="select-wrap"><select id="scriptSelect"></select></div>
        <div style="display:grid;gap:.6rem;grid-template-columns:1fr auto;align-items:end">
          <div style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap">
            <label style="display:flex;gap:.4rem;align-items:center"><input id="manualToggle" type="checkbox"> <span>Manuell eingeben</span></label>
            <input id="scriptInput" type="text" placeholder="Pfad/Datei.json" style="display:none;flex:1 1 260px"/>
          </div>
          <button class="primary" id="loadScriptBtn">Neu laden</button>
        </div>
        <div class="faded">Aktuell: <code id="jsonSrcLabel">‚Äî</code></div>
        <div class="faded" id="discHint"></div>
      </div>
    </div>
  </section>
</main>

<div class="wrap bottom-nav"><nav class="menu">
  <button data-nav="home" aria-label="Home">üè†</button>
  <button data-nav="learn" aria-label="Lernen">üìñ</button>
  <button data-nav="viewer" aria-label="Textviewer">üìú</button>
  <button data-nav="survival" aria-label="Survival">üéÆ</button>
  <button data-nav="scores" aria-label="Highscores">üèÜ</button>
</nav></div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
<script>
/* ===== state & prefs ===== */
const LS={name:'hl_player_name',src:'hl_json_src'};
let jsonSrc=localStorage.getItem(LS.src)||'horrorladen_final_with_acts.json';
const jsonLabel=document.getElementById('jsonSrcLabel'); jsonLabel.textContent=jsonSrc;

let currentView='home';
const state={items:[],roles:[],actsList:[],scenesByAct:{},songsSet:new Set(),
  pageIndex:0,pageSizeClassic:8,pageSizeSingle:1,lastFiltered:[],
  viewerIndex:0,viewerPageSize:20,viewerLast:[],viewerHighlightRole:''};

const norm=s=>(s||'').trim().toUpperCase();
const treatSpeaker=sp=>{const s=norm(sp); if(s==='DIE ANDEREN')return'ALLE'; if(s==='BARAPAPAPA'||s==='BARAPAPAPABA')return'__IGNORE__'; return s;};
const el=(t,a={},...c)=>{const n=document.createElement(t);for(const[k,v]of Object.entries(a)){k==='class'?n.className=v:k==='html'?n.innerHTML=v:n.setAttribute(k,v)} c.forEach(x=>{if(x!=null)n.appendChild(typeof x==='string'?document.createTextNode(x):x)});return n};
const escapeHtml=s=>(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const wordsOf=t=>(t||'').split(/(\s+|[.,;:!?]+)/).filter(x=>x&&!/[.,;:!?]+/.test(x));
function makeCloze(text,ratio=.35){const ws=wordsOf(text);if(ws.length<4)return{html:escapeHtml(text)};const hide=Math.max(1,Math.floor(ws.length*ratio));
  const idx=new Set(ws.map((w,i)=>({i,w})).sort((a,b)=>b.w.length-a.w.length).slice(0,hide).map(o=>o.i));
  return{html:ws.map((w,i)=>idx.has(i)?`<span class="cloze-gap">${' '.repeat(Math.min(12,w.length))}</span>`:escapeHtml(w)).join('')};}
const scanTitleLike=(obj)=>{if(!obj||typeof obj!=='object')return null; for(const k of ['title','name','label','id']){if(typeof obj[k]==='string'&&obj[k].trim())return obj[k].trim()} return null;}
function normalizeTitle(v){ if(typeof v==='string') return v; if(typeof v==='number') return String(v); if(v && typeof v==='object'){ const t=scanTitleLike(v); if(t) return t; } return ''; }

/* flatten: robust gegen verschachtelte song/scene/act */
function flattenAny(node,ctx={act:null,scene:null,song:null},out=[],meta){
  if(!node||typeof node!=='object')return;
  const t=(node.type||'').toLowerCase();

  if(t==='act' || 'act' in node){ const a = normalizeTitle('act' in node ? node.act : node); if(a) ctx={...ctx,act:a}; }
  if(t==='scene' || 'scene' in node){ const s = normalizeTitle('scene' in node ? node.scene : node); if(s) ctx={...ctx,scene:s}; }
  if(t==='song' || 'song' in node){ const s = normalizeTitle('song' in node ? node.song : node); if(s) ctx={...ctx,song:s}; }

  if(t==='speaker_block' && node.speaker){
    const speaker=node.speaker; const content=Array.isArray(node.content)?node.content:[];
    content.forEach(c=>{ if(!c||!c.type)return; const ty=String(c.type).toLowerCase();
      if(ty==='line'||ty==='lyric'){ const text=(c.text||'').trim(); if(!text)return;
        out.push({type:'dialogue',speaker,text,kind:ty,meta:{...ctx}});
        meta.roles.add(norm(speaker)); if(ctx.song) meta.songs.add(ctx.song);
      }
    });
  }

  const kids=[].concat(node.segments||[],node.children||[],node.parts||[],node.items||[],Array.isArray(node)?node:[]);
  kids.forEach(ch=>flattenAny(ch,ctx,out,meta));
}

async function loadJSON(){
  const res=await fetch(jsonSrc,{cache:'no-store'}); const data=await res.json();
  const out=[]; const meta={roles:new Set(),songs:new Set()};
  Array.isArray(data)?flattenAny({segments:data},{},out,meta):flattenAny(data,{},out,meta);
  state.items=out; state.roles=[...meta.roles];
  // acts/scenes aus acts[]
  state.actsList=[]; state.scenesByAct={};
  if(data && Array.isArray(data.acts)){
    data.acts.forEach(act=>{
      const a=normalizeTitle(act); if(!a) return;
      state.actsList.push(a);
      state.scenesByAct[a]=(Array.isArray(act.scenes)?act.scenes:[]).map(s=>normalizeTitle(s)).filter(Boolean);
    });
  }
  state.songsSet = new Set([...meta.songs].map(normalizeTitle).filter(Boolean).sort((a,b)=>a.localeCompare(b)));
  populateFilters();
}

/* nav */
function switchViewImmediate(name){document.querySelectorAll('[data-view]').forEach(v=>v.classList.toggle('active',v.dataset.view===name));document.getElementById('hdr').classList.toggle('compact',name!=='home');document.getElementById('subtitle').textContent=name==='home'?'Willkommen':name[0].toUpperCase()+name.slice(1);currentView=name;}
document.querySelectorAll('[data-nav]').forEach(b=>b.onclick=()=>switchViewImmediate(b.dataset.nav));

/* controls refs */
const actSel=document.getElementById('actFilter'),sceneSel=document.getElementById('sceneFilter'),songSel=document.getElementById('songFilter'),lyricsOnly=document.getElementById('lyricsOnly'),roleSel=document.getElementById('roleSel');
const actSelV=document.getElementById('actFilterV'),sceneSelV=document.getElementById('sceneFilterV'),songSelV=document.getElementById('songFilterV'),lyricsOnlyV=document.getElementById('lyricsOnlyV'),viewerRoleSel=document.getElementById('viewerRoleSel');
const roleSurv=document.getElementById('roleSurv');

/* populate */
function fillSongs(sel){ sel.innerHTML='<option value="">Alle</option>'+[...state.songsSet].map(s=>`<option>${s}</option>`).join(''); }
function populateFilters(){
  const roleOpts=state.roles.map(r=>`<option>${r}</option>`).join('');
  roleSel.innerHTML=roleOpts; roleSurv.innerHTML=roleOpts; viewerRoleSel.innerHTML=roleOpts; state.viewerHighlightRole=viewerRoleSel.value||'';
  const fillActs=sel=> sel.innerHTML='<option value="">Alle</option>'+state.actsList.map(a=>`<option>${a}</option>`).join('');
  fillActs(actSel); fillActs(actSelV);
  const refreshScenes=(act,sel)=>{ const list=act?(state.scenesByAct[act]||[]):Object.values(state.scenesByAct).flat(); sel.innerHTML='<option value="">Alle</option>'+list.map(s=>`<option>${s}</option>`).join(''); };
  refreshScenes('',sceneSel); refreshScenes('',sceneSelV);
  fillSongs(songSel); fillSongs(songSelV);
  renderLearn(); renderViewer();
}
actSel.addEventListener('change',()=>{ const a=actSel.value; const l=a?(state.scenesByAct[a]||[]):Object.values(state.scenesByAct).flat(); sceneSel.innerHTML='<option value="">Alle</option>'+l.map(s=>`<option>${s}</option>`).join(''); resetProgressInstant(); renderLearn();});
actSelV.addEventListener('change',()=>{ const a=actSelV.value; const l=a?(state.scenesByAct[a]||[]):Object.values(state.scenesByAct).flat(); sceneSelV.innerHTML='<option value="">Alle</option>'+l.map(s=>`<option>${s}</option>`).join(''); renderViewer();});
[songSel,songSelV,sceneSel,sceneSelV,lyricsOnly,lyricsOnlyV,roleSel].forEach(e=>e.addEventListener('change',()=>{ if(e===roleSel){} resetProgressInstant(); renderLearn(); renderViewer(); }));

/* filtering */
function applyFilters(items,{byRole=true,useViewer=false,roleOverride=null}={}){
  const role=roleOverride||roleSel.value;
  const act=useViewer?actSelV.value:actSel.value;
  const scene=useViewer?sceneSelV.value:sceneSel.value;
  const song=useViewer?songSelV.value:songSel.value;
  const lyr=useViewer?!!lyricsOnlyV.checked:!!lyricsOnly.checked;

  return items.filter(it=>{
    if(byRole){ const sp=treatSpeaker(it.speaker); if(!sp||sp==='__IGNORE__')return false; if(sp!=='ALLE'&&sp!==norm(role))return false; }
    if(act && (it.meta?.act||'')!==act) return false;
    if(scene && (it.meta?.scene||'')!==scene) return false;
    if(song && (it.meta?.song||'')!==song) return false;
    if(lyr && it.kind!=='lyric') return false;
    return true;
  });
}

/* Kontext ‚Äî respektiert Song-Filter (kein Fremd-Song) */
function getContextForLine(line, fullSeq, myRoleUC, onlySameSong){
  const idx = fullSeq.findIndex(x=> norm(x.speaker)===norm(line.speaker) && x.text===line.text &&
    (x.meta?.act||'')===(line.meta?.act||'') && (x.meta?.scene||'')===(line.meta?.scene||'') && (x.meta?.song||'')===(line.meta?.song||''));
  if(idx<0) return {prev:null,next:null};
  let prev=null; for(let i=idx-1;i>=0;i--){ const okRole=norm(fullSeq[i].speaker)!==myRoleUC; const okSong=!onlySameSong || (fullSeq[i].meta?.song||'')===(line.meta?.song||''); if(okRole && okSong){ prev=fullSeq[i]; break; } }
  let next=null; for(let i=idx+1;i<fullSeq.length;i++){ const okRole=norm(fullSeq[i].speaker)!==myRoleUC; const okSong=!onlySameSong || (fullSeq[i].meta?.song||'')===(line.meta?.song||''); if(okRole && okSong){ next=fullSeq[i]; break; } }
  return {prev,next};
}

/* Progress helper */
const learnProg=document.getElementById('learnProg'); const learnCount=document.getElementById('learnCount');
function setProgress(el, pct, instant=false){ if(instant){ const t=el.style.transition; el.style.transition='none'; el.style.width=pct; el.getBoundingClientRect(); el.style.transition=t||'width .25s var(--ease)'; } else el.style.width=pct; }
function resetProgressInstant(){ setProgress(learnProg,'0%',true); }

/* Learn */
const learnRoot=document.getElementById('learnRoot'); const modeSel=document.getElementById('modeSel'); const startLearnBtn=document.getElementById('startLearn');
const pager=document.getElementById('learnPager'); const pagerInfo=document.getElementById('pagerInfo'); const prevPage=document.getElementById('prevPage'); const nextPage=document.getElementById('nextPage');

function renderLearn(){ state.lastFiltered=applyFilters(state.items,{byRole:true}); state.pageIndex=0; renderLearnPage(true); }
function renderLearnPage(reset=false){
  const mode=modeSel.value; const pageSize=(mode==='classic')?state.pageSizeClassic:state.pageSizeSingle;
  const items=state.lastFiltered; const total=items.length;
  if(!items.length){ learnRoot.innerHTML='<div class="card">Keine Zeilen f√ºr die aktuelle Auswahl.</div>'; pager.hidden=true; learnCount.textContent=`0/${state.items.length}`; setProgress(learnProg,'0%',true); return; }

  const pages=Math.max(1,Math.ceil(total/pageSize));
  state.pageIndex=Math.min(Math.max(0,state.pageIndex),pages-1);
  const start=state.pageIndex*pageSize; const slice=items.slice(start,start+pageSize);

  learnRoot.innerHTML='';
  const myRoleUC=norm(roleSel.value||''); const fullSeq=applyFilters(state.items,{byRole:false});
  const songFilterActive = !!songSel.value;

  if(mode==='classic'){
    slice.forEach(line=>{
      const box=el('div',{class:'exchange'});
      const {prev,next}=getContextForLine(line,fullSeq,myRoleUC,songFilterActive);
      if(prev) box.appendChild(el('div',{class:'faded'},`${prev.speaker}: ${prev.text}`));
      box.appendChild(el('div',{class:'line big'},`${line.speaker}: ${line.text}`));
      if(next) box.appendChild(el('div',{class:'faded'},`${next.speaker}: ${next.text}`));
      learnRoot.appendChild(box);
    });
  } else if(mode==='flash'){
    const line=slice[0];
    const {prev,next}=getContextForLine(line,fullSeq,myRoleUC,songFilterActive);
    const card=el('div',{class:'card flash'});
    if(prev) card.appendChild(el('div',{class:'faded'},`${prev.speaker}: ${prev.text}`));
    const secret=el('div',{class:'big',html:`${line.speaker}: <em>(tippen zum Aufdecken)</em>`});
    const reveal=el('div',{class:'big',html:`${line.speaker}: ${escapeHtml(line.text)}`}); reveal.style.display='none';
    card.appendChild(secret); card.appendChild(reveal); if(next) card.appendChild(el('div',{class:'faded'},`${next.speaker}: ${next.text}`));
    card.addEventListener('click',()=>{ secret.style.display='none'; reveal.style.display=''; },{once:true});
    learnRoot.appendChild(card);
  } else { // cloze
    const line=slice[0]; const {prev,next}=getContextForLine(line,fullSeq,myRoleUC,songFilterActive);
    const card=el('div',{class:'card cloze'}); if(prev) card.appendChild(el('div',{class:'faded'},`${prev.speaker}: ${prev.text}`));
    const {html}=makeCloze(line.text,.35); card.appendChild(el('div',{class:'big',html:`${line.speaker}: ${html}`}));
    if(next) card.appendChild(el('div',{class:'faded'},`${next.speaker}: ${next.text}`)); learnRoot.appendChild(card);
  }

  pager.hidden = pages<=1;
  pagerInfo.textContent = `Seite ${state.pageIndex+1}/${pages}`;
  prevPage.disabled=state.pageIndex===0; nextPage.disabled=state.pageIndex>=pages-1;

  learnCount.textContent = `${total}/${state.items.length}`;
  setProgress(learnProg, `${((state.pageIndex+1)/pages)*100}%`, !!reset);
}
startLearnBtn.onclick=()=>renderLearn();
[modeSel].forEach(e=>e.addEventListener('change',()=>{state.pageIndex=0; resetProgressInstant(); renderLearn();}));
prevPage.onclick=()=>{state.pageIndex--; renderLearnPage();};
nextPage.onclick=()=>{state.pageIndex++; renderLearnPage();};

/* Viewer */
const viewerRoot=document.getElementById('viewerRoot'); const viewerPager=document.getElementById('viewerPager'); const viewerPagerInfo=document.getElementById('viewerPagerInfo'); const viewerPrev=document.getElementById('viewerPrev'); const viewerNext=document.getElementById('viewerNext'); const viewerProg=document.getElementById('viewerProg'); const viewerCount=document.getElementById('viewerCount');
function renderViewer(){ state.viewerLast=applyFilters(state.items,{byRole:false,useViewer:true}); state.viewerIndex=0; renderViewerPage(); }
function renderViewerPage(){
  const items=state.viewerLast,total=items.length;
  if(!items.length){ viewerRoot.innerHTML='<div class="card">Keine Zeilen f√ºr die aktuelle Auswahl.</div>'; viewerPager.hidden=true; viewerCount.textContent=`0/${state.items.length}`; viewerProg.style.width='0%'; return; }
  const pages=Math.max(1,Math.ceil(items.length/state.viewerPageSize));
  state.viewerIndex=Math.min(Math.max(0,state.viewerIndex),pages-1);
  const slice=items.slice(state.viewerIndex*state.viewerPageSize,state.viewerIndex*state.viewerPageSize+state.viewerPageSize);
  viewerRoot.innerHTML=''; const hl=norm(state.viewerHighlightRole||'');
  slice.forEach(line=>{ const me=norm(line.speaker)===hl&&hl!==''; viewerRoot.appendChild(el('div',{class:'row'+(me?' me':'')},`${line.speaker}: ${line.text}`)); });
  viewerPager.hidden=pages<=1; viewerPagerInfo.textContent=`Seite ${state.viewerIndex+1}/${pages}`; viewerPrev.disabled=state.viewerIndex===0; viewerNext.disabled=state.viewerIndex>=pages-1;
  viewerCount.textContent=`${total}/${state.items.length}`; viewerProg.style.width=`${((state.viewerIndex+1)/pages)*100}%`;
}
[actSelV,sceneSelV,songSelV,lyricsOnlyV].forEach(e=>e.addEventListener('change',()=>{state.viewerIndex=0; renderViewer();}));
viewerPrev.onclick=()=>{state.viewerIndex--; renderViewerPage();}; viewerNext.onclick=()=>{state.viewerIndex++; renderViewerPage();};
viewerRoleSel.addEventListener('change',()=>{state.viewerHighlightRole=viewerRoleSel.value||''; renderViewerPage();});

/* Survival (unver√§ndert) */
const survRoot=document.getElementById('survRoot'); let survLives=3,survScore=0;
function hearts(){document.getElementById('heartPill').textContent='‚ù§Ô∏è'.repeat(Math.max(0,survLives));}
function score(){document.getElementById('scorePill').textContent=survScore;}
function startSurv(){ const pool=applyFilters(state.items,{byRole:true,roleOverride:roleSurv.value}); if(!pool.length){survRoot.innerHTML='<div class="card">Keine Zeilen f√ºr die aktuelle Auswahl.</div>';return;} survLives=3;survScore=0;hearts();score(); nextQ(pool); }
function nextQ(pool){
  if(survLives<=0){ gameOver(); return; }
  survRoot.innerHTML=''; const card=el('div',{class:'card'}); const line=pool[Math.floor(Math.random()*pool.length)];
  const fullSeq=applyFilters(state.items,{byRole:false}); const {prev}=getContextForLine(line,fullSeq,norm(roleSurv.value||''),true); if(prev) card.appendChild(el('div',{class:'faded'},`${prev.speaker}: ${prev.text}`));
  const correct=line.text; const wrongs=pool.filter(l=>l!==line).sort(()=>.5-Math.random()).slice(0,2).map(l=>l.text); const opts=[correct,...wrongs].sort(()=>.5-Math.random());
  card.appendChild(el('div',{class:'big'},`${line.speaker}: ‚Ä¶`));
  const box=el('div',{style:'display:grid;gap:.6rem;margin-top:.6rem'});
  opts.forEach(o=>{const b=el('button',{},o); b.onclick=()=>{ if(o===correct){survScore++;score();confetti({particleCount:28,spread:60});} else {survLives--;hearts();} nextQ(pool); }; box.appendChild(b);});
  card.appendChild(box); survRoot.appendChild(card);
}
function gameOver(){ survRoot.innerHTML=''; survRoot.appendChild(el('div',{class:'card big'},`Game Over! Score: ${survScore}`)); saveScore(survScore); }
document.getElementById('startSurv').onclick=startSurv;

/* Leaderboard (simple GUN demo) */
const gun=Gun(['https://gun-manhattan.herokuapp.com/gun']); const board=gun.get('horrorladen-scores'); const boardDiv=document.getElementById('board'); const boardInfo=document.getElementById('boardInfo');
function saveScore(score){ const name=(localStorage.getItem(LS.name)||'Anon'); const role=roleSurv.value; board.set({name,role,score,time:Date.now()}); renderBoardAuto(); }
function renderBoardAuto(){ const list=[]; board.map().once(d=>{ if(d) list.push(d); renderBoard(list); }); }
function renderBoard(list){ list.sort((a,b)=>b.score-a.score); boardDiv.innerHTML=''; const now=new Date(); boardInfo.textContent=`${list.length} Eintr√§ge, zuletzt: ${now.toLocaleTimeString()}`; list.forEach((r,i)=>boardDiv.appendChild(el('div',{class:'row',style:'display:flex;justify-content:space-between;align-items:center;margin:.3rem 0'},`${i+1}. ${r.name||'Anon'} ${r.role?`(${r.role})`:''}`,el('strong',{},r.score??0)))); }

/* Settings */
const playerName=document.getElementById('playerName'); const saveSettings=document.getElementById('saveSettings');
const scriptSelect=document.getElementById('scriptSelect'); const manualToggle=document.getElementById('manualToggle'); const scriptInput=document.getElementById('scriptInput'); const loadScriptBtn=document.getElementById('loadScriptBtn'); const discHint=document.getElementById('discHint');
playerName.value=localStorage.getItem(LS.name)||''; saveSettings.onclick=()=>localStorage.setItem(LS.name,playerName.value.trim()||'Anon');

manualToggle.onchange=()=>{scriptInput.style.display=manualToggle.checked?'':'none';};
loadScriptBtn.onclick=()=>{ const manual=manualToggle.checked; const chosen=manual?(scriptInput.value||'').trim():scriptSelect.value; if(!chosen)return; localStorage.setItem(LS.src,chosen); jsonSrc=chosen; jsonLabel.textContent=jsonSrc; loadJSON(); };

async function discoverJsonFiles(){
  discHint.textContent='Suche JSONs im Repo ‚Ä¶';
  const found=new Set([jsonSrc]); // immer aktuelle Quelle
  try{
    const host=location.hostname; const user=host.split('.')[0]; const repo=location.pathname.split('/')[1] || (user+'.github.io');
    const base=`https://api.github.com/repos/${user}/${repo}/contents`; const paths=['','/data','/scripts'];
    for(const p of paths){ const r=await fetch(base+p,{headers:{Accept:'application/vnd.github.v3+json'}}); if(!r.ok) continue; const arr=await r.json(); (arr||[]).forEach(e=>{ if(e && /\.json$/i.test(e.name)) found.add((p?p+'/':'')+e.name); }); }
    discHint.textContent=found.size?'Gefundene JSON-Dateien im Repo.':'Keine JSONs per API gefunden.';
  }catch{ discHint.textContent='Konnte Repo-Dateien nicht abrufen (evtl. privat). ‚ÄûManuell eingeben‚Äú nutzen.' }
  ['horrorladen_final_with_acts.json','data.json','script.json','scripts.json'].forEach(n=>found.add(n));
  const list=[...found].sort((a,b)=>a.localeCompare(b)); scriptSelect.innerHTML=list.map(v=>`<option value="${v}">${v}</option>`).join(''); if(list.includes(jsonSrc)) scriptSelect.value=jsonSrc;
}
discoverJsonFiles();

/* mobile zoom blocken & init */
(function(){ ['gesturestart','gesturechange','gestureend'].forEach(evt=>document.addEventListener(evt,e=>e.preventDefault(),{passive:false}));
  document.addEventListener('touchmove',e=>{ if(typeof e.scale==='number' && e.scale!==1) e.preventDefault(); },{passive:false});
})();
function boot(){ switchViewImmediate('home'); loadJSON(); }
document.readyState==='loading'?document.addEventListener('DOMContentLoaded',boot):boot();
</script>
</body>
</html>
