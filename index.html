<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Horrorladen ‚Äì Line Coach</title>
<meta name="theme-color" content="#0b0f17">
<style>
:root{
  --bg:#0b0f17; --fg:#e9ecf3; --muted:#a9b3c5; --card:#121826; --card2:#0f1522;
  --line:#1e2840; --brand:#6ea8ff; --ok:#58e39e; --warn:#ffd166; --cut:#66ff66;
  --shadow:0 12px 30px rgba(0,0,0,.35); --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--fg);
  background:
    radial-gradient(1000px 500px at 10% -10%, #2a2c7a40, transparent),
    radial-gradient(900px 400px at 110% 0%, #7a2a7a40, transparent),
    radial-gradient(900px 500px at 50% 120%, #1b7a7a30, transparent),
    var(--bg);}
a{color:inherit}
button{font:inherit}
.hidden{display:none!important}
header{
  position:sticky; top:0; z-index:20; backdrop-filter:saturate(120%) blur(14px);
  background:linear-gradient(180deg, #0c0f17eb, #0c0f1700); border-bottom:1px solid #ffffff14;
}
.topbar{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
#backBtn{border:none;background:transparent;color:var(--fg);opacity:.8;padding:6px 8px;border-radius:10px}
#backBtn:active{transform:scale(.98)}
h1{margin:0;font-weight:700;font-size:1.05rem;letter-spacing:.25px}
.main{max-width:1100px;margin:14px auto;padding:0 16px 80px;display:grid;gap:14px}
.card{background:var(--card); border:1px solid #ffffff18; border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media (max-width:860px){ .grid-4{grid-template-columns:repeat(2,minmax(0,1fr))} .grid-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:520px){ .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}
h2{margin:0 0 8px 0;font-size:1.05rem}
h3{margin:.6rem 0 .3rem 0;font-size:.95rem;color:#d6ddff}
.small{font-size:.85rem;color:var(--muted)}
select,input[type="range"],input[type="text"]{
  width:100%;padding:10px 12px;border-radius:12px;border:1px solid #ffffff24;background:var(--card2);color:var(--fg);
}
label{font-size:.85rem;color:var(--muted)}
.btn{
  border:none;border-radius:12px;padding:11px 14px;font-weight:600;cursor:pointer;
  color:#08121f;background:var(--brand); box-shadow:0 10px 26px rgba(110,168,255,.25);
}
.btn.secondary{background:#9bb8ff;color:#071425}
.btn.ghost{background:transparent;color:var(--fg);border:1px solid #ffffff30}
.btn.block{width:100%}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#00000033;padding:2px 6px;border-radius:6px;border:1px solid #ffffff22}
.list{display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto}
.item{border:1px solid #ffffff18;background:#ffffff08;border-radius:14px;padding:10px}
.badge{background:#ffffff14;border:1px solid #ffffff26;border-radius:999px;padding:5px 10px;color:#cdd7ef;font-size:.8rem}
.pill{background:#ffffff10;border:1px solid #ffffff1f;border-radius:999px;padding:6px 9px}
.status.keep{outline:2px solid var(--ok)}
.status.optional{outline:2px solid var(--warn)}
.status.cut{outline:2px solid var(--cut);opacity:.7}
.line{font-size:1.12rem;line-height:1.6}
.cue{background:var(--card2);border:1px dashed #ffffff22;padding:12px;border-radius:12px}
.spk{font-weight:700;text-transform:uppercase;font-size:.8rem;color:#aecdff;margin-bottom:4px}
.hearts{display:flex;gap:6px}
.heart{width:20px;height:20px}
.progressRow{display:flex;align-items:center;justify-content:space-between;margin-top:6px;gap:10px}
.bottomnav{
  position:fixed; left:0; right:0; bottom:0; z-index:30; display:flex; gap:10px; padding:10px;
  background:linear-gradient(0deg, #0c0f17f0, #0c0f1700); backdrop-filter:blur(14px);
}
.tabbtn{flex:1;border:1px solid #ffffff20;background:#ffffff10;color:#dfe7ff;border-radius:12px;padding:10px 6px;display:flex;gap:8px;justify-content:center;align-items:center}
.tabbtn.active{background:var(--brand);color:#08121f}
.center{display:flex;justify-content:center;align-items:center}
.icon{width:18px;height:18px}
.sep{height:1px;background:#ffffff18;margin:8px 0}
.toast{position:fixed;left:50%;bottom:82px;transform:translateX(-50%);background:#1c2333;border:1px solid #ffffff20;padding:8px 12px;border-radius:12px;opacity:0;transition:.3s}
.toast.show{opacity:1}
</style>
</head>
<body>

<header>
  <div class="topbar">
    <button id="backBtn" aria-label="Zur√ºck" class="hidden">‚óÄÔ∏é</button>
    <h1 id="title">Hauptmen√º</h1>
    <span class="badge" style="margin-left:auto">Auto-Load</span>
  </div>
</header>

<main class="main">

  <!-- PAGE: HOME -->
  <section id="page-home" class="grid grid-2">
    <div class="card">
      <h2>Text lernen</h2>
      <p class="small">W√§hle deinen Charakter & Szene, dann Lernmodus (Flashcards, Zusammenhang, Tippen).</p>
      <div class="row"><button class="btn" id="goTextSetup">Los geht‚Äôs</button></div>
    </div>
    <div class="card">
      <h2>Songs lernen</h2>
      <p class="small">Song/Charakter ausw√§hlen, Text ansehen und √ºben.</p>
      <div class="row"><button class="btn" id="goSongSetup">Song-Training</button></div>
    </div>
    <div class="card">
      <h2>Skript-Browser</h2>
      <p class="small">Szenen & Songs durchst√∂bern, Zeilen antippen, um zu springen.</p>
      <div class="row"><button class="btn secondary" id="goBrowser">√ñffnen</button></div>
    </div>
    <div class="card">
      <h2>Datenquelle</h2>
      <p class="small">Standard: <code>horrorladen_script.json</code>. Oder andere URL setzen.</p>
      <div class="row" style="gap:8px">
        <button class="btn ghost" id="setDataUrl">Daten-URL</button>
        <button class="btn ghost" id="reloadData">Neu laden</button>
      </div>
    </div>
  </section>

  <!-- PAGE: TEXT SETUP -->
  <section id="page-text-setup" class="hidden grid grid-2">
    <div class="card">
      <h2>1) Charakter</h2>
      <label for="roleSel">Meine Rolle</label>
      <select id="roleSel"></select>
      <div class="sep"></div>
      <label class="row" style="gap:8px"><input type="checkbox" id="includeAlle" checked> <span>‚ÄûALLE‚Äú z√§hlt f√ºr mich</span></label>
    </div>
    <div class="card">
      <h2>2) Szene</h2>
      <label for="sceneSel">Szene</label>
      <select id="sceneSel"></select>
      <div class="sep"></div>
      <label class="row" style="gap:8px"><input type="checkbox" id="hideCuts" checked> <span>gr√ºne Striche (cut) ausblenden</span></label>
      <label class="row" style="gap:8px"><input type="checkbox" id="includeOpt" checked> <span>optionale (gelb/orange) einbeziehen</span></label>
    </div>
    <div class="card">
      <h2>3) Modus</h2>
      <div class="grid grid-3">
        <button class="btn block" id="modeFlash">Flashcards</button>
        <button class="btn block" id="modeContext">Zusammenhang</button>
        <button class="btn block" id="modeType">Tippen & Pr√ºfen</button>
      </div>
      <p class="small" style="margin-top:6px">Du kannst jederzeit wischen: <span class="kbd">‚Üê</span>/<span class="kbd">‚Üí</span> oder **Swipe**.</p>
    </div>
  </section>

  <!-- PAGE: TEXT SESSION -->
  <section id="page-text-session" class="hidden grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <span class="pill" id="sessionScenePill">Szene</span>
          <span class="pill" id="sessionRolePill">Rolle</span>
        </div>
        <div class="hearts" id="hearts"></div>
      </div>

      <div id="contextBox" class="grid"></div>

      <div class="cue" id="promptBox">
        <div class="spk" id="promptSpeaker">‚Äì</div>
        <div class="small" id="promptHint">Deine Zeile</div>
      </div>

      <div id="answerArea" class="grid" style="margin-top:8px">
        <div id="revealArea" class="row">
          <button class="btn secondary" id="revealBtn">Zeile anzeigen</button>
          <button class="btn ghost" id="wrongBtn">Falsch</button>
          <button class="btn" id="rightBtn">Richtig</button>
        </div>
        <div id="typeArea" class="hidden">
          <input id="typeInput" type="text" placeholder="Tippe die Zeile (Gro√ü/Klein egal)">
          <div class="row" style="gap:8px">
            <button class="btn" id="checkBtn">Pr√ºfen</button>
            <button class="btn ghost" id="skipBtn">√úberspringen</button>
            <button class="btn secondary" id="hintBtn">Hinweis</button>
          </div>
          <div class="small" id="feedback"></div>
        </div>
      </div>

      <div id="revealText" class="hidden" style="margin-top:10px">
        <div class="line" id="revealLine"></div>
      </div>

      <div class="progressRow">
        <div class="small" id="stepInfo">0 / 0</div>
        <div class="row" style="gap:8px">
          <button class="btn ghost" id="prevBtn">Zur√ºck</button>
          <button class="btn" id="nextBtn">Weiter</button>
        </div>
      </div>
    </div>
  </section>

  <!-- PAGE: SONG SETUP -->
  <section id="page-song-setup" class="hidden grid grid-2">
    <div class="card">
      <h2>1) Charakter</h2>
      <select id="songRoleSel"></select>
      <div class="small">‚ÄûALLE‚Äú z√§hlt optional per Schalter unten.</div>
      <label class="row" style="gap:8px;margin-top:6px"><input type="checkbox" id="songIncludeAlle" checked> <span>‚ÄûALLE‚Äú z√§hlt f√ºr mich</span></label>
    </div>
    <div class="card">
      <h2>2) Song</h2>
      <select id="songSel"></select>
      <div class="sep"></div>
      <div class="row" style="gap:8px">
        <button class="btn" id="startSongBtn">Song anzeigen</button>
      </div>
    </div>
  </section>

  <!-- PAGE: SONG SESSION -->
  <section id="page-song-session" class="hidden grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <span class="pill" id="songTitlePill">Song</span>
          <span class="pill" id="songRolePill">Rolle</span>
        </div>
        <div class="row" style="gap:6px">
          <button class="btn ghost" id="songRevealAll">Alles zeigen</button>
          <button class="btn ghost" id="songHideAll">Alles verbergen</button>
        </div>
      </div>
      <div id="songLines" class="list"></div>
    </div>
  </section>

 <!-- PAGE: BROWSER (neu) -->
  <section id="page-browser" class="hidden grid grid-2">
    <div class="card">
      <h2>Szenen</h2>
      <div id="sceneList" class="list"></div>
    </div>
    <div class="card">
      <h2>Songs</h2>
      <div id="songList" class="list"></div>
    </div>
  </section>

    <!-- PAGE: EDITOR -->
  <section id="page-editor" class="hidden grid grid-2">
    <div class="card">
      <h2>Editor</h2>
      <div class="grid">
        <div>
          <label>Ansicht</label>
          <select id="edView">
            <option value="dialogue">Dialog-Szenen</option>
            <option value="songs">Songs</option>
          </select>
        </div>
        <div id="edSceneWrap">
          <label>Szene</label>
          <select id="edSceneSel"></select>
        </div>
        <div id="edSongWrap" class="hidden">
          <label>Song</label>
          <select id="edSongSel"></select>
        </div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btn ghost" id="edSelectAll">Alle markieren</button>
          <button class="btn ghost" id="edClearSel">Markierung l√∂schen</button>
          <span class="small">Markierte Zeilen ‚Üí Status setzen:</span>
          <button class="btn secondary" id="edSetKeep">keep</button>
          <button class="btn secondary" id="edSetOptional">optional</button>
          <button class="btn secondary" id="edSetCut">cut</button>
        </div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btn" id="edExportJson">Export JSON</button>
          <button class="btn ghost" id="edSaveLocal">Speichern (Local)</button>
          <button class="btn ghost" id="edReload">Neu laden</button>
        </div>
      </div>
    </div>
    <div class="card">
      <h2 id="edTitle">Zeilen</h2>
      <div class="small">Tipp: Mehrfachauswahl am Desktop mit <span class="kbd">Shift</span>/<span class="kbd">Ctrl</span>. Auf dem Handy Zeilen einfach nacheinander antippen.</div>
      <div id="edList" class="list" style="margin-top:8px"></div>
    </div>
  </section>


</main>

<!-- Bottom Nav -->
<nav class="bottomnav">
  <button class="tabbtn active" data-tab="home">üè† <span>Home</span></button>
  <button class="tabbtn" data-tab="text">üó£Ô∏è <span>Text</span></button>
  <button class="tabbtn" data-tab="songs">üéµ <span>Songs</span></button>
  <button class="tabbtn" data-tab="editor">‚úèÔ∏è <span>Editor</span></button>
</nav>

<div id="toast" class="toast">Gespeichert</div>

<script>
/* ---------------------- State + Storage ---------------------- */
const STORAGE_KEY = 'hlc_state_v3';
const state = loadState();
function loadState(){
  try{
    const base = {
      meta:{hearts:3, xp:0},
      prefs:{
        role:'', includeAlle:true, sceneId:'', hideCuts:true, includeOpt:true,
        mode:'flash', // flash | context | type
        songRole:'', songId:'', songIncludeAlle:true
      },
      data:{ roles:[], scenes:[], songs:[] },
      ui:{ page:'home' }
    };
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? deepMerge(base, JSON.parse(raw)) : base;
  }catch{ return {meta:{hearts:3,xp:0},prefs:{},data:{roles:[],scenes:[],songs:[]},ui:{page:'home'}}; }
}
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); showToast('Gespeichert'); }
function deepMerge(a,b){ for(const k in b){ if(Array.isArray(b[k])) a[k]=b[k]; else if(b[k] && typeof b[k]==='object') a[k]=deepMerge(a[k]||{}, b[k]); else a[k]=b[k]; } return a; }

/* ---------------------- Router / Pages ----------------------- */
const titleEl = document.getElementById('title');
const backBtn = document.getElementById('backBtn');
const pages = {
  home:     document.getElementById('page-home'),
  textSetup:document.getElementById('page-text-setup'),
  textSess: document.getElementById('page-text-session'),
  songSetup:document.getElementById('page-song-setup'),
  songSess: document.getElementById('page-song-session'),
  browser:  document.getElementById('page-browser'),
  editor:   document.getElementById('page-editor')
};
const tabbtns = Array.from(document.querySelectorAll('.tabbtn'));
function show(page){
  state.ui.page = page; saveSilently();
  for(const k in pages){ pages[k].classList.toggle('hidden', k!==page); }
  backBtn.classList.toggle('hidden', page==='home');
  titleEl.textContent = ({
  home:'Hauptmen√º',
  textSetup:'Text lernen',
  textSess:'Training',
  songSetup:'Songs lernen',
  songSess:'Song',
  browser:'Skript-Browser',
  editor:'Editor'
})[page] || 'Horrorladen';
  tabbtns.forEach(b=> b.classList.toggle('active',
    (page==='home' && b.dataset.tab==='home') ||
    ((page==='textSetup'||page==='textSess') && b.dataset.tab==='text') ||
    ((page==='songSetup'||page==='songSess') && b.dataset.tab==='songs')
    ((page==='editor') && b.dataset.tab==='editor')));
}
function saveSilently(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
backBtn.addEventListener('click', ()=>{ if(state.ui.page==='textSess') show('textSetup'); else if(state.ui.page==='songSess') show('songSetup'); else show('home'); });
tabbtns.forEach(b=> b.addEventListener('click', ()=>{
  const t=b.dataset.tab;
  if(t==='home')  show('home');
  if(t==='text')  show('textSetup');
  if(t==='songs') show('songSetup');
  if(t==='editor'){ buildEditor(); show('editor'); }
}));

/* ---------------------- Data Loading ------------------------- */
async function loadData(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  const j = await res.json();
  // Accept both top-level songs[] and scenes with type: "song"
  const roles = j.roles||[];
  const scenes = Array.isArray(j.scenes)? j.scenes.filter(s=>Array.isArray(s.lines)) : [];
  let songs = Array.isArray(j.songs)? j.songs.filter(s=>Array.isArray(s.lines)) : [];
  const songScenes = scenes.filter(s=> (s.type||'').toLowerCase()==='song');
  if(songScenes.length && !songs.length){
    songs = songScenes.map(s=>({id:s.id||('song-'+s.name), title:s.name.replace(/^Lied:\s*/i,''), status:'keep', lines:s.lines}));
  }
  state.data.roles = roles;
  state.data.scenes = scenes.filter(s=> (s.type||'dialogue').toLowerCase()!=='song'); // dialogue only for scene list
  state.data.songs  = songs;
  // Defaults
  if(!state.prefs.role && roles[0]) state.prefs.role = roles[0];
  if(!state.prefs.songRole && roles[0]) state.prefs.songRole = roles[0];
  if(!state.prefs.sceneId && state.data.scenes[0]) state.prefs.sceneId = state.data.scenes[0].id;
  if(!state.prefs.songId && state.data.songs[0]) state.prefs.songId = state.data.songs[0].id;
  saveSilently();
  populateTextSetup(); populateSongSetup(); buildBrowser();
}
function detectDataUrl(){
  const qs = new URLSearchParams(location.search);
  return qs.get('data') || 'horrorladen_script.json';
}
async function initLoad(){
  const url = detectDataUrl() || 'horrorladen_script.json';
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status+' '+res.statusText);
    const j = await res.json();
    if(!Array.isArray(j.roles) || !Array.isArray(j.scenes) || !Array.isArray(j.songs)){
      throw new Error('JSON-Struktur unvollst√§ndig (roles/scenes/songs)');
    }
    state.data.roles  = j.roles;
    state.data.scenes = (j.scenes||[]).filter(s=>Array.isArray(s.lines));
    state.data.songs  = (j.songs||[]).filter(s=>Array.isArray(s.lines));
    if(!state.prefs.role && state.data.roles[0]) state.prefs.role = state.data.roles[0];
    if(!state.prefs.songRole && state.data.roles[0]) state.prefs.songRole = state.data.roles[0];
    if(!state.prefs.sceneId && state.data.scenes[0]) state.prefs.sceneId = state.data.scenes[0].id;
    if(!state.prefs.songId && state.data.songs[0]) state.prefs.songId = state.data.songs[0].id;
    saveSilently();
    populateTextSetup(); populateSongSetup(); buildBrowser(); buildEditor();
    toastOK('Script geladen: '+url);
  }catch(e){
    showLoadError('Konnte Script nicht laden: '+e.message+'\nURL: '+url);
    console.error('[auto-load]', e);
  }
}

/* ---------------------- UI: Text Setup ----------------------- */
const roleSel = document.getElementById('roleSel');
const includeAlle = document.getElementById('includeAlle');
const sceneSel = document.getElementById('sceneSel');
const hideCuts = document.getElementById('hideCuts');
const includeOpt = document.getElementById('includeOpt');
const goTextSetup = document.getElementById('goTextSetup');
const modeFlash = document.getElementById('modeFlash');
const modeContext = document.getElementById('modeContext');
const modeType = document.getElementById('modeType');

goTextSetup.addEventListener('click', ()=> show('textSetup'));
modeFlash.addEventListener('click', ()=>{ state.prefs.mode='flash'; startSession(); });
modeContext.addEventListener('click', ()=>{ state.prefs.mode='context'; startSession(); });
modeType.addEventListener('click', ()=>{ state.prefs.mode='type'; startSession(); });

function populateTextSetup(){
  roleSel.innerHTML = state.data.roles.map(r=>`<option ${r===state.prefs.role?'selected':''}>${r}</option>`).join('');
  sceneSel.innerHTML = state.data.scenes.map(s=>`<option value="${s.id}" ${s.id===state.prefs.sceneId?'selected':''}>${s.name}</option>`).join('');
  includeAlle.checked = !!state.prefs.includeAlle;
  hideCuts.checked = !!state.prefs.hideCuts;
  includeOpt.checked = !!state.prefs.includeOpt;
}

roleSel.addEventListener('change', ()=>{ state.prefs.role = roleSel.value; saveSilently(); });
sceneSel.addEventListener('change', ()=>{ state.prefs.sceneId = sceneSel.value; saveSilently(); });
includeAlle.addEventListener('change', ()=>{ state.prefs.includeAlle = includeAlle.checked; saveSilently(); });
hideCuts.addEventListener('change', ()=>{ state.prefs.hideCuts = hideCuts.checked; saveSilently(); });
includeOpt.addEventListener('change', ()=>{ state.prefs.includeOpt = includeOpt.checked; saveSilently(); });

/* ---------------------- UI: Song Setup ----------------------- */
const goSongSetup = document.getElementById('goSongSetup');
const songRoleSel = document.getElementById('songRoleSel');
const songSel = document.getElementById('songSel');
const songIncludeAlle = document.getElementById('songIncludeAlle');
const startSongBtn = document.getElementById('startSongBtn');

goSongSetup.addEventListener('click', ()=> show('songSetup'));
startSongBtn.addEventListener('click', ()=> showSong());

function populateSongSetup(){
  songRoleSel.innerHTML = state.data.roles.map(r=>`<option ${r===state.prefs.songRole?'selected':''}>${r}</option>`).join('');
  songSel.innerHTML = state.data.songs.map(s=>`<option value="${s.id}" ${s.id===state.prefs.songId?'selected':''}>${s.title||s.name||s.id}</option>`).join('');
  songIncludeAlle.checked = !!state.prefs.songIncludeAlle;
}
songRoleSel.addEventListener('change', ()=>{ state.prefs.songRole = songRoleSel.value; saveSilently(); });
songSel.addEventListener('change', ()=>{ state.prefs.songId = songSel.value; saveSilently(); });
songIncludeAlle.addEventListener('change', ()=>{ state.prefs.songIncludeAlle = songIncludeAlle.checked; saveSilently(); });

/* ---------------------- Browser ------------------------------- */
const sceneList = document.getElementById('sceneList');
const songList = document.getElementById('songList');
const goBrowser = document.getElementById('goBrowser');
goBrowser.addEventListener('click', ()=> show('browser'));

function buildBrowser(){
  sceneList.innerHTML = '';
  state.data.scenes.forEach(s=>{
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `<div class="row" style="justify-content:space-between"><b>${s.name}</b><span class="small">${s.lines.length} Zeilen</span></div>`;
    div.addEventListener('click', ()=>{ state.prefs.sceneId = s.id; show('textSetup'); populateTextSetup(); });
    sceneList.appendChild(div);
  });
  songList.innerHTML = '';
  state.data.songs.forEach(s=>{
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = `<div class="row" style="justify-content:space-between"><b>üéµ ${s.title||s.name||s.id}</b><span class="small">${(s.lines||[]).length} Zeilen</span></div>`;
    div.addEventListener('click', ()=>{ state.prefs.songId = s.id; show('songSetup'); populateSongSetup(); });
    songList.appendChild(div);
  });
}

/* ---------------------- Session (Text) ------------------------ */
const heartsBox = document.getElementById('hearts');
const sessionScenePill = document.getElementById('sessionScenePill');
const sessionRolePill = document.getElementById('sessionRolePill');
const contextBox = document.getElementById('contextBox');
const promptSpeaker = document.getElementById('promptSpeaker');
const promptHint = document.getElementById('promptHint');
const revealBtn = document.getElementById('revealBtn');
const wrongBtn = document.getElementById('wrongBtn');
const rightBtn = document.getElementById('rightBtn');
const revealArea = document.getElementById('revealArea');
const typeArea = document.getElementById('typeArea');
const typeInput = document.getElementById('typeInput'); const checkBtn = document.getElementById('checkBtn'); const hintBtn = document.getElementById('hintBtn'); const feedback = document.getElementById('feedback'); const skipBtn = document.getElementById('skipBtn');
const revealText = document.getElementById('revealText'); const revealLine = document.getElementById('revealLine');
const stepInfo = document.getElementById('stepInfo');
const prevBtn = document.getElementById('prevBtn'); const nextBtn = document.getElementById('nextBtn');

let session = { lines:[], idx:0, hearts:3, mode:'flash' };

function startSession(){
  const role = state.prefs.role;
  const scene = state.data.scenes.find(s=>s.id===state.prefs.sceneId);
  if(!scene){ alert('Keine Szene gefunden.'); return; }
  session.mode = state.prefs.mode;
  session.hearts = 3;
  session.lines = filterLinesForSession(scene.lines, role, state.prefs.includeAlle, state.prefs.hideCuts, state.prefs.includeOpt);
  session.idx = 0;
  sessionScenePill.textContent = scene.name;
  sessionRolePill.textContent = role;
  heartsBox.innerHTML = heartsSvg(session.hearts);
  revealText.classList.add('hidden');
  typeArea.classList.toggle('hidden', session.mode!=='type');
  revealArea.classList.toggle('hidden', session.mode==='type');
  show('textSess');
  renderStep();
}

function filterLinesForSession(lines, role, includeAlle, hideCuts, includeOpt){
  return (lines||[]).filter(l=>{
    if(hideCuts && l.status==='cut') return false;
    if(!includeOpt && l.status==='optional') return false;
    const isMine = (l.speaker===role) || (includeAlle && l.speaker==='ALLE');
    const inContextMode = state.prefs.mode==='context';
    return inContextMode ? true : isMine; // in Kontextmodus zeigen wir alle, fragen aber n√§chste Zeile
  });
}

function renderStep(){
  const n = session.lines.length;
  if(n===0){ promptHint.textContent='Keine Zeilen nach Filter.'; promptSpeaker.textContent='‚Äî'; stepInfo.textContent='0/0'; return; }
  if(session.idx>=n) { session.idx=n-1; }
  const l = session.lines[session.idx];
  const ctx = Math.max(0, Math.min(2, session.idx)); // 2 Zeilen Kontext
  contextBox.innerHTML = '';
  for(let i=Math.max(0, session.idx-ctx); i<session.idx; i++){
    const c = session.lines[i];
    contextBox.innerHTML += `<div class="cue"><div class="spk">${c.speaker}</div><div class="line">${escapeHtml(c.text)}</div></div>`;
  }
  // Prompt
  if(session.mode==='context'){
    // Frage: N√§chste Zeile (unabh√§ngig von Sprecher)
    promptSpeaker.textContent = (session.idx+1<n) ? (session.lines[session.idx+1].speaker + ' ‚Äì N√§chste Zeile?') : 'Ende der Szene';
    promptHint.textContent = 'Erinnere die n√§chste Zeile';
  }else if(session.mode==='type'){
    promptSpeaker.textContent = `${l.speaker}`;
    promptHint.textContent = 'Tippe deine Zeile';
    typeInput.value='';
    feedback.textContent='';
  }else{
    promptSpeaker.textContent = `${l.speaker}`;
    promptHint.textContent = 'Deine Zeile';
  }
  stepInfo.textContent = `${session.idx+1} / ${n}`;
  revealText.classList.add('hidden');
  revealLine.textContent = '';
}

// Controls
revealBtn.addEventListener('click', ()=>{
  const l = session.lines[session.idx];
  revealLine.textContent = l.text; revealText.classList.remove('hidden');
});
wrongBtn.addEventListener('click', ()=>{ session.hearts=Math.max(0,session.hearts-1); heartsBox.innerHTML = heartsSvg(session.hearts); if(session.hearts===0){ alert('üíî Keine Herzen mehr ‚Äì Runde vorbei.'); show('textSetup'); return; } nextStep(); });
rightBtn.addEventListener('click', ()=>{ state.meta.xp += 8; saveSilently(); nextStep(); });

checkBtn.addEventListener('click', ()=>{
  const l = (session.mode==='context' && session.lines[session.idx+1]) ? session.lines[session.idx+1] : session.lines[session.idx];
  const ok = similarEnough(typeInput.value, l.text);
  feedback.textContent = ok ? '‚úÖ Richtig!' : '‚ùå Nicht ganz.';
  if(ok){ state.meta.xp += 10; saveSilently(); setTimeout(nextStep, 300); }
  else { session.hearts=Math.max(0,session.hearts-1); heartsBox.innerHTML = heartsSvg(session.hearts); if(session.hearts===0){ alert('üíî Keine Herzen mehr ‚Äì Runde vorbei.'); show('textSetup'); } }
});
hintBtn.addEventListener('click', ()=>{
  const l = (session.mode==='context' && session.lines[session.idx+1]) ? session.lines[session.idx+1] : session.lines[session.idx];
  feedback.textContent = 'Hinweis: ' + firstNCharsHint(l.text, typeInput.value);
});
skipBtn.addEventListener('click', nextStep);
prevBtn.addEventListener('click', prevStep);
nextBtn.addEventListener('click', nextStep);

function prevStep(){ session.idx = Math.max(0, session.idx-1); renderStep(); }
function nextStep(){ session.idx = Math.min(session.lines.length, session.idx+1); renderStep(); }

/* ---------------------- Song Session -------------------------- */
const songTitlePill = document.getElementById('songTitlePill');
const songRolePill  = document.getElementById('songRolePill');
const songLinesBox  = document.getElementById('songLines');
const songRevealAll = document.getElementById('songRevealAll');
const songHideAll   = document.getElementById('songHideAll');

function showSong(){
  const role = state.prefs.songRole;
  const song = state.data.songs.find(s=>s.id===state.prefs.songId);
  if(!song){ alert('Kein Song gefunden.'); return; }
  songTitlePill.textContent = song.title || song.name || song.id;
  songRolePill.textContent = role;
  songLinesBox.innerHTML = '';
  (song.lines||[]).forEach((l,i)=>{
    const hide = (l.status==='cut'); // geschnittene default aus
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `<div class="small">${l.speaker||'ENSEMBLE'}</div>
      <div class="line ${hide?'hidden':''}" data-i="${i}">${escapeHtml(l.text)}</div>`;
    row.addEventListener('click', ()=>{
      const el = row.querySelector('.line');
      el.classList.toggle('hidden');
    });
    songLinesBox.appendChild(row);
  });
  show('songSess');
}
songRevealAll.addEventListener('click', ()=>{ songLinesBox.querySelectorAll('.line').forEach(e=>e.classList.remove('hidden')); });
songHideAll.addEventListener('click', ()=>{ songLinesBox.querySelectorAll('.line').forEach(e=>e.classList.add('hidden')); });

/* ---------------------- Editor ------------------------------- */
const edView = document.getElementById('edView');
const edSceneWrap = document.getElementById('edSceneWrap');
const edSongWrap  = document.getElementById('edSongWrap');
const edSceneSel  = document.getElementById('edSceneSel');
const edSongSel   = document.getElementById('edSongSel');
const edList      = document.getElementById('edList');
const edTitle     = document.getElementById('edTitle');
const edSelectAll = document.getElementById('edSelectAll');
const edClearSel  = document.getElementById('edClearSel');
const edSetKeep   = document.getElementById('edSetKeep');
const edSetOptional = document.getElementById('edSetOptional');
const edSetCut    = document.getElementById('edSetCut');
const edExportJson= document.getElementById('edExportJson');
const edSaveLocal = document.getElementById('edSaveLocal');
const edReload    = document.getElementById('edReload');

let edSelection = new Set(); // indices of selected lines in current view

function buildEditor(){
  // populate selectors
  edSceneSel.innerHTML = state.data.scenes.map(s=>`<option value="${s.id}" ${s.id===state.prefs.sceneId?'selected':''}>${s.name}</option>`).join('');
  edSongSel.innerHTML  = state.data.songs.map(s=>`<option value="${s.id}" ${s.id===state.prefs.songId?'selected':''}>${s.title||s.name||s.id}</option>`).join('');
  // view
  edView.value = (state.ui.editorView || 'dialogue');
  edSceneWrap.classList.toggle('hidden', edView.value!=='dialogue');
  edSongWrap.classList.toggle('hidden', edView.value!=='songs');
  renderEdList();
}

function currentEdLines(){
  if(edView.value==='songs'){
    const s = state.data.songs.find(x=>x.id===edSongSel.value);
    return {kind:'song', obj:s, lines:(s?.lines||[])};
  }else{
    const s = state.data.scenes.find(x=>x.id===edSceneSel.value);
    return {kind:'scene', obj:s, lines:(s?.lines||[])};
  }
}

function renderEdList(){
  edSelection.clear();
  const {kind, obj, lines} = currentEdLines();
  edTitle.textContent = (kind==='song' ? `üéµ ${obj?.title||obj?.name||obj?.id}` : (obj?.name||'Szene'));
  edList.innerHTML = '';
  lines.forEach((l,idx)=>{
    const item = document.createElement('div');
    item.className = 'item';
    item.dataset.idx = String(idx);
    item.innerHTML = `
      <div class="row" style="justify-content:space-between;gap:8px">
        <div><b>${l.speaker||'‚Äî'}</b> <span class="small">[${l.status||'keep'}]</span></div>
        <div class="row" style="gap:6px">
          <select class="edStatus">
            <option value="keep" ${l.status==='keep'?'selected':''}>keep</option>
            <option value="optional" ${l.status==='optional'?'selected':''}>optional</option>
            <option value="cut" ${l.status==='cut'?'selected':''}>cut</option>
          </select>
          <button class="btn ghost edSelBtn">Markieren</button>
        </div>
      </div>
      <div class="line" style="margin-top:6px">${escapeHtml(l.text||'')}</div>
    `;
    // events
    item.querySelector('.edSelBtn').addEventListener('click', ()=>{
      if(edSelection.has(idx)){ edSelection.delete(idx); item.style.outline=''; }
      else { edSelection.add(idx); item.style.outline='2px solid var(--brand)'; }
    });
    item.querySelector('.edStatus').addEventListener('change', (e)=>{
      l.status = e.target.value;
      saveSilently();
      item.querySelector('.small').textContent = `[${l.status}]`;
    });
    edList.appendChild(item);
  });
}

edView.addEventListener('change', ()=>{
  state.ui.editorView = edView.value; saveSilently();
  edSceneWrap.classList.toggle('hidden', edView.value!=='dialogue');
  edSongWrap.classList.toggle('hidden', edView.value!=='songs');
  renderEdList();
});
edSceneSel.addEventListener('change', ()=>{ state.prefs.sceneId = edSceneSel.value; saveSilently(); renderEdList(); });
edSongSel.addEventListener('change', ()=>{ state.prefs.songId = edSongSel.value; saveSilently(); renderEdList(); });

edSelectAll.addEventListener('click', ()=>{
  edSelection = new Set([...Array(currentEdLines().lines.length).keys()]);
  edList.querySelectorAll('.item').forEach(el=> el.style.outline='2px solid var(--brand)');
});
edClearSel.addEventListener('click', ()=>{
  edSelection.clear();
  edList.querySelectorAll('.item').forEach(el=> el.style.outline='');
});

function bulkSetStatus(status){
  const {lines} = currentEdLines();
  edSelection.forEach(idx=>{
    if(lines[idx]) lines[idx].status = status;
  });
  saveSilently();
  renderEdList();
}
edSetKeep.addEventListener('click', ()=> bulkSetStatus('keep'));
edSetOptional.addEventListener('click', ()=> bulkSetStatus('optional'));
edSetCut.addEventListener('click', ()=> bulkSetStatus('cut'));

edExportJson.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({title:state.data.title||'Horrorladen', roles:state.data.roles, scenes:state.data.scenes, songs:state.data.songs}, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'horrorladen_script_edited.json'; a.click();
  URL.revokeObjectURL(url);
});
edSaveLocal.addEventListener('click', ()=>{ save(); });
edReload.addEventListener('click', ()=>{ location.reload(); });


/* ---------------------- Gesten (Swipe) ------------------------ */
let touchStartX=null,touchStartY=null;
function onTouchStart(e){ const t=e.changedTouches[0]; touchStartX=t.clientX; touchStartY=t.clientY; }
function onTouchEnd(e){
  if(touchStartX==null) return;
  const t=e.changedTouches[0]; const dx=t.clientX - touchStartX; const dy=t.clientY - touchStartY;
  if(Math.abs(dx)>60 && Math.abs(dy)<50){
    if(dx<0){ // left
      if(state.ui.page==='textSess') nextStep();
    }else{ // right
      if(state.ui.page==='textSess') prevStep();
    }
  }
  touchStartX=touchStartY=null;
}
document.addEventListener('touchstart', onTouchStart, {passive:true});
document.addEventListener('touchend', onTouchEnd, {passive:true});
document.addEventListener('keydown', (e)=>{
  if(state.ui.page==='textSess'){
    if(e.key==='ArrowRight') nextStep();
    if(e.key==='ArrowLeft') prevStep();
    if(e.key===' ') { e.preventDefault(); const b=(state.prefs.mode==='type'?checkBtn:revealBtn); b?.click(); }
  }
});

/* ---------- Canon-Rollen + Varianten-Mapping ---------- */
const CANON_ROLES = [
  "SEYMOUR","AUDREY","MR. MUSHNIK","ORIN","PFLANZE","STIMME",
  "CRYSTAL","RONETTE","CHIFFON","SOULGIRLS",
  "PENNER 1","PENNER 2","KUNDE","PATIENT",
  "MRS. LUCE","MRS. BERNSTEIN","MR. MARTIN","ALLE"
];

// Schreibweisen-/Synonym-Varianten -> Canon
const ROLE_VARIANTS = new Map([
  ["SEYMOUR","SEYMOUR"],
  ["AUDREY","AUDREY"],
  ["MR. MUSHNIK","MR. MUSHNIK"],["MR MUSHNIK","MR. MUSHNIK"],["MUSHNIK","MR. MUSHNIK"],
  ["ORIN","ORIN"],
  ["DIE PFLANZE","PFLANZE"],["PFLANZE","PFLANZE"],["AUDREY II","PFLANZE"],["AUDREY 2","PFLANZE"],
  ["STIMME","STIMME"],["STIMME DER PFLANZE","STIMME"],
  ["CRYSTAL","CRYSTAL"],["RONETTE","RONETTE"],["CHIFFON","CHIFFON"],
  ["SOULGIRLS","SOULGIRLS"],["GIRLS","SOULGIRLS"],["DREAMGIRLS","SOULGIRLS"],
  ["PENNER 1","PENNER 1"],["PENNER1","PENNER 1"],["PENNER","PENNER 1"],
  ["PENNER 2","PENNER 2"],["PENNER2","PENNER 2"],
  ["KUNDE","KUNDE"],["PATIENT","PATIENT"],
  ["MRS. LUCE","MRS. LUCE"],["MRS LUCE","MRS. LUCE"],
  ["MRS. BERNSTEIN","MRS. BERNSTEIN"],["MRS BERNSTEIN","MRS. BERNSTEIN"],
  ["MR. MARTIN","MR. MARTIN"],["MR MARTIN","MR. MARTIN"],
  ["ALLE","ALLE"],["ENSEMBLE","ALLE"]
]);

function normRoleName(raw){
  const k = String(raw||"").replace(/\./g,'').replace(/\s+/g,' ').trim().toUpperCase();
  // Versuch exakte Variantenzuordnung
  for(const [v,canon] of ROLE_VARIANTS){
    const vv = v.replace(/\./g,'').toUpperCase();
    if(k===vv) return canon;
  }
  // sonst, wenn es exakt im Kanon steht (z. B. "MR. MUSHNIK"):
  if (CANON_ROLES.includes(String(raw||"").toUpperCase())) return String(raw||"").toUpperCase();
  return String(raw||"").toUpperCase();
}

function escapeReg(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

// Pr√ºft, ob Text mit einem Rollenlabel startet und gibt {speaker,text} zur√ºck
function extractPrefixedSpeaker(text){
  const t = String(text||'').trim();
  if(!t) return null;
  // l√§ngere Varianten zuerst (MR. MUSHNIK vor MUSHNIK)
  const variants = Array.from(ROLE_VARIANTS.keys()).sort((a,b)=> b.length - a.length);
  for(const v of variants){
    const re = new RegExp('^'+escapeReg(v)+'\\b\\s*(?:[:\\-‚Äì‚Äî])?\\s*(.*)$','i');
    const m = t.match(re);
    if(m){
      const canon = ROLE_VARIANTS.get(v) || normRoleName(v);
      const rest  = (m[1]||'').trim();
      return {speaker: canon, text: rest, labelOnly: rest.length===0};
    }
  }
  return null;
}

// Repariert Sprecher in einem Lines-Array
function fixLines(lines){
  const out = [];
  let carrySpeaker = null; // wenn vorher Zeile nur "SPEAKER" stand
  for(const L of (lines||[])){
    let sp   = String(L.speaker||'').trim();
    let text = String(L.text||'');
    const status = L.status || 'keep';

    // 1) Wenn "ALLE"/leer und Text beginnt mit Rollenlabel -> splitten
    if(!sp || sp.toUpperCase()==='ALLE'){
      const ex = extractPrefixedSpeaker(text);
      if(ex){
        if(ex.labelOnly){
          // reine Sprecherzeile (z. B. Zeilenumbruch danach): nur Speaker merken
          carrySpeaker = ex.speaker;
          continue; // nichts pushen
        }else{
          sp   = ex.speaker;
          text = ex.text;
        }
      }else if(carrySpeaker){ // 2) Vorheriges Label wirkt fort
        sp = carrySpeaker;
      }
    }

    // 3) existierenden Speaker normalisieren
    sp = normRoleName(sp);

    // 4) Carry fortschreiben (wenn echter Sprecher)
    if(sp && sp.toUpperCase()!=='ALLE') carrySpeaker = sp;

    out.push({speaker: sp || 'ALLE', text, status});
  }
  return out;
}

/* ---------------------- Utils -------------------------------- */
function heartsSvg(n){
  let html=''; for(let i=0;i<3;i++){
    const c = i<n ? '#ff6b6b' : '#3a4057';
    html += `<svg class="heart" viewBox="0 0 24 24"><path fill="${c}" d="M12 21s-6.716-4.727-9.428-7.44C.86 11.85.86 8.65 2.572 6.94c1.714-1.714 4.486-1.714 6.2 0L12 10.17l3.228-3.23c1.714-1.714 4.486-1.714 6.2 0 1.714 1.71 1.714 4.91 0 6.62C18.716 16.273 12 21 12 21z"/></svg>`;
  }
  return html;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
function normalize(s){ return (s||'').toLowerCase().replace(/[\s\n]+/g,' ').replace(/[.,!?:;‚Ä¶"'()\[\]¬´¬ª‚Äû‚Äú‚Äö‚Äô]/g,'').trim(); }
function levenshtein(a,b){ const m=a.length,n=b.length; if(!m)return n;if(!n)return m; const dp=new Array(n+1); for(let j=0;j<=n;j++) dp[j]=j; for(let i=1;i<=m;i++){ let prev=dp[0]; dp[0]=i; for(let j=1;j<=n;j++){ const tmp=dp[j]; dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev + (a[i-1]===b[j-1]?0:1)); prev=tmp; } } return dp[n]; }
function similarEnough(a,b){ const A=normalize(a), B=normalize(b); if(!A) return false; if(A===B) return true; const d=levenshtein(A,B); const maxLen=Math.max(A.length,B.length); return (1 - d/Math.max(1,maxLen)) >= .88; }
function firstNCharsHint(target, typed){ const T=normalize(target), U=normalize(typed); let i=0; while(i<Math.min(T.length,U.length)&&T[i]===U[i]) i++; return target.slice(0, Math.max(1,i+1)) + '‚Ä¶'; }
const toast = document.getElementById('toast'); let toastTimer=null;
function showToast(txt){ toast.textContent=txt; toast.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>toast.classList.remove('show'), 850); }
function showLoadError(msg){
  const box = document.getElementById('edList') || document.body;
  const div = document.createElement('div');
  div.style.cssText='padding:12px;border:1px solid #f55;border-radius:10px;background:#2a1010;color:#ffdede;margin:8px 0;white-space:pre-wrap';
  div.textContent = msg;
  box.prepend(div);
  alert(msg);
}
function toastOK(t){ showToast(t||'Geladen'); }


/* ---------------------- Data URL UI --------------------------- */
document.getElementById('setDataUrl').addEventListener('click', ()=>{
  const current = new URLSearchParams(location.search).get('data') || '';
  const u = prompt('Daten-URL eingeben (z.B. https://USERNAME.github.io/REPO/horrorladen_script.json)', current);
  if(u){ const url = new URL(location.href); url.searchParams.set('data', u.trim()); location.href = url.toString(); }
});
document.getElementById('reloadData').addEventListener('click', ()=> initLoad());

/* ---------------------- Start -------------------------------- */
document.getElementById('goTextSetup').addEventListener('click', ()=> show('textSetup'));
show(state.ui.page||'home');
initLoad();
</script>
</body>
</html>
