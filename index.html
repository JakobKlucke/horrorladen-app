<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Horrorladen ‚Äì Lernapp (Hub)</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --c-lapis:#22577a; --c-verdigris:#38a3a5; --c-emerald:#57cc99; --c-light:#80ed99; --c-tea:#c7f9cc;
      --bg:#0f172a; --panel:#0b1220; --text:#e5f7ef; --muted:#bfe7d3;
      --ios:cubic-bezier(.22,.61,.36,1); --shadow:0 12px 40px rgba(0,0,0,.35);
      --radius:16px;
    }
    html{font-size:16px}
    @media (max-width:380px){ html{font-size:15px} }
    @media (min-width:420px){ html{font-size:clamp(16px,2.2vw,18px)} }
    body{
      margin:0;min-height:100dvh;background:
        radial-gradient(1200px 600px at 50% -200px, rgba(128,237,153,.08), transparent 60%),
        linear-gradient(180deg,var(--bg),#0a192f);
      color:var(--text);
      font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
      touch-action: manipulation;
    }
    .wrap{max-width:60rem;margin:0 auto;padding:12px}
    header{
      position:sticky;top:0;z-index:20;padding-top:env(safe-area-inset-top);
      backdrop-filter:blur(10px);background:color-mix(in srgb,#0b1220 70%,transparent);
      border-bottom:1px solid rgba(199,249,204,.15);
    }
    .hero{display:flex;align-items:center;gap:.9rem;padding:.9rem .25rem; transition: all .25s var(--ios);}
    .hero .logo{width:2.8rem;height:2.8rem;border-radius:1rem;background:linear-gradient(135deg,var(--c-light),var(--c-emerald));
      display:flex;align-items:center;justify-content:center;color:#0b1220;font-weight:900;box-shadow:var(--shadow)}
    .hero .title{font-weight:900;font-size:1.35rem}
    .badge{font-size:.78rem;padding:.2rem .5rem;border-radius:999px;background:rgba(87,204,153,.15);color:var(--c-light);}
    .compact .hero{padding:.4rem .25rem; gap:.6rem}
    .compact .hero .logo{width:2rem;height:2rem;border-radius:.6rem}
    .compact .hero .title{font-size:1rem}
    nav.menu{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin:.6rem 0}
    nav.menu a, .menu button{
      display:flex;gap:.6rem;align-items:center;justify-content:center;
      padding:1rem;border-radius:16px;border:1px solid rgba(199,249,204,.18);
      background:linear-gradient(180deg,rgba(34,87,122,.12),rgba(56,163,165,.08));
      text-decoration:none;color:var(--text);font-weight:800; transition: transform .15s var(--ios);
      min-height:64px;
    }
    nav.menu a:hover, .menu button:hover{ transform: translateY(-1px); }
    .panel{
      background:linear-gradient(180deg,rgba(34,87,122,.12),rgba(56,163,165,.08));
      border:1px solid rgba(199,249,204,.18);
      border-radius:16px;padding:.85rem;box-shadow:var(--shadow)
    }
    label{font-size:.9rem;color:var(--muted);display:block;margin-bottom:.25rem}
    select,input[type=number],button{
      width:100%;padding:.8rem 1rem;border-radius:14px;border:1px solid rgba(199,249,204,.28);
      background:rgba(11,18,32,.6);color:var(--text);min-height:48px;outline:none;
      transition:transform .18s var(--ios), box-shadow .25s ease, border-color .25s ease}
    button{font-weight:800;letter-spacing:.01em}
    button.primary{background:linear-gradient(180deg,var(--c-emerald),var(--c-verdigris));color:#0b1220}
    button.secondary{background:rgba(199,249,204,.1)}
    .toolbar{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.6rem;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:.45rem;padding:.5rem .75rem;border-radius:999px;background:rgba(199,249,204,.08);
      border:1px solid rgba(199,249,204,.2);font-size:.9rem}
    .tabbar{position:sticky;bottom:0;z-index:20;background:color-mix(in srgb,#0b1220 85%, transparent); backdrop-filter: blur(10px);
      border-top:1px solid rgba(199,249,204,.15); padding: calc(env(safe-area-inset-bottom) + 6px) 12px 12px}
    .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem}
    .tabs button{min-height:44px}
    .hidden{display:none !important}
    /* Learning UI */
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    @media (min-width:760px){ .controls{grid-template-columns:1fr 1fr 1fr 1fr} }
    .exchange{margin:1rem 0;padding:1rem;border-radius:16px;background:rgba(34,87,122,.14);border:1px solid rgba(199,249,204,.2)}
    .ctx,.you{display:grid;gap:.6rem;margin:.45rem 0}
    .line{padding:.8rem .9rem;border-radius:14px;background:rgba(11,18,32,.55);border:1px solid rgba(199,249,204,.2)}
    .line.you{background:rgba(128,237,153,.14);border-color:rgba(128,237,153,.45)}
    .speaker{font-size:.9rem;letter-spacing:.04em;color:var(--c-light)}
    .speaker u{ text-decoration-thickness:2px; text-underline-offset:3px }
    .card{margin:1rem 0;padding:1.2rem;border-radius:18px;background:rgba(11,18,32,.55);border:1px solid rgba(199,249,204,.25);
      text-align:center;min-height:120px;display:flex;flex-direction:column;justify-content:center;gap:.5rem}
    .choices{display:grid;gap:.6rem;margin-top:.6rem}
    .big{font-size:1.05rem;line-height:1.5}
    .faded{opacity:.85;color:var(--muted)}
    .hearts{letter-spacing:.2rem}
    .cloze-gap{border-bottom:2px dotted var(--c-light); padding:0 .25rem}
    .list{display:grid; gap:.5rem; margin:.6rem 0}
    .list .row{display:flex; justify-content:space-between; gap:.8rem; padding:.6rem .8rem; border:1px solid rgba(199,249,204,.2); border-radius:12px}
    /* Views */
    [data-view]{display:none}
    [data-view].active{display:block}
  </style>
</head>
<body>
  <header id="hdr">
    <div class="wrap">
      <div class="hero">
        <div class="logo">üå±</div>
        <div>
          <div class="title">Horrorladen ‚Äì Lernapp</div>
          <div class="badge" id="subtitle">Willkommen</div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section data-view="home" class="active">
      <div class="panel">
        <nav class="menu">
          <button data-nav="learn">üìñ Lernen</button>
          <button data-nav="survival">üéÆ Survival</button>
          <button data-nav="scores">üèÜ Highscores</button>
          <button data-nav="settings">‚öôÔ∏è Einstellungen</button>
        </nav>
        <div class="faded">‚ÄûDIE ANDEREN‚Äú ‚Üí ‚ÄûALLE‚Äú, ‚ÄûBARAPAPAPA‚Äú wird ignoriert.</div>
      </div>
    </section>

    <!-- LEARN -->
    <section data-view="learn">
      <div class="panel">
        <div class="controls">
          <div>
            <label for="roleSel">Rolle</label>
            <select id="roleSel"></select>
          </div>
          <div>
            <label for="sessionSize">Blockgr√∂√üe</label>
            <input id="sessionSize" type="number" min="1" max="25" value="5"/>
          </div>
          <div>
            <label for="modeSel">Modus</label>
            <select id="modeSel">
              <option value="classic">Classic</option>
              <option value="flash">Flashcards</option>
              <option value="cloze">Cloze</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="primary" id="startLearn">Start</button>
          </div>
        </div>
        <div class="toolbar">
          <span id="statsPill" class="pill">Bereit</span>
          <button class="secondary" id="shareBtn">Link teilen</button>
          <button class="secondary" data-nav="home">Zur√ºck</button>
        </div>
      </div>
      <div id="learnRoot" style="margin-top:.8rem;"></div>
    </section>

    <!-- SURVIVAL -->
    <section data-view="survival">
      <div class="panel">
        <div class="controls">
          <div>
            <label for="roleSurv">Rolle</label>
            <select id="roleSurv"></select>
          </div>
          <div>
            <label>Herzen</label>
            <div id="heartPill" class="pill hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
          </div>
          <div>
            <label>Score</label>
            <div id="scorePill" class="pill">0</div>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="primary" id="startSurv">Neu starten</button>
          </div>
        </div>
        <div class="toolbar">
          <button class="secondary" data-nav="home">Zur√ºck</button>
          <button class="secondary" data-nav="scores">Zu Highscores</button>
        </div>
      </div>
      <div id="survRoot" style="margin-top:.8rem;"></div>
    </section>

    <!-- SCORES -->
    <section data-view="scores">
      <div class="panel">
        <div class="controls">
          <div>
            <label for="nameField">Dein Name (f√ºr Highscore)</label>
            <input id="nameField" placeholder="z.B. Alex" />
          </div>
          <div>
            <label for="boardRole">Rolle (Filter)</label>
            <select id="boardRole"><option value="">Alle</option></select>
          </div>
          <div>
            <label for="boardLimit">Anzahl</label>
            <select id="boardLimit">
              <option>10</option><option selected>25</option><option>50</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="primary" id="refreshBoard">Aktualisieren</button>
          </div>
        </div>
        <div class="toolbar">
          <button class="secondary" data-nav="home">Zur√ºck</button>
          <span class="pill">Serverlos √ºber GUN (√∂ffentlich)</span>
        </div>
        <div id="board" class="list"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section data-view="settings">
      <div class="panel">
        <div class="list">
          <div class="row"><span>JSON-Quelle</span><span><code id="jsonSrcLabel">script.json</code></span></div>
          <div class="row"><span>Gesten-Navigation</span><span id="gestStatus">aktiv</span></div>
          <div class="row"><span>UI-Gr√∂√üe</span><span>mobil-optimiert</span></div>
        </div>
        <div class="toolbar">
          <button class="secondary" data-nav="home">Zur√ºck</button>
        </div>
      </div>
    </section>
  </main>

  <div class="tabbar">
    <div class="tabs">
      <button data-nav="home">üè† Home</button>
      <button data-nav="learn">üìñ Lernen</button>
      <button data-nav="survival">üéÆ Survival</button>
      <button data-nav="scores">üèÜ Scores</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>

  <script>
    // ----------- Core helpers
    const q = new URLSearchParams(location.search);
    const jsonSrc = q.get('src') || 'script.json';
    document.getElementById('jsonSrcLabel').textContent = jsonSrc;
    const hdr = document.getElementById('hdr');
    const norm = (s)=> (s||'').trim().toUpperCase();
    const treatSpeaker = (sp)=>{
      const s = norm(sp);
      if (s === 'DIE ANDEREN') return 'ALLE';
      if (s === 'BARAPAPAPA' || s === 'BARAPAPAPABA') return '__IGNORE__';
      return s;
    };
    const isIncludedForRole = (sp, chosen)=>{
      const s=treatSpeaker(sp), ch=norm(chosen);
      if (!s || s==='__IGNORE__') return false;
      if (s==='ALLE') return true;
      return s===ch;
    };
    function groupRoles(data){
      const seen=new Set(), roles=[];
      if (data.roles_meta && Array.isArray(data.roles_meta.roles)){
        for (const r of data.roles_meta.roles){
          const name=norm(r.name); if (name && !seen.has(name)){ seen.add(name); roles.push(name); }
          if (Array.isArray(r.aliases)) for (const a of r.aliases){
            const an=norm(a); if (an && !seen.has(an)){ seen.add(an); roles.push(an); }
          }
        }
      } else {
        for (const it of data.items||[]) if (it.type==='dialogue' && it.speaker){
          const s=norm(it.speaker); if (s && !seen.has(s)){ seen.add(s); roles.push(s); }
        }
      }
      if (!seen.has('ALLE')) roles.push('ALLE');
      roles.sort((a,b)=>{
        const pr=['SEYMOUR','AUDREY','MR. MUSHNIK','ORIN','DIE PFLANZE'];
        const ia=pr.indexOf(a), ib=pr.indexOf(b);
        if (ia!==-1 || ib!==-1) return (ia===-1?999:ia)-(ib===-1?999:ib);
        return a.localeCompare(b);
      });
      return roles.filter(r=>r!=='ALLE');
    }
    function buildExchanges(items, chosenRole){
      const dialogues = (items||[]).filter(it=>it.type==='dialogue')
        .map(it=>({...it, speaker: treatSpeaker(it.speaker)}))
        .filter(it=>it.speaker!=='__IGNORE__');
      const exchanges=[]; let i=0, last=-1;
      while(i<dialogues.length){
        const it=dialogues[i];
        if (isIncludedForRole(it.speaker, chosenRole)){
          const context=[];
          for (let j=last+1;j<i;j++){ const pj=dialogues[j]; if(!isIncludedForRole(pj.speaker, chosenRole)) context.push(pj); }
          const yours=[]; let k=i;
          while(k<dialogues.length && isIncludedForRole(dialogues[k].speaker, chosenRole)){ yours.push(dialogues[k]); k++; }
          exchanges.push({idx:exchanges.length, context, yours});
          last=k-1; i=k;
        } else i++;
      }
      return exchanges;
    }
    function el(tag, attrs={}, ...children){
      const n=document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){ if (k==='class') n.className=v; else if (k==='html') n.innerHTML=v; else n.setAttribute(k,v); }
      for (const c of children){ if (c==null) continue; n.appendChild(typeof c==='string'?document.createTextNode(c):c); }
      return n;
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // ----------- Router + UI chrome
    const views = Array.from(document.querySelectorAll('[data-view]'));
    const subtitle = document.getElementById('subtitle');
    function show(view){
      views.forEach(v=>v.classList.toggle('active', v.dataset.view===view));
      // hero size
      hdr.classList.toggle('compact', view!=='home');
      subtitle.textContent = (view==='home'?'Willkommen':
        view==='learn'?'Lernen':
        view==='survival'?'Survival':
        view==='scores'?'Highscores':'Einstellungen');
      // store route for back gesture
      history.pushState({view}, '', location.pathname + location.search + '#' + view);
    }
    // initial route
    const initial = location.hash?.slice(1) || 'home';
    show(initial);
    // Tabbar / menu navigation
    document.querySelectorAll('[data-nav]').forEach(b=>b.addEventListener('click', ()=>{
      const v = b.getAttribute('data-nav');
      show(v);
    }));
    window.addEventListener('popstate', (e)=>{
      const view = (location.hash?.slice(1)) || 'home';
      views.forEach(v=>v.classList.toggle('active', v.dataset.view===view));
      hdr.classList.toggle('compact', view!=='home');
      subtitle.textContent = view;
    });
    // iPhone swipe-back (left edge -> right)
    (function enableSwipeBack(){
      let startX=0, startY=0, dragging=false;
      window.addEventListener('touchstart', (e)=>{
        const t=e.touches[0]; if (!t) return;
        if (t.clientX<22){ startX=t.clientX; startY=t.clientY; dragging=true; }
      }, {passive:true});
      window.addEventListener('touchmove', (e)=>{
        if (!dragging) return;
        const t=e.touches[0]; if (!t) return;
        const dx=t.clientX-startX, dy=Math.abs(t.clientY-startY);
        if (dx>80 && dy<60){ dragging=false; history.back(); }
      }, {passive:true});
      window.addEventListener('touchend', ()=>{ dragging=false; }, {passive:true});
    })();

    // ----------- Learning modes (same logic as before, mounted in learnRoot)
    const learnRoot = document.getElementById('learnRoot');
    function renderClassic(ex, N, page){
      const pages = Math.max(1, Math.ceil(ex.length / N));
      const start = Math.min(page, pages-1) * N;
      const slice = ex.slice(start, start+N);
      learnRoot.innerHTML='';
      const navTop=el('div',{class:'toolbar'},
        el('button',{class:'secondary',id:'prev'},'‚Üê Zur√ºck'),
        el('span',{class:'pill'},`Seite ${page+1} / ${pages}`),
        el('button',{class:'secondary',id:'next'},'Weiter ‚Üí')
      ); learnRoot.appendChild(navTop);
      slice.forEach(block=>{
        const box=el('div',{class:'exchange'});
        if (block.context.length){ const ctx=el('div',{class:'ctx'}); block.context.forEach(l=>ctx.appendChild(renderLine(l,false))); box.appendChild(ctx); }
        if (block.yours.length){ const you=el('div',{class:'you'}); block.yours.forEach(l=>you.appendChild(renderLine(l,true))); box.appendChild(you); }
        learnRoot.appendChild(box);
      });
      const navBot=navTop.cloneNode(true); learnRoot.appendChild(navBot);
      const setPage=(p)=>{ const P=new URLSearchParams(location.search); P.set('page',String(p)); history.replaceState(null,'',`?${P.toString()}#learn`); renderLearn(); };
      learnRoot.querySelectorAll('#prev').forEach(b=>b.addEventListener('click',()=>setPage(Math.max(0,page-1))));
      learnRoot.querySelectorAll('#next').forEach(b=>b.addEventListener('click',()=>setPage(Math.min(pages-1,page+1))));
    }
    function renderFlash(ex){
      const pool = ex.flatMap(b=>b.yours);
      let i=0; learnRoot.innerHTML='';
      const card=el('div',{class:'card'});
      const head=el('div',{class:'faded'},'Tippe zum Aufdecken');
      const body=el('div',{class:'big',id:'fcBody'},'');
      const meta=el('div',{class:'faded',id:'fcMeta'},'');
      card.append(head, body, meta);
      const bar=el('div',{class:'toolbar'},
        el('button',{class:'secondary',id:'prev'},'‚Üê'),
        el('span',{class:'pill',id:'counter'},''),
        el('button',{class:'secondary',id:'next'},'‚Üí')
      );
      learnRoot.append(card, bar);
      let revealed=false;
      function show(){ if(!pool.length){ body.textContent='Keine Daten'; return; }
        const it=pool[i]; revealed=false; body.textContent= it.speaker + ' ‚Äì (verborgen)'; meta.textContent='Kontext tippen zum Anzeigen'; }
      function reveal(){ const it=pool[i]; body.innerHTML=`<b>${escapeHtml(it.speaker||'')}</b><br>${escapeHtml(it.text).replace(/\n/g,'<br/>')}`; meta.textContent='Tippe um zu verstecken'; }
      function upd(){ document.getElementById('counter').textContent=`${i+1} / ${pool.length}`; }
      function next(){ i=(i+1)%pool.length; show(); upd(); }
      function prev(){ i=(i-1+pool.length)%pool.length; show(); upd(); }
      card.addEventListener('click',()=>{ revealed?show():reveal(); revealed=!revealed; });
      document.getElementById('next').addEventListener('click', next);
      document.getElementById('prev').addEventListener('click', prev);
      show(); upd();
    }
    function wordsOf(text){ return (text||'').split(/(\s+|[.,;:!?]+)/).filter(x=>x && !/[.,;:!?]+/.test(x)); }
    function makeCloze(text, ratio=.35){
      const ws=wordsOf(text); if (ws.length<4) return {html:escapeHtml(text),gaps:[]};
      const toHide=Math.max(1, Math.floor(ws.length*ratio));
      const idxs=new Set();
      const order=ws.map((w,i)=>({i,w})).sort((a,b)=>b.w.length-a.w.length).map(o=>o.i);
      for (let i=0;i<order.length && idxs.size<toHide;i++){ if (ws[order[i]].length>=3) idxs.add(order[i]); }
      const gaps=[];
      const out=ws.map((w,i)=> idxs.has(i)?(gaps.push(w), `<span class="cloze-gap">${' '.repeat(Math.max(3, Math.min(12,w.length)))}</span>`): escapeHtml(w));
      return {html: out.join(' '), gaps};
    }
    function renderCloze(ex){
      const pool = ex.flatMap(b=>b.yours).filter(l=>(l.text||'').split(' ').length>=4);
      let i=0; learnRoot.innerHTML='';
      const card=el('div',{class:'card'});
      const head=el('div',{class:'faded'},'L√ºcken f√ºllen (visuell)');
      const body=el('div',{class:'big',id:'czBody'},'');
      const meta=el('div',{class:'faded',id:'czMeta'},'');
      const revealBtn=el('button',{class:'primary',id:'reveal'},'L√∂sung zeigen');
      card.append(head, body, meta, revealBtn);
      const bar=el('div',{class:'toolbar'},
        el('button',{class:'secondary',id:'prev'},'‚Üê'),
        el('span',{class:'pill',id:'counter'},''),
        el('button',{class:'secondary',id:'next'},'‚Üí')
      );
      learnRoot.append(card, bar);
      function renderItem(){ if(!pool.length){ body.textContent='Keine Daten'; return; }
        const it=pool[i]; const {html,gaps}=makeCloze(it.text,.35);
        body.innerHTML=`<div class="faded">${escapeHtml(it.speaker||'')}</div>` + html; meta.textContent=`versteckte W√∂rter: ${gaps.length}`; }
      function reveal(){ const it=pool[i]; body.innerHTML=`<b>${escapeHtml(it.speaker||'')}</b><br>${escapeHtml(it.text).replace(/\n/g,'<br/>')}`; }
      function next(){ i=(i+1)%pool.length; renderItem(); upd(); }
      function prev(){ i=(i-1+pool.length)%pool.length; renderItem(); upd(); }
      function upd(){ document.getElementById('counter').textContent=`${i+1} / ${pool.length}`; }
      document.getElementById('reveal').addEventListener('click', reveal);
      document.getElementById('next').addEventListener('click', next);
      document.getElementById('prev').addEventListener('click', prev);
      renderItem(); upd();
    }
    function renderLine(line,isYou){ const wrap=el('div',{class:'line'+(isYou?' you':'')}); const spk=el('div',{class:'speaker'}); spk.innerHTML=`<u>${escapeHtml(line.speaker||'')}</u>`; const txt=el('div'); txt.innerHTML=escapeHtml(line.text).replace(/\n/g,'<br/>'); wrap.append(spk,txt); return wrap; }

    // ----------- Learn controller
    const roleSel = document.getElementById('roleSel');
    const sessionSize = document.getElementById('sessionSize');
    const modeSel = document.getElementById('modeSel');
    const statsPill = document.getElementById('statsPill');
    const shareBtn = document.getElementById('shareBtn');
    document.getElementById('startLearn').addEventListener('click', ()=>renderLearn());
    shareBtn.addEventListener('click', async ()=>{
      const p=new URLSearchParams(location.search);
      p.set('role', roleSel.value); p.set('n', sessionSize.value); p.set('mode', modeSel.value);
      history.replaceState(null,'',`?${p.toString()}#learn`);
      try{ await navigator.clipboard.writeText(location.href); shareBtn.textContent='Link kopiert!'; setTimeout(()=>shareBtn.textContent='Link teilen',1200); }catch{ alert(location.href); }
    });
    function renderLearn(){
      const data = window.__SCRIPT || {items:[]};
      const role = roleSel.value;
      const ex = buildExchanges(data.items||[], role);
      statsPill.textContent = `${ex.length} Bl√∂cke`;
      const N = Math.max(1, Math.min(25, parseInt(sessionSize.value||'5',10)||5));
      const page = Math.max(0, parseInt(q.get('page')||'0',10)||0);
      const mode = modeSel.value;
      if (mode==='classic') renderClassic(ex, N, page);
      else if (mode==='flash') renderFlash(ex);
      else if (mode==='cloze') renderCloze(ex);
    }

    // ----------- Survival + Highscores via GUN
    const roleSurv = document.getElementById('roleSurv');
    const scorePill = document.getElementById('scorePill');
    const heartPill = document.getElementById('heartPill');
    const survRoot = document.getElementById('survRoot');
    let HEARTS = 3, SCORE = 0;
    document.getElementById('startSurv').addEventListener('click', startSurvival);
    function updateHUD(){ heartPill.textContent = '‚ù§Ô∏è'.repeat(HEARTS) + 'üñ§'.repeat(3-HEARTS); scorePill.textContent = String(SCORE); }

    // Init GUN (public relay). This is public/unauthenticated. Keep names simple & safe.
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const HS_NODE = 'horrorladen-highscores-v1';

    function submitScore(name, role, score){
      try{
        const id = Math.random().toString(36).slice(2);
        const payload = { id, name: (name||'anon').slice(0,24), role: role||'', score: Number(score)||0, ts: Date.now() };
        gun.get(HS_NODE).get(id).put(payload);
      }catch(e){ console.warn('score failed', e); }
    }

    async function startSurvival(){
      HEARTS=3; SCORE=0; updateHUD(); renderQuestion();
    }
    function sample(a){ return a[Math.floor(Math.random()*a.length)] }
    function renderQuestion(){
      const data = window.__SCRIPT || {items:[]};
      const role = roleSurv.value;
      const ex = buildExchanges(data.items||[], role);
      const yourLines = ex.flatMap(b=>b.yours);
      const contexts = ex.map(b=>b.context.map(l=>`${l.speaker}: ${l.text}`).join(' '));
      if (!yourLines.length){ survRoot.innerHTML='<div class="card">Keine Daten</div>'; return; }
      const idx = Math.floor(Math.random()*yourLines.length);
      const correct = yourLines[idx];
      const targetLen = (correct.text||'').length || 1;
      const candidates = yourLines.filter(l=>Math.abs((l.text||'').length - targetLen) <= targetLen*0.3 && l!==correct);
      const decoy = candidates.length ? sample(candidates) : sample(yourLines);
      const ctx = contexts[Math.min(ex.length-1, Math.floor(idx / Math.max(1, Math.floor(yourLines.length/ex.length))))] || '';

      survRoot.innerHTML='';
      const card = el('div',{class:'card'});
      const head = el('div',{class:'faded'},'W√§hle die korrekte Antwort');
      const ctxDiv = el('div',{class:'faded'}, ctx ? `Kontext: ${ctx.substring(0,140)}‚Ä¶` : '‚Äî');
      const prompt = el('div',{class:'big'}, `${correct.speaker}: ?`);
      const choices = el('div',{class:'choices'});
      const opts = Math.random()<0.5 ? [correct, decoy] : [decoy, correct];
      opts.forEach(opt=>{
        const btn = el('button',{class:'primary'}, (opt.text||'').replace(/\n/g,' '));
        btn.addEventListener('click', ()=>{
          if (opt===correct){
            SCORE++; updateHUD();
            try { confetti({ particleCount: 60, spread: 60, startVelocity: 25, origin: {y: .25} }); } catch {}
            renderQuestion();
          } else {
            HEARTS--; updateHUD();
            btn.style.background = '#7a2231'; btn.style.color = '#fff';
            if (HEARTS<=0){ gameOver(); } else {
              const corr = el('div',{class:'faded'}, `Richtig: ${correct.text}`); card.appendChild(corr);
              setTimeout(renderQuestion, 900);
            }
          }
        });
        choices.appendChild(btn);
      });
      card.append(head, ctxDiv, prompt, choices);
      survRoot.appendChild(card);
    }
    function gameOver(){
      const role = roleSurv.value;
      survRoot.innerHTML='';
      const over = el('div',{class:'card'},
        el('div',{class:'big'}, `Game Over ‚Äì Score: ${SCORE}`),
        el('div',{class:'faded'}, 'Name eingeben & Speichern f√ºr Highscore'),
        el('input',{id:'hsname', placeholder:'Dein Name'}),
        el('button',{class:'primary', id:'saveScore'},'Score speichern'),
        el('button',{class:'secondary', 'data-nav':'scores'},'Zu Highscores')
      );
      survRoot.appendChild(over);
      document.getElementById('saveScore').addEventListener('click', ()=>{
        const name = (document.getElementById('hsname').value || localStorage.getItem('playerName') || 'anon').trim();
        localStorage.setItem('playerName', name);
        submitScore(name, role, SCORE);
        show('scores');
        loadBoard(); // refresh
      });
    }

    // ----------- Scores board
    const board = document.getElementById('board');
    const boardRole = document.getElementById('boardRole');
    const boardLimit = document.getElementById('boardLimit');
    const nameField = document.getElementById('nameField');
    nameField.value = localStorage.getItem('playerName') || '';
    nameField.addEventListener('change', ()=> localStorage.setItem('playerName', nameField.value.trim() ));
    document.getElementById('refreshBoard').addEventListener('click', loadBoard);
    async function loadBoard(){
      board.innerHTML = '<div class="card">Lade‚Ä¶</div>';
      const rows = [];
      try{
        const node = gun.get(HS_NODE);
        node.map().once((data, key)=>{
          if (!data || !data.score) return;
          rows.push({ name: data.name||'anon', role: data.role||'', score: Number(data.score)||0, ts: Number(data.ts)||0 });
        });
        setTimeout(()=>{
          // Sort by score desc, then newest first
          const roleFilter = (boardRole.value||'').toUpperCase();
          const list = rows
            .filter(r => !roleFilter || r.role.toUpperCase()===roleFilter)
            .sort((a,b)=> (b.score-a.score) || (b.ts-a.ts))
            .slice(0, Number(boardLimit.value||25));
          renderBoard(list);
        }, 600); // small wait to collect
      }catch(e){
        board.innerHTML = '<div class="card">Fehler beim Laden.</div>';
      }
    }
    function renderBoard(list){
      board.innerHTML='';
      if (!list.length){ board.innerHTML = '<div class="card">Noch keine Eintr√§ge</div>'; return; }
      list.forEach((r,i)=>{
        const row = el('div',{class:'row'},
          el('div',{}, `${String(i+1).padStart(2,'0')}. ${r.name}`),
          el('div',{}, `‚≠ê ${r.score} ‚Ä¢ ${r.role || '‚Äî'}`)
        );
        board.appendChild(row);
      });
    }

    // ----------- Boot
    const roleOptions = (data)=> groupRoles(data).map(r=>`<option value="${r}">${r}</option>`).join('');
    (async ()=>{
      try{
        const res = await fetch(jsonSrc, {cache:'no-store'});
        const j = await res.json();
        window.__SCRIPT = j;
        // init selects
        const roles = groupRoles(j);
        roleSel.innerHTML = roleOptions(j);
        roleSurv.innerHTML = roleOptions(j);
        boardRole.innerHTML = '<option value="">Alle</option>' + roleOptions(j);
        roleSel.value = (q.get('role') && roles.includes(norm(q.get('role')))) ? norm(q.get('role')) : (roles[0]||'SEYMOUR');
        roleSurv.value = roleSel.value;
        // go
        loadBoard();
      }catch(e){
        document.querySelector('[data-view="home"] .panel').append(el('div',{class:'card'},'Fehler beim Laden der JSON.'));
      }
    })();
  </script>
</body>
</html>
