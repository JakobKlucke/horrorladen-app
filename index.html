<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Horrorladen – Lernapp</title>
  <meta name="theme-color" content="#58CC02" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Nunito:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --green:#58CC02; --green-strong:#8EE000; --green-dark:#1FAF38;
      --ink:#2F2F2F; --paper:#FFFFFF; --bg:#F6F7FB; --muted:#6F6F6F;
      --ring: rgba(88,204,2,.35); --shadow:0 12px 30px rgba(0,0,0,.10);
      --radius:20px; --duo-ease-out:cubic-bezier(.17,.67,.16,1); --duo-spring:cubic-bezier(.2,.8,.2,1);
      --t-fast:120ms; --t-reg:200ms; --t-slow:320ms;
    }
    html{font-size:16px;height:100dvh;overscroll-behavior:none;background:var(--bg);-webkit-text-size-adjust:100%;}
    *{-webkit-tap-highlight-color:transparent;}
    body{margin:0;height:100dvh;display:flex;flex-direction:column;background:var(--bg);color:var(--ink);
      font-family:Inter,ui-sans-serif,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden;touch-action:manipulation;}
    header{position:sticky;top:0;z-index:30;padding-top:env(safe-area-inset-top);backdrop-filter:saturate(120%) blur(10px);
      background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.75));border-bottom:1px solid rgba(0,0,0,.06)}
    .wrap{max-width:64rem;margin:0 auto;padding:12px}
    main.wrap{flex:1 1 auto; overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;}

    .hero{display:flex;align-items:center;gap:12px;padding:.8rem .25rem}
    .logo{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--green),var(--green-strong));display:grid;place-items:center;box-shadow:var(--shadow)}
    .title{font-family:Nunito,Inter,sans-serif;font-weight:900;font-size:1.35rem}
    .badge{font-size:.8rem;padding:.25rem .6rem;border-radius:999px;background:rgba(88,204,2,.15);color:#0D6A00;font-weight:700}
    .compact .hero{padding:.45rem .25rem;gap:.55rem}.compact .logo{width:36px;height:36px;border-radius:10px}.compact .title{font-size:1.05rem}

    /* Menü (responsiv) */
    .menu{display:grid;grid-template-columns:repeat(5,1fr);gap:.6rem;margin:.6rem 0}
    @media (max-width:820px){ .menu{grid-template-columns:repeat(3,1fr);} }
    @media (max-width:480px){ .menu{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:400px){ .menu{grid-template-columns:1fr;} } /* iPhone – untereinander */

    .menu button{
      display:flex;gap:.35rem;align-items:center;justify-content:center;
      padding:.85rem;border-radius:18px;border:2px solid rgba(0,0,0,.06);
      background:linear-gradient(180deg,#fff,#F5FFF0);
      color:var(--ink);font-weight:800;letter-spacing:.2px;
      min-height:56px; box-shadow:var(--shadow);
      transition: transform var(--t-fast) var(--duo-spring), box-shadow var(--t-reg) var(--duo-ease-out);
    }
    .menu button:hover{ transform: translateY(-1px) scale(1.02);}
    .menu button:active{ transform: translateY(0) scale(.98); box-shadow:0 4px 12px rgba(0,0,0,.10)}

    /* Panels & Inputs */
    .panel{background:linear-gradient(180deg,#fff,#F8FFF4);border:2px solid rgba(0,0,0,.06);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow)}
    label{font-size:.95rem;color:var(--muted);display:block;margin-bottom:.35rem}
    select,input[type=text],button{width:100%;padding:.85rem 1rem;border-radius:16px;border:2px solid rgba(0,0,0,.08);background:#fff;color:var(--ink);min-height:48px;outline:none;
      transition:transform var(--t-fast) var(--duo-spring), border-color var(--t-reg) var(--duo-ease-out), box-shadow var(--t-reg) var(--duo-ease-out)}
    select:focus,input:focus{border-color:var(--green); box-shadow:0 0 0 6px var(--ring); transform: translateY(-1px)}
    button.primary{background:linear-gradient(180deg,var(--green-strong),var(--green));color:#0b1220;border-color:transparent}
    .controls{display:grid;gap:.75rem;grid-template-columns:repeat(2,1fr);align-items:end}
    @media (min-width:760px){ .controls{grid-template-columns:repeat(3,1fr)} }
    .controls .cta{display:flex;justify-content:flex-end;align-items:end}

    /* Filterleisten */
    .filters{display:grid;gap:.6rem;margin:.6rem 0}
    @media (min-width:760px){ .filters{grid-template-columns:repeat(4,1fr)} }

    /* Learn-Zeilen */
    .exchange{margin:1rem 0;padding:1rem;border-radius:18px;background:#fff;border:2px solid rgba(0,0,0,.06)}
    .line{padding:.85rem 1rem;border-radius:14px;background:linear-gradient(180deg,#F2FFF2,#E9FFE0);border:2px solid rgba(37,168,0,.25)}
    .faded{opacity:.8;color:var(--muted);font-size:.95rem}
    .big{font-size:1.12rem;line-height:1.6}

    /* Cards (Flash/Cloze) – größer & zentriert */
    .card{margin:1rem 0;padding:1.1rem;border-radius:22px;background:#fff;border:2px solid rgba(0,0,0,.06);
      text-align:center;display:flex;flex-direction:column;gap:.6rem;box-shadow:var(--shadow)}
    .card.flash, .card.cloze{max-width:42rem;margin:1rem auto;padding:1.25rem 1.35rem}
    .card.flash .big, .card.cloze .big{font-size:1.25rem;line-height:1.75}

    /* Viewer */
    .row{padding:.85rem 1rem;border-radius:14px;border:2px solid rgba(0,0,0,.06);background:#fff}
    .row.me{background:linear-gradient(180deg,#F2FFF2,#E9FFE0);border-color:rgba(37,168,0,.25);}

    /* Pager & Progress */
    .pager{display:flex;justify-content:space-between;align-items:center;gap:.8rem;margin:1rem 0}
    .pager .info{font-size:.92rem;color:var(--muted)}
    .pager .group{display:flex;gap:.5rem}
    .progress{height:8px;border-radius:999px;background:#e6e9ef;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#8EE000,#58CC02);transition:width .25s var(--duo-spring)}

    [data-view]{display:none}
    [data-view].active{display:block}
  </style>
</head>
<body>
<header id="hdr">
  <div class="wrap">
    <div class="hero">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs><clipPath id="r"><rect rx="16" width="64" height="64"/></clipPath></defs>
          <g clip-path="url(#r)">
            <rect width="64" height="64" fill="#8EE000"/>
            <circle cx="22" cy="28" r="10" fill="#fff"/><circle cx="42" cy="28" r="10" fill="#fff"/>
            <circle cx="22" cy="28" r="5" fill="#2B2B2B"/><circle cx="42" cy="28" r="5" fill="#2B2B2B"/>
            <path d="M10 44 C 20 52, 44 52, 54 44" stroke="#2B2B2B" stroke-width="6" stroke-linecap="round" fill="none"/>
          </g>
        </svg>
      </div>
      <div>
        <div class="title">Horrorladen – Lernapp</div>
        <div class="badge" id="subtitle">Willkommen</div>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- HOME -->
  <section data-view="home" class="active">
    <div class="panel">
      <nav class="menu">
        <button data-nav="learn">📖 Lernen</button>
        <button data-nav="viewer">📜 Textviewer</button>
        <button data-nav="survival">🎮 Survival</button>
        <button data-nav="scores">🏆 Highscores</button>
        <button data-nav="settings">⚙️ Einstellungen</button>
      </nav>
    </div>
  </section>

  <!-- LEARN -->
  <section data-view="learn">
    <div class="panel">
      <div class="filters">
        <div>
          <label for="actFilter">Akt</label>
          <select id="actFilter"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="sceneFilter">Szene</label>
          <select id="sceneFilter"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="songFilter">Song</label>
          <select id="songFilter"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="lyricsOnly">Lyrics-only</label>
          <label style="display:flex;gap:.5rem;align-items:center">
            <input id="lyricsOnly" type="checkbox" /> <span>nur Gesang</span>
          </label>
        </div>
      </div>

      <div class="controls" style="margin-top:.6rem">
        <div>
          <label for="roleSel">Rolle</label>
          <select id="roleSel"></select>
        </div>
        <div>
          <label for="modeSel">Modus</label>
          <select id="modeSel">
            <option value="classic">Classic</option>
            <option value="flash">Flashcards</option>
            <option value="cloze">Cloze</option>
          </select>
        </div>
        <div class="cta">
          <button class="primary" id="startLearn">Start</button>
        </div>
      </div>
    </div>

    <div id="learnMeta" style="display:flex;align-items:center;gap:.8rem;margin-top:.8rem">
      <div class="progress" style="flex:1"><i id="learnProg"></i></div>
      <div class="faded" id="learnCount">0/0</div>
    </div>

    <div id="learnRoot"></div>

    <div class="pager" id="learnPager" hidden>
      <div class="info" id="pagerInfo">Seite 1/1</div>
      <div class="group">
        <button id="prevPage" class="secondary">← Zurück</button>
        <button id="nextPage" class="primary">Weiter →</button>
      </div>
    </div>
  </section>

  <!-- VIEWER -->
  <section data-view="viewer">
    <div class="panel">
      <div class="filters">
        <div>
          <label for="actFilterV">Akt</label>
          <select id="actFilterV"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="sceneFilterV">Szene</label>
          <select id="sceneFilterV"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="songFilterV">Song</label>
          <select id="songFilterV"><option value="">Alle</option></select>
        </div>
        <div>
          <label for="lyricsOnlyV">Lyrics-only</label>
          <label style="display:flex;gap:.5rem;align-items:center">
            <input id="lyricsOnlyV" type="checkbox" /> <span>nur Gesang</span>
          </label>
        </div>
      </div>

      <!-- NEU: Hervorhebungs-Dropdown NUR für Anzeige -->
      <div class="controls" style="grid-template-columns:1fr auto">
        <div>
          <label for="viewerRoleSel">Hervorhebung (nur Anzeige)</label>
          <select id="viewerRoleSel"></select>
        </div>
        <div class="cta" style="align-items:flex-end">
          <span class="faded" id="viewerLegend">Hervorhebung aktiv</span>
        </div>
      </div>
    </div>

    <div id="viewerMeta" style="display:flex;align-items:center;gap:.8rem;margin-top:.8rem">
      <div class="progress" style="flex:1"><i id="viewerProg"></i></div>
      <div class="faded" id="viewerCount">0/0</div>
    </div>

    <div id="viewerRoot"></div>

    <div class="pager" id="viewerPager" hidden>
      <div class="info" id="viewerPagerInfo">Seite 1/1</div>
      <div class="group">
        <button id="viewerPrev" class="secondary">← Zurück</button>
        <button id="viewerNext" class="primary">Weiter →</button>
      </div>
    </div>
  </section>

  <!-- SURVIVAL -->
  <section data-view="survival">
    <div class="panel controls">
      <div>
        <label for="roleSurv">Rolle</label>
        <select id="roleSurv"></select>
      </div>
      <div>
        <label>Herzen</label>
        <div id="heartPill" class="pill heart" aria-live="polite">❤️❤️❤️</div>
      </div>
      <div>
        <label>Score</label>
        <div id="scorePill" class="pill" aria-live="polite">0</div>
      </div>
      <div class="cta">
        <button class="primary" id="startSurv">Neu starten</button>
      </div>
    </div>

    <div id="survRoot"></div>
  </section>

  <!-- SCORES -->
  <section data-view="scores">
    <div class="panel controls">
      <div>
        <label for="nameField">Dein Name</label>
        <input id="nameField" type="text" placeholder="z.B. Alex"/>
      </div>
      <div>
        <label for="boardRole">Rolle</label>
        <select id="boardRole"><option value="">Alle</option></select>
      </div>
      <div>
        <label for="boardLimit">Anzahl</label>
        <select id="boardLimit"><option>10</option><option selected>25</option><option>50</option></select>
      </div>
      <div class="cta">
        <button class="primary" id="refreshBoard">Aktualisieren</button>
      </div>
    </div>
    <div id="board" class="list"></div>
  </section>

  <!-- SETTINGS -->
  <section data-view="settings">
    <div class="panel" style="display:grid;gap:.9rem">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap">
        <div style="flex:1 1 260px">
          <label for="playerName">Spielername</label>
          <input id="playerName" type="text" placeholder="z.B. Alex"/>
        </div>
        <div>
          <button class="primary" id="saveSettings">Speichern</button>
        </div>
      </div>

      <div style="display:grid;gap:.4rem">
        <label for="scriptInput">JSON-Quelle (Pfad/Datei)</label>
        <input id="scriptInput" type="text" />
        <div style="display:flex;gap:.5rem;align-items:center">
          <button class="primary" id="loadScriptBtn">Neu laden</button>
          <span class="faded">Aktuell: <code id="jsonSrcLabel">horrorladen_final_with_acts.json</code></span>
        </div>
      </div>
    </div>
  </section>
</main>

<div class="wrap bottom-nav">
  <nav class="menu">
    <button data-nav="home" aria-label="Home">🏠</button>
    <button data-nav="learn" aria-label="Lernen">📖</button>
    <button data-nav="viewer" aria-label="Textviewer">📜</button>
    <button data-nav="survival" aria-label="Survival">🎮</button>
    <button data-nav="scores" aria-label="Highscores">🏆</button>
  </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>

<script>
/* ====== Setup & Loader ====== */
const LS = { nameKey:'hl_player_name', scriptKey:'hl_json_src' };
const q=new URLSearchParams(location.search);
const initialSrc = localStorage.getItem(LS.scriptKey) || q.get('src') || 'horrorladen_final_with_acts.json';
let jsonSrc = initialSrc;
const jsonLabel=document.getElementById('jsonSrcLabel'); if(jsonLabel) jsonLabel.textContent=jsonSrc;

let currentView='home';
const state={
  items:[], roles:[],
  actsList:[], scenesByAct:{}, songsSet:new Set(),
  pageIndex:0, pageSizeClassic:8, pageSizeSingle:1, lastFiltered:[],
  viewerIndex:0, viewerPageSize:20, viewerLast:[],
  viewerHighlightRole:'' // NEU: eigene Auswahl im Viewer
};

const norm = s => (s||'').trim().toUpperCase();
const treatSpeaker = sp => {
  const s = norm(sp);
  if (s==='DIE ANDEREN') return 'ALLE';
  if (s==='BARAPAPAPA' || s==='BARAPAPAPABA') return '__IGNORE__';
  return s;
};

function el(tag,attrs={},...children){
  const n=document.createElement(tag);
  for (const[k,v]of Object.entries(attrs)){
    if(k==='class') n.className=v;
    else if(k==='html') n.innerHTML=v;
    else n.setAttribute(k,v);
  }
  for(const c of children){ if(c==null) continue; n.appendChild(typeof c==='string'?document.createTextNode(c):c); }
  return n;
}
function escapeHtml(s){return(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
function wordsOf(t){return(t||'').split(/(\s+|[.,;:!?]+)/).filter(x=>x&&!/[.,;:!?]+/.test(x));}
function makeCloze(text,ratio=.35){
  const ws=wordsOf(text); if(ws.length<4)return{html:escapeHtml(text),gaps:[]};
  const toHide=Math.max(1,Math.floor(ws.length*ratio));
  const idxs=new Set(ws.map((w,i)=>({i,w})).sort((a,b)=>b.w.length-a.w.length).map(o=>o.i).slice(0,toHide));
  const gaps=[]; const out=ws.map((w,i)=>idxs.has(i)?(gaps.push(w),`<span class="cloze-gap">${' '.repeat(Math.min(12,w.length))}</span>`):escapeHtml(w)).join('');
  return{html:out,gaps};
}
function scanTitleLike(node, keys=['title','name','label','id']){ for(const k of keys){ if(node && typeof node[k]==='string' && node[k].trim()) return node[k].trim(); } return null; }
function flattenAny(node, ctx={act:null,scene:null,song:null}, out=[], meta){
  if(!node||typeof node!=='object')return;
  const t=(node.type||'').toLowerCase();

  if(t==='act' || 'act' in node){ const a=scanTitleLike(node) || node.act || ctx.act; if(a) ctx={...ctx,act:String(a)}; }
  if(t==='scene' || 'scene' in node){ const s=scanTitleLike(node) || node.scene || ctx.scene; if(s) ctx={...ctx,scene:String(s)}; }
  if(t==='song' || 'song' in node){ const s=scanTitleLike(node) || node.song || ctx.song; if(s) ctx={...ctx,song:String(s)}; }

  if(t==='speaker_block' && node.speaker){
    const speaker=node.speaker;
    const content=Array.isArray(node.content)?node.content:[];
    content.forEach(c=>{
      if(!c||!c.type) return;
      const ty=String(c.type).toLowerCase();
      if(ty==='line'||ty==='lyric'){
        const text=(c.text||'').trim(); if(!text) return;
        out.push({type:'dialogue', speaker, text, kind:ty, meta:{...ctx}});
        meta.roles.add(norm(speaker));
        if(ctx.song) meta.songs.add(ctx.song);
      }
    });
  }

  const kids=[]
    .concat(node.segments||[])
    .concat(node.children||[])
    .concat(node.parts||[])
    .concat(node.items||[])
    .concat(Array.isArray(node)?node:[]);
  kids.forEach(child=>flattenAny(child, ctx, out, meta));
}

async function loadJSON(){
  const res=await fetch(jsonSrc,{cache:'no-store'});
  const data=await res.json();

  const out=[]; const meta={roles:new Set(), songs:new Set()};
  if(Array.isArray(data)) flattenAny({segments:data},{},out,meta); else flattenAny(data,{},out,meta);

  state.items=out;
  state.roles=[...meta.roles].filter(Boolean);

  // acts & scenes aus data.acts[]
  state.actsList=[];
  state.scenesByAct={};
  if(data && Array.isArray(data.acts)){
    data.acts.forEach(act=>{
      const aTitle=scanTitleLike(act) || act.title || act.name;
      if(!aTitle) return;
      state.actsList.push(aTitle);
      state.scenesByAct[aTitle]=(Array.isArray(act.scenes)?act.scenes:[]).map(s=>scanTitleLike(s)||s.title||s.name).filter(Boolean);
    });
  }
  state.songsSet = meta.songs;

  populateFilters();
  console.info('[JSON]', jsonSrc, 'Zeilen:', state.items.length);
}

/* ====== Navigation ====== */
function switchViewImmediate(name){
  document.querySelectorAll('[data-view]').forEach(v=>v.classList.toggle('active', v.dataset.view===name));
  document.getElementById('hdr').classList.toggle('compact',name!=='home');
  document.getElementById('subtitle').textContent=name==='home'?'Willkommen':name[0].toUpperCase()+name.slice(1);
  currentView=name;
}
function showView(name){ if(name!==currentView) switchViewImmediate(name); }
document.querySelectorAll('[data-nav]').forEach(b=>b.onclick=()=>showView(b.dataset.nav));

/* ====== Controls ====== */
const actSel   = document.getElementById('actFilter');
const sceneSel = document.getElementById('sceneFilter');
const songSel  = document.getElementById('songFilter');
const lyricsOnly = document.getElementById('lyricsOnly');
const roleSel = document.getElementById('roleSel');

const actSelV   = document.getElementById('actFilterV');
const sceneSelV = document.getElementById('sceneFilterV');
const songSelV  = document.getElementById('songFilterV');
const lyricsOnlyV = document.getElementById('lyricsOnlyV');
const viewerRoleSel = document.getElementById('viewerRoleSel');
const roleSurv=document.getElementById('roleSurv');
const boardRole=document.getElementById('boardRole');
const nameField=document.getElementById('nameField');

/* ====== Populate filters ====== */
function populateFilters(){
  // Rollen
  roleSel.innerHTML=state.roles.map(r=>`<option>${r}</option>`).join('');
  roleSurv.innerHTML=state.roles.map(r=>`<option>${r}</option>`).join('');
  viewerRoleSel.innerHTML=state.roles.map(r=>`<option>${r}</option>`).join('');
  state.viewerHighlightRole = viewerRoleSel.value || '';

  boardRole.innerHTML='<option value="">Alle</option>'+state.roles.map(r=>`<option>${r}</option>`).join('');

  // Akte nur aus acts[]
  const fillActs=(sel)=> sel.innerHTML='<option value="">Alle</option>'+state.actsList.map(a=>`<option>${a}</option>`).join('');
  fillActs(actSel); fillActs(actSelV);

  // Szenen abhängig vom Akt
  const refScene = (act, sel) => {
    const list = act ? (state.scenesByAct[act]||[]) : Object.values(state.scenesByAct).flat();
    sel.innerHTML = '<option value="">Alle</option>' + list.map(s=>`<option>${s}</option>`).join('');
  };
  refScene('', sceneSel); refScene('', sceneSelV);

  // Songs
  const songs=[...state.songsSet];
  songSel.innerHTML='<option value="">Alle</option>'+songs.map(s=>`<option>${s}</option>`).join('');
  songSelV.innerHTML='<option value="">Alle</option>'+songs.map(s=>`<option>${s}</option>`).join('');

  renderLearn(); renderViewer();
}

/* Szenen neu füllen bei Aktwechsel */
actSel.addEventListener('change', ()=>{ const a=actSel.value; const list= a?(state.scenesByAct[a]||[]):Object.values(state.scenesByAct).flat(); sceneSel.innerHTML='<option value="">Alle</option>'+list.map(s=>`<option>${s}</option>`).join(''); renderLearn(); });
actSelV.addEventListener('change', ()=>{ const a=actSelV.value; const list= a?(state.scenesByAct[a]||[]):Object.values(state.scenesByAct).flat(); sceneSelV.innerHTML='<option value="">Alle</option>'+list.map(s=>`<option>${s}</option>`).join(''); renderViewer(); });

/* ====== Filter-Anwendung ====== */
function applyFilters(items,{byRole=true,useViewerFilters=false,roleOverride=null}={}){
  const role = roleOverride || roleSel.value;
  const act = useViewerFilters?actSelV.value:actSel.value;
  const scene = useViewerFilters?sceneSelV.value:sceneSel.value;
  const song = useViewerFilters?songSelV.value:songSel.value;
  const lyrOnly = useViewerFilters?!!lyricsOnlyV.checked:!!lyricsOnly.checked;

  return items.filter(it=>{
    if(byRole){
      const sp=treatSpeaker(it.speaker);
      if(!sp || sp==='__IGNORE__') return false;
      if(sp!=='ALLE' && sp!==norm(role)) return false;
    }
    if(act && (it.meta?.act||'')!==act) return false;
    if(scene && (it.meta?.scene||'')!==scene) return false;
    if(song && (it.meta?.song||'')!==song) return false;
    if(lyrOnly && it.kind!=='lyric') return false;
    return true;
  });
}

/* ====== Kontext ====== */
function getContextForLine(line, fullSeq, myRoleUC){
  const idx = fullSeq.findIndex(x =>
    norm(x.speaker)===norm(line.speaker) &&
    x.text===line.text &&
    (x.meta?.act||'')===(line.meta?.act||'') &&
    (x.meta?.scene||'')===(line.meta?.scene||'') &&
    (x.meta?.song||'')===(line.meta?.song||'')
  );
  if(idx<0) return {prev:null,next:null};
  let prev=null; for(let i=idx-1;i>=0;i--){ if(norm(fullSeq[i].speaker)!==myRoleUC){ prev=fullSeq[i]; break; } }
  let next=null; for(let i=idx+1;i<fullSeq.length;i++){ if(norm(fullSeq[i].speaker)!==myRoleUC){ next=fullSeq[i]; break; } }
  return {prev,next};
}

/* ====== Learn ====== */
const learnRoot=document.getElementById('learnRoot');
const modeSel=document.getElementById('modeSel');
const startLearnBtn=document.getElementById('startLearn');
const pager=document.getElementById('learnPager');
const pagerInfo=document.getElementById('pagerInfo');
const prevPage=document.getElementById('prevPage');
const nextPage=document.getElementById('nextPage');
const learnProg=document.getElementById('learnProg');
const learnCount=document.getElementById('learnCount');

function renderLearn(){
  state.lastFiltered = applyFilters(state.items,{byRole:true});
  state.pageIndex = 0;
  renderLearnPage();
}
function renderLearnPage(){
  const mode=modeSel.value;
  const pageSize = (mode==='classic')?state.pageSizeClassic:state.pageSizeSingle;

  const items=state.lastFiltered;
  const total=items.length;
  if(!items.length){ learnRoot.innerHTML='<div class="card">Keine Zeilen für die aktuelle Auswahl.</div>'; pager.hidden=true; learnCount.textContent=`0/${state.items.length}`; learnProg.style.width='0%'; return; }

  const pages=Math.max(1,Math.ceil(total/pageSize));
  state.pageIndex = Math.min(Math.max(0,state.pageIndex),pages-1);
  const start = state.pageIndex*pageSize;
  const slice = items.slice(start,start+pageSize);

  learnRoot.innerHTML='';
  const myRoleUC = norm(roleSel.value||'');
  const fullSeq = applyFilters(state.items,{byRole:false}); // für Kontext

  if(mode==='classic'){
    slice.forEach(line=>{
      const box=el('div',{class:'exchange'});
      const {prev,next}=getContextForLine(line,fullSeq,myRoleUC);
      if(prev) box.appendChild(el('div',{class:'faded'}, `${prev.speaker}: ${prev.text}`));
      box.appendChild(el('div',{class:'line big'}, `${line.speaker}: ${line.text}`));
      if(next) box.appendChild(el('div',{class:'faded'}, `${next.speaker}: ${next.text}`));
      learnRoot.appendChild(box);
    });
  } else if(mode==='flash'){
    const line = slice[0];
    const {prev,next}=getContextForLine(line,fullSeq,myRoleUC);
    const card=el('div',{class:'card flash'});
    if(prev) card.appendChild(el('div',{class:'faded'}, `${prev.speaker}: ${prev.text}`));
    const secret=el('div',{class:'big', html:`${line.speaker}: <em>(tippen zum Aufdecken)</em>`});
    const reveal=el('div',{class:'big', html:`${line.speaker}: ${escapeHtml(line.text)}`}); reveal.style.display='none';
    card.appendChild(secret); card.appendChild(reveal);
    if(next) card.appendChild(el('div',{class:'faded'}, `${next.speaker}: ${next.text}`));
    card.addEventListener('click', ()=>{ secret.style.display='none'; reveal.style.display=''; }, {once:true});
    learnRoot.appendChild(card);
  } else { // cloze
    const line = slice[0];
    const {prev,next}=getContextForLine(line,fullSeq,myRoleUC);
    const card=el('div',{class:'card cloze'});
    if(prev) card.appendChild(el('div',{class:'faded'}, `${prev.speaker}: ${prev.text}`));
    const {html}=makeCloze(line.text,.35);
    card.appendChild(el('div',{class:'big', html:`${line.speaker}: ${html}`}));
    if(next) card.appendChild(el('div',{class:'faded'}, `${next.speaker}: ${next.text}`));
    learnRoot.appendChild(card);
  }

  pager.hidden = pages<=1;
  pagerInfo.textContent = `Seite ${state.pageIndex+1}/${pages}`;
  prevPage.disabled = state.pageIndex===0; nextPage.disabled = state.pageIndex>=pages-1;

  learnCount.textContent = `${total}/${state.items.length}`;
  learnProg.style.width = `${((state.pageIndex+1)/pages)*100}%`;
}

startLearnBtn.onclick=renderLearn;
[sceneSel,songSel,lyricsOnly,roleSel,modeSel].forEach(e=>e.addEventListener('change',()=>{state.pageIndex=0; renderLearn();}));
prevPage.onclick=()=>{state.pageIndex--; renderLearnPage();};
nextPage.onclick=()=>{state.pageIndex++; renderLearnPage();};

/* ====== Viewer (mit eigener Hervorhebungsrolle) ====== */
const viewerRoot=document.getElementById('viewerRoot');
const viewerPager=document.getElementById('viewerPager');
const viewerPagerInfo=document.getElementById('viewerPagerInfo');
const viewerPrev=document.getElementById('viewerPrev');
const viewerNext=document.getElementById('viewerNext');
const viewerProg=document.getElementById('viewerProg');
const viewerCount=document.getElementById('viewerCount');

function renderViewer(){ state.viewerLast = applyFilters(state.items,{byRole:false,useViewerFilters:true}); state.viewerIndex=0; renderViewerPage(); }
function renderViewerPage(){
  const items=state.viewerLast;
  const total=items.length;
  if(!items.length){ viewerRoot.innerHTML='<div class="card">Keine Zeilen für die aktuelle Auswahl.</div>'; viewerPager.hidden=true; viewerCount.textContent=`0/${state.items.length}`; viewerProg.style.width='0%'; return; }
  const pages=Math.max(1,Math.ceil(items.length/state.viewerPageSize));
  state.viewerIndex=Math.min(Math.max(0,state.viewerIndex),pages-1);
  const start=state.viewerIndex*state.viewerPageSize;
  const slice=items.slice(start,start+state.viewerPageSize);
  viewerRoot.innerHTML='';
  const hlUC = norm(state.viewerHighlightRole||'');
  slice.forEach(line=>{
    const isMe = norm(line.speaker)===hlUC && hlUC!=='';
    viewerRoot.appendChild(el('div',{class:'row'+(isMe?' me':'')}, `${line.speaker}: ${line.text}`));
  });

  viewerPager.hidden = pages<=1;
  viewerPagerInfo.textContent=`Seite ${state.viewerIndex+1}/${pages}`;
  viewerPrev.disabled= state.viewerIndex===0; viewerNext.disabled= state.viewerIndex>=pages-1;

  viewerCount.textContent = `${total}/${state.items.length}`;
  viewerProg.style.width = `${((state.viewerIndex+1)/pages)*100}%`;
}
[actSelV,sceneSelV,songSelV,lyricsOnlyV].forEach(e=>e.addEventListener('change',()=>{state.viewerIndex=0; renderViewer();}));
viewerPrev.onclick=()=>{state.viewerIndex--; renderViewerPage();};
viewerNext.onclick=()=>{state.viewerIndex++; renderViewerPage();};
viewerRoleSel.addEventListener('change',()=>{ state.viewerHighlightRole = viewerRoleSel.value || ''; renderViewerPage(); });

/* ====== Survival ====== */
const survRoot=document.getElementById('survRoot');
let survLives=3,survScore=0;
function renderHearts(){ document.getElementById('heartPill').textContent='❤️'.repeat(Math.max(0,survLives)); }
function renderScore(){ const pill=document.getElementById('scorePill'); pill.textContent=survScore; }
function startSurv(){ const pool=applyFilters(state.items,{byRole:true, roleOverride:roleSurv.value}); if(!pool.length){survRoot.innerHTML='<div class="card">Keine Zeilen für die aktuelle Auswahl.</div>'; return;} survLives=3;survScore=0;renderHearts();renderScore(); nextSurv(pool); }
function nextSurv(pool){
  if(survLives<=0){ gameOver(); return; }
  survRoot.innerHTML='';
  const card=el('div',{class:'card'});
  const line=pool[Math.floor(Math.random()*pool.length)];
  // Kontext (nur davor, kein Spoiler)
  const fullSeq = applyFilters(state.items,{byRole:false});
  const {prev}=getContextForLine(line, fullSeq, norm(roleSurv.value||''));
  if(prev) card.appendChild(el('div',{class:'faded'}, `${prev.speaker}: ${prev.text}`));
  const correct=line.text;
  const wrongs=pool.filter(l=>l!==line).sort(()=>.5-Math.random()).slice(0,2).map(l=>l.text);
  const opts=[correct,...wrongs].sort(()=>.5-Math.random());
  card.appendChild(el('div',{class:'big'},`${line.speaker}: …`));
  const choices=el('div',{class:'choices',style:'display:grid;gap:.6rem;margin-top:.6rem'});
  opts.forEach(opt=>{
    const btn=el('button',{},opt);
    btn.onclick=(ev)=>{ if(opt===correct){survScore++;renderScore();confetti({particleCount:30,spread:60});} else {survLives--;renderHearts(); card.classList.remove('enter'); void card.offsetWidth; card.classList.add('enter');} nextSurv(pool); };
    choices.appendChild(btn);
  });
  survRoot.appendChild(card);
}
function gameOver(){ survRoot.innerHTML=''; survRoot.appendChild(el('div',{class:'card big'},`Game Over! Score: ${survScore}`)); saveScore(survScore); }
document.getElementById('startSurv').onclick=startSurv;

/* ====== Highscores (GUN.js Demo) ====== */
const gun=Gun(['https://gun-manhattan.herokuapp.com/gun']);
const board=gun.get('horrorladen-scores');
function saveScore(score){ const name=(localStorage.getItem(LS.nameKey)||'Anon'); const role=roleSurv.value; board.set({name,role,score,time:Date.now()}); document.getElementById('refreshBoard').click(); }
document.getElementById('refreshBoard').onclick=()=>{ const list=[]; board.map().once(d=>{ if(d) list.push(d); renderBoard(list); }); };
function renderBoard(list){
  const limit=parseInt(document.getElementById('boardLimit').value)||25; const roleFilter=boardRole.value;
  list.sort((a,b)=>b.score-a.score);
  const filtered=list.filter(x=>!roleFilter||x.role===roleFilter).slice(0,limit);
  const div=document.getElementById('board'); div.innerHTML='';
  filtered.forEach(r=>div.appendChild(el('div',{class:'row',style:'display:flex;justify-content:space-between;align-items:center;margin:.3rem 0'}, `${r.name} ${r.role?`(${r.role})`:''}`, el('span',{}, r.score))));
}

/* ====== Settings (Name & Script) ====== */
const playerName=document.getElementById('playerName');
const saveSettings=document.getElementById('saveSettings');
const scriptInput=document.getElementById('scriptInput');
const loadScriptBtn=document.getElementById('loadScriptBtn');

playerName.value = localStorage.getItem(LS.nameKey)||'';
nameField.value = playerName.value;
scriptInput.value = jsonSrc;

saveSettings.onclick=()=>{
  localStorage.setItem(LS.nameKey, playerName.value.trim()||'Anon');
  nameField.value = playerName.value.trim();
};

loadScriptBtn.onclick=()=>{
  const v = (scriptInput.value||'').trim();
  if(!v) return;
  localStorage.setItem(LS.scriptKey, v);
  jsonSrc = v;
  if(document.getElementById('jsonSrcLabel')) document.getElementById('jsonSrcLabel').textContent = jsonSrc;
  // neu laden
  loadJSON();
};

/* ====== Gesten & Mobile Zoom blocken ====== */
let touchStartX=0; addEventListener('touchstart',e=>{touchStartX=e.changedTouches[0].screenX;});
addEventListener('touchend',e=>{ const dx=e.changedTouches[0].screenX-touchStartX; if(dx>80)showView('home'); });
(function(){ ['gesturestart','gesturechange','gestureend'].forEach(evt=>document.addEventListener(evt,e=>e.preventDefault(),{passive:false}));
  document.addEventListener('touchmove',e=>{ if(typeof e.scale==='number' && e.scale!==1) e.preventDefault(); },{passive:false});
  let last=0; document.addEventListener('touchend',e=>{ const now=Date.now(); if(now-last<=300) e.preventDefault(); last=now; },{passive:false}); })();

/* ====== Init ====== */
function boot(){ switchViewImmediate('home'); loadJSON(); }
document.readyState==='loading' ? document.addEventListener('DOMContentLoaded', boot) : boot();
</script>
</body>
</html>
